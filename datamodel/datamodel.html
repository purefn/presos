<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="Rich Wallace" />
  <title>Marketplace Data Model</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <link href="data:text/css;charset=utf-8,%0Abody%0A%7B%0Amargin%3A%200%200%200%200%3B%0Apadding%3A%200%200%200%200%3B%0Awidth%3A%20100%25%3B%0Aheight%3A%20100%25%3B%0Acolor%3A%20black%3B%0Abackground%2Dcolor%3A%20white%3B%0Afont%2Dfamily%3A%20%22Gill%20Sans%20MT%22%2C%20%22Gill%20Sans%22%2C%20GillSans%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014pt%3B%0A%7D%0Adiv%2Etoolbar%20%7B%0Aposition%3A%20fixed%3B%20z%2Dindex%3A%20200%3B%0Atop%3A%20auto%3B%20bottom%3A%200%3B%20left%3A%200%3B%20right%3A%200%3B%0Aheight%3A%201%2E2em%3B%20text%2Dalign%3A%20right%3B%0Apadding%2Dleft%3A%201em%3B%0Apadding%2Dright%3A%201em%3B%20font%2Dsize%3A%2060%25%3B%0Acolor%3A%20red%3B%0Abackground%2Dcolor%3A%20rgb%28240%2C240%2C240%29%3B%0Aborder%2Dtop%3A%20solid%201px%20rgb%28180%2C180%2C180%29%3B%0A%7D%0Adiv%2Etoolbar%20span%2Ecopyright%20%7B%0Acolor%3A%20black%3B%0Amargin%2Dleft%3A%200%2E5em%3B%0A%7D%0Adiv%2Einitial%5Fprompt%20%7B%0Aposition%3A%20absolute%3B%0Az%2Dindex%3A%201000%3B%0Abottom%3A%201%2E2em%3B%0Awidth%3A%20100%25%3B%0Abackground%2Dcolor%3A%20rgb%28200%2C200%2C200%29%3B%0Aopacity%3A%200%2E35%3B%0Abackground%2Dcolor%3A%20rgb%28200%2C200%2C200%2C%200%2E35%29%3B%0Acursor%3A%20pointer%3B%0A%7D%0Adiv%2Einitial%5Fprompt%20p%2Ehelp%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Adiv%2Einitial%5Fprompt%20p%2Eclose%20%7B%0Atext%2Dalign%3A%20right%3B%0Afont%2Dstyle%3A%20italic%3B%0A%7D%0Adiv%2Eslidy%5Ftoc%20%7B%0Aposition%3A%20absolute%3B%0Az%2Dindex%3A%20300%3B%0Awidth%3A%2060%25%3B%0Amax%2Dwidth%3A%2030em%3B%0Aheight%3A%2030em%3B%0Aoverflow%3A%20auto%3B%0Atop%3A%20auto%3B%0Aright%3A%20auto%3B%0Aleft%3A%204em%3B%0Abottom%3A%204em%3B%0Apadding%3A%201em%3B%0Abackground%3A%20rgb%28240%2C240%2C240%29%3B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%2Dwidth%3A%202px%3B%0Afont%2Dsize%3A%2060%25%3B%0A%7D%0Adiv%2Eslidy%5Ftoc%20%2Etoc%5Fheading%20%7B%0Atext%2Dalign%3A%20center%3B%0Awidth%3A%20100%25%3B%0Amargin%3A%200%3B%0Amargin%2Dbottom%3A%201em%3B%0Aborder%2Dbottom%2Dstyle%3A%20solid%3B%0Aborder%2Dbottom%2Dcolor%3A%20rgb%28180%2C180%2C180%29%3B%0Aborder%2Dbottom%2Dwidth%3A%201px%3B%0A%7D%0Adiv%2Eslide%20%7B%0Az%2Dindex%3A%2020%3B%0Amargin%3A%200%200%200%200%3B%0Apadding%2Dtop%3A%200%3B%0Apadding%2Dbottom%3A%200%3B%0Apadding%2Dleft%3A%2020px%3B%0Apadding%2Dright%3A%2020px%3B%0Aborder%2Dwidth%3A%200%3B%0Aclear%3A%20both%3B%0Atop%3A%200%3B%0Abottom%3A%200%3B%0Aleft%3A%200%3B%0Aright%3A%200%3B%0Aline%2Dheight%3A%20120%25%3B%0Abackground%2Dcolor%3A%20transparent%3B%0A%7D%0Adiv%2Ebackground%20%7B%0Adisplay%3A%20none%3B%0A%7D%0Adiv%2Ehandout%20%7B%0Amargin%2Dleft%3A%2020px%3B%0Amargin%2Dright%3A%2020px%3B%0A%7D%0Adiv%2Eslide%2Etitlepage%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Adiv%2Eslide%2Etitlepage%20h1%20%7B%0Apadding%2Dtop%3A%2010%25%3B%0Amargin%2Dright%3A%200%3B%0A%7D%0Adiv%2Eslide%20h1%20%7B%0Apadding%2Dleft%3A%200%3B%0Apadding%2Dright%3A%2020pt%3B%0Apadding%2Dtop%3A%204pt%3B%0Apadding%2Dbottom%3A%204pt%3B%0Amargin%2Dtop%3A%200%3B%0Amargin%2Dleft%3A%200%3B%0Amargin%2Dright%3A%2060pt%3B%0Amargin%2Dbottom%3A%200%2E5em%3B%0Adisplay%3A%20block%3B%20font%2Dsize%3A%20160%25%3B%0Aline%2Dheight%3A%201%2E2em%3B%0Abackground%3A%20transparent%3B%0A%7D%0Adiv%2Etoc%20%7B%0Aposition%3A%20absolute%3B%0Atop%3A%20auto%3B%0Abottom%3A%204em%3B%0Aleft%3A%204em%3B%0Aright%3A%20auto%3B%0Awidth%3A%2060%25%3B%0Amax%2Dwidth%3A%2030em%3B%0Aheight%3A%2030em%3B%0Aborder%3A%20solid%20thin%20black%3B%0Apadding%3A%201em%3B%0Abackground%3A%20rgb%28240%2C240%2C240%29%3B%0Acolor%3A%20black%3B%0Az%2Dindex%3A%20300%3B%0Aoverflow%3A%20auto%3B%0Adisplay%3A%20block%3B%0Avisibility%3A%20visible%3B%0A%7D%0Adiv%2Etoc%2Dheading%20%7B%0Awidth%3A%20100%25%3B%0Aborder%2Dbottom%3A%20solid%201px%20rgb%28180%2C180%2C180%29%3B%0Amargin%2Dbottom%3A%201em%3B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Apre%20%7B%0Afont%2Dsize%3A%2080%25%3B%0Afont%2Dweight%3A%20bold%3B%0Aline%2Dheight%3A%20120%25%3B%0Apadding%2Dtop%3A%200%2E2em%3B%0Apadding%2Dbottom%3A%200%2E2em%3B%0Apadding%2Dleft%3A%201em%3B%0Apadding%2Dright%3A%201em%3B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%2Dleft%2Dwidth%3A%201em%3B%0Aborder%2Dtop%2Dwidth%3A%20thin%3B%0Aborder%2Dright%2Dwidth%3A%20thin%3B%0Aborder%2Dbottom%2Dwidth%3A%20thin%3B%0Aborder%2Dcolor%3A%20%2395ABD0%3B%0Acolor%3A%20%2300428C%3B%0Abackground%2Dcolor%3A%20%23E4E5E7%3B%0A%7D%0Ali%20pre%20%7B%20margin%2Dleft%3A%200%3B%20%7D%0Ablockquote%20%7B%20font%2Dstyle%3A%20italic%20%7D%0Aimg%20%7B%20background%2Dcolor%3A%20transparent%20%7D%0Ap%2Ecopyright%20%7B%20font%2Dsize%3A%20smaller%20%7D%0A%2Ecenter%20%7B%20text%2Dalign%3A%20center%20%7D%0A%2Efootnote%20%7B%20font%2Dsize%3A%20smaller%3B%20margin%2Dleft%3A%202em%3B%20%7D%0Aa%20img%20%7B%20border%2Dwidth%3A%200%3B%20border%2Dstyle%3A%20none%20%7D%0Aa%3Avisited%20%7B%20color%3A%20navy%20%7D%0Aa%3Alink%20%7B%20color%3A%20navy%20%7D%0Aa%3Ahover%20%7B%20color%3A%20red%3B%20text%2Ddecoration%3A%20underline%20%7D%0Aa%3Aactive%20%7B%20color%3A%20red%3B%20text%2Ddecoration%3A%20underline%20%7D%0Aa%20%7Btext%2Ddecoration%3A%20none%7D%0A%2Enavbar%20a%3Alink%20%7Bcolor%3A%20white%7D%0A%2Enavbar%20a%3Avisited%20%7Bcolor%3A%20yellow%7D%0A%2Enavbar%20a%3Aactive%20%7Bcolor%3A%20red%7D%0A%2Enavbar%20a%3Ahover%20%7Bcolor%3A%20red%7D%0Aul%20%7B%20list%2Dstyle%2Dtype%3A%20square%3B%20%7D%0Aul%20ul%20%7B%20list%2Dstyle%2Dtype%3A%20disc%3B%20%7D%0Aul%20ul%20ul%20%7B%20list%2Dstyle%2Dtype%3A%20circle%3B%20%7D%0Aul%20ul%20ul%20ul%20%7B%20list%2Dstyle%2Dtype%3A%20disc%3B%20%7D%0Ali%20%7B%20margin%2Dleft%3A%200%2E5em%3B%20margin%2Dtop%3A%200%2E5em%3B%20%7D%0Ali%20li%20%7B%20font%2Dsize%3A%2085%25%3B%20font%2Dstyle%3A%20italic%20%7D%0Ali%20li%20li%20%7B%20font%2Dsize%3A%2085%25%3B%20font%2Dstyle%3A%20normal%20%7D%0Adiv%20dt%0A%7B%0Amargin%2Dleft%3A%200%3B%0Amargin%2Dtop%3A%201em%3B%0Amargin%2Dbottom%3A%200%2E5em%3B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Adiv%20dd%0A%7B%0Amargin%2Dleft%3A%202em%3B%0Amargin%2Dbottom%3A%200%2E5em%3B%0A%7D%0Ap%2Cpre%2Cul%2Col%2Cblockquote%2Ch2%2Ch3%2Ch4%2Ch5%2Ch6%2Cdl%2Ctable%20%7B%0Amargin%2Dleft%3A%201em%3B%0Amargin%2Dright%3A%201em%3B%0A%7D%0Ap%2Esubhead%20%7B%20font%2Dweight%3A%20bold%3B%20margin%2Dtop%3A%202em%3B%20%7D%0A%2Esmaller%20%7B%20font%2Dsize%3A%20smaller%20%7D%0A%2Ebigger%20%7B%20font%2Dsize%3A%20130%25%20%7D%0Atd%2Cth%20%7B%20padding%3A%200%2E2em%20%7D%0Aul%20%7B%0Amargin%3A%200%2E5em%201%2E5em%200%2E5em%201%2E5em%3B%0Apadding%3A%200%3B%0A%7D%0Aol%20%7B%0Amargin%3A%200%2E5em%201%2E5em%200%2E5em%201%2E5em%3B%0Apadding%3A%200%3B%0A%7D%0Aul%20%7B%20list%2Dstyle%2Dtype%3A%20square%3B%20%7D%0Aul%20ul%20%7B%20list%2Dstyle%2Dtype%3A%20disc%3B%20%7D%0Aul%20ul%20ul%20%7B%20list%2Dstyle%2Dtype%3A%20circle%3B%20%7D%0Aul%20ul%20ul%20ul%20%7B%20list%2Dstyle%2Dtype%3A%20disc%3B%20%7D%0Aul%20li%20%7B%20list%2Dstyle%3A%20square%3B%0Amargin%3A%200%2E1em%200em%200%2E6em%200%3B%0Apadding%3A%200%200%200%200%3B%0Aline%2Dheight%3A%20140%25%3B%0A%7D%0Aol%20li%20%7B%20margin%3A%200%2E1em%200em%200%2E6em%201%2E5em%3B%0Apadding%3A%200%200%200%200px%3B%0Aline%2Dheight%3A%20140%25%3B%0Alist%2Dstyle%2Dtype%3A%20decimal%3B%0A%7D%0Ali%20ul%20li%20%7B%20font%2Dsize%3A%2085%25%3B%20font%2Dstyle%3A%20italic%3B%0Alist%2Dstyle%2Dtype%3A%20disc%3B%0Abackground%3A%20transparent%3B%0Apadding%3A%200%200%200%200%3B%0A%7D%0Ali%20li%20ul%20li%20%7B%20font%2Dsize%3A%2085%25%3B%20font%2Dstyle%3A%20normal%3B%0Alist%2Dstyle%2Dtype%3A%20circle%3B%0Abackground%3A%20transparent%3B%0Apadding%3A%200%200%200%200%3B%0A%7D%0Ali%20li%20li%20ul%20li%20%7B%0Alist%2Dstyle%2Dtype%3A%20disc%3B%0Abackground%3A%20transparent%3B%0Apadding%3A%200%200%200%200%3B%0A%7D%0Ali%20ol%20li%20%7B%0Alist%2Dstyle%2Dtype%3A%20decimal%3B%0A%7D%0Ali%20li%20ol%20li%20%7B%0Alist%2Dstyle%2Dtype%3A%20decimal%3B%0A%7D%0A%0Aol%2Eoutline%20li%3Ahover%20%7B%20cursor%3A%20pointer%20%7D%0Aol%2Eoutline%20li%2Enofold%3Ahover%20%7B%20cursor%3A%20default%20%7D%0Aul%2Eoutline%20li%3Ahover%20%7B%20cursor%3A%20pointer%20%7D%0Aul%2Eoutline%20li%2Enofold%3Ahover%20%7B%20cursor%3A%20default%20%7D%0Aol%2Eoutline%20%7B%20list%2Dstyle%3Adecimal%3B%20%7D%0Aol%2Eoutline%20ol%20%7B%20list%2Dstyle%2Dtype%3Alower%2Dalpha%20%7D%0Aol%2Eoutline%20li%2Enofold%20%7B%0Apadding%3A%200%200%200%2020px%3B%0Abackground%3A%20transparent%20url%28data%3Aimage%2Fgif%3Bbase64%2CR0lGODdhCQAJAIACAMzMzOvr%2FywAAAAACQAJAAACD4SPoRvG614Dctb4MEMcFAA7%29%20no%2Drepeat%200px%200%2E5em%3B%0A%7D%0Aol%2Eoutline%20li%2Eunfolded%20%7B%0Apadding%3A%200%200%200%2020px%3B%0Abackground%3A%20transparent%20url%28data%3Aimage%2Fgif%3Bbase64%2CR0lGODdhCQAJAKEDAMPD%2F8zMzOvr%2F%2F%2F%2F%2FywAAAAACQAJAAACEYyPoivG614LAlg7ZZbxoR8UADs%3D%29%20no%2Drepeat%200px%200%2E5em%3B%0A%7D%0Aol%2Eoutline%20li%2Efolded%20%7B%0Apadding%3A%200%200%200%2020px%3B%0Abackground%3A%20transparent%20url%28data%3Aimage%2Fgif%3Bbase64%2CR0lGODdhCQAJAKEDAMPD%2F8zMzOvr%2F%2F%2F%2F%2FywAAAAACQAJAAACFIyPoiu2sJyCyoF7W3hxz850CFIAADs%3D%29%20no%2Drepeat%200px%200%2E5em%3B%0A%7D%0Aol%2Eoutline%20li%2Eunfolded%3Ahover%20%7B%0Apadding%3A%200%200%200%2020px%3B%0Abackground%3A%20transparent%20url%28data%3Aimage%2Fgif%3Bbase64%2CR0lGODdhCQAJAKEDAAAAAAAA%2F8PD%2F%2F%2F%2F%2FywAAAAACQAJAAACEYSPoivG614DIlg7ZZbxoQ8UADs%3D%29%20no%2Drepeat%200px%200%2E5em%3B%0A%7D%0Aol%2Eoutline%20li%2Efolded%3Ahover%20%7B%0Apadding%3A%200%200%200%2020px%3B%0Abackground%3A%20transparent%20url%28data%3Aimage%2Fgif%3Bbase64%2CR0lGODdhCQAJAKEDAAAAAAAA%2F8PD%2F%2F%2F%2F%2FywAAAAACQAJAAACFISPoiu2sZyCyoV7G3hxz850CFIAADs%3D%29%20no%2Drepeat%200px%200%2E5em%3B%0A%7D%0Aul%2Eoutline%20li%2Enofold%20%7B%0Apadding%3A%200%200%200%2020px%3B%0Abackground%3A%20transparent%20url%28data%3Aimage%2Fgif%3Bbase64%2CR0lGODdhCQAJAIACAMzMzOvr%2FywAAAAACQAJAAACD4SPoRvG614Dctb4MEMcFAA7%29%20no%2Drepeat%200px%200%2E5em%3B%0A%7D%0Aul%2Eoutline%20li%2Eunfolded%20%7B%0Apadding%3A%200%200%200%2020px%3B%0Abackground%3A%20transparent%20url%28data%3Aimage%2Fgif%3Bbase64%2CR0lGODdhCQAJAKEDAMPD%2F8zMzOvr%2F%2F%2F%2F%2FywAAAAACQAJAAACEYyPoivG614LAlg7ZZbxoR8UADs%3D%29%20no%2Drepeat%200px%200%2E5em%3B%0A%7D%0Aul%2Eoutline%20li%2Efolded%20%7B%0Apadding%3A%200%200%200%2020px%3B%0Abackground%3A%20transparent%20url%28data%3Aimage%2Fgif%3Bbase64%2CR0lGODdhCQAJAKEDAMPD%2F8zMzOvr%2F%2F%2F%2F%2FywAAAAACQAJAAACFIyPoiu2sJyCyoF7W3hxz850CFIAADs%3D%29%20no%2Drepeat%200px%200%2E5em%3B%0A%7D%0Aul%2Eoutline%20li%2Eunfolded%3Ahover%20%7B%0Apadding%3A%200%200%200%2020px%3B%0Abackground%3A%20transparent%20url%28data%3Aimage%2Fgif%3Bbase64%2CR0lGODdhCQAJAKEDAAAAAAAA%2F8PD%2F%2F%2F%2F%2FywAAAAACQAJAAACEYSPoivG614DIlg7ZZbxoQ8UADs%3D%29%20no%2Drepeat%200px%200%2E5em%3B%0A%7D%0Aul%2Eoutline%20li%2Efolded%3Ahover%20%7B%0Apadding%3A%200%200%200%2020px%3B%0Abackground%3A%20transparent%20url%28data%3Aimage%2Fgif%3Bbase64%2CR0lGODdhCQAJAKEDAAAAAAAA%2F8PD%2F%2F%2F%2F%2FywAAAAACQAJAAACFISPoiu2sZyCyoV7G3hxz850CFIAADs%3D%29%20no%2Drepeat%200px%200%2E5em%3B%0A%7D%0A%0Aa%2Etitleslide%20%7B%20font%2Dweight%3A%20bold%3B%20font%2Dstyle%3A%20italic%20%7D%0A%0Aimg%2Ehidden%20%7B%20display%3A%20none%3B%20visibility%3A%20hidden%20%7D%0Adiv%2Einitial%5Fprompt%20%7B%20display%3A%20none%3B%20visibility%3A%20hidden%20%7D%0Adiv%2Eslide%20%7B%0Avisibility%3A%20visible%3B%0Aposition%3A%20inherit%3B%0A%7D%0Adiv%2Ehandout%20%7B%0Aborder%2Dtop%2Dstyle%3A%20solid%3B%0Aborder%2Dtop%2Dwidth%3A%20thin%3B%0Aborder%2Dtop%2Dcolor%3A%20black%3B%0A%7D%0A%40media%20screen%20%7B%0A%2Ehidden%20%7B%20display%3A%20none%3B%20visibility%3A%20visible%20%7D%0Adiv%2Eslide%2Ehidden%20%7B%20display%3A%20block%3B%20visibility%3A%20visible%20%7D%0Adiv%2Ehandout%2Ehidden%20%7B%20display%3A%20block%3B%20visibility%3A%20visible%20%7D%0Adiv%2Ebackground%20%7B%20display%3A%20none%3B%20visibility%3A%20hidden%20%7D%0Abody%2Esingle%5Fslide%20div%2Einitial%5Fprompt%20%7B%20display%3A%20block%3B%20visibility%3A%20visible%20%7D%0Abody%2Esingle%5Fslide%20div%2Ebackground%20%7B%20display%3A%20block%3B%20visibility%3A%20visible%20%7D%0Abody%2Esingle%5Fslide%20div%2Ebackground%2Ehidden%20%7B%20display%3A%20none%3B%20visibility%3A%20hidden%20%7D%0Abody%2Esingle%5Fslide%20%2Einvisible%20%7B%20visibility%3A%20hidden%20%7D%0Abody%2Esingle%5Fslide%20%2Ehidden%20%7B%20display%3A%20none%3B%20visibility%3A%20hidden%20%7D%0Abody%2Esingle%5Fslide%20div%2Eslide%20%7B%20position%3A%20absolute%20%7D%0Abody%2Esingle%5Fslide%20div%2Ehandout%20%7B%20display%3A%20none%3B%20visibility%3A%20hidden%20%7D%0A%7D%0A%40media%20print%20%7B%0A%2Ehidden%20%7B%20display%3A%20block%3B%20visibility%3A%20visible%20%7D%0Adiv%2Eslide%20pre%20%7B%20font%2Dsize%3A%2060%25%3B%20padding%2Dleft%3A%200%2E5em%3B%20%7D%0Adiv%2Etoolbar%20%7B%20display%3A%20none%3B%20visibility%3A%20hidden%3B%20%7D%0Adiv%2Eslidy%5Ftoc%20%7B%20display%3A%20none%3B%20visibility%3A%20hidden%3B%20%7D%0Adiv%2Ebackground%20%7B%20display%3A%20none%3B%20visibility%3A%20hidden%3B%20%7D%0Adiv%2Eslide%20%7B%20page%2Dbreak%2Dbefore%3A%20always%20%7D%0A%0Adiv%2Eslide%2Efirst%2Dslide%20%7B%20page%2Dbreak%2Dbefore%3A%20avoid%20%7D%0A%7D%0A" rel="stylesheet" type="text/css" media="screen, projection, print" />
  <script src="data:application/javascript;base64,Lyogc2xpZHkuanMKCiAgIENvcHlyaWdodCAoYykgMjAwNS0yMDEwIFczQyAoTUlULCBFUkNJTSwgS2VpbyksIEFsbCBSaWdodHMgUmVzZXJ2ZWQuCiAgIFczQyBsaWFiaWxpdHksIHRyYWRlbWFyaywgZG9jdW1lbnQgdXNlIGFuZCBzb2Z0d2FyZSBsaWNlbnNpbmcKICAgcnVsZXMgYXBwbHksIHNlZToKCiAgIGh0dHA6Ly93d3cudzMub3JnL0NvbnNvcnRpdW0vTGVnYWwvY29weXJpZ2h0LWRvY3VtZW50cwogICBodHRwOi8vd3d3LnczLm9yZy9Db25zb3J0aXVtL0xlZ2FsL2NvcHlyaWdodC1zb2Z0d2FyZQoKICAgRGVmaW5lcyBzaW5nbGUgbmFtZSAidzNjX3NsaWR5IiBpbiBnbG9iYWwgbmFtZXNwYWNlCiAgIEFkZHMgZXZlbnQgaGFuZGxlcnMgd2l0aG91dCB0cmFtcGxpbmcgb24gYW55IG90aGVycwoqLwoKLy8gdGhlIHNsaWR5IG9iamVjdCBpbXBsZW1lbnRhdGlvbgp2YXIgdzNjX3NsaWR5ID0gewogIC8vIGNsYXNzaWZ5IHdoaWNoIGtpbmQgb2YgYnJvd3NlciB3ZSdyZSBydW5uaW5nIHVuZGVyCiAgbnNfcG9zOiAodHlwZW9mIHdpbmRvdy5wYWdlWU9mZnNldCE9J3VuZGVmaW5lZCcpLAogIGtodG1sOiAoKG5hdmlnYXRvci51c2VyQWdlbnQpLmluZGV4T2YoIktIVE1MIikgPj0gMCA/IHRydWUgOiBmYWxzZSksCiAgb3BlcmE6ICgobmF2aWdhdG9yLnVzZXJBZ2VudCkuaW5kZXhPZigiT3BlcmEiKSA+PSAwID8gdHJ1ZSA6IGZhbHNlKSwKICBpcGFkOiAoKG5hdmlnYXRvci51c2VyQWdlbnQpLmluZGV4T2YoImlQYWQiKSA+PSAwID8gdHJ1ZSA6IGZhbHNlKSwKICBpcGhvbmU6ICgobmF2aWdhdG9yLnVzZXJBZ2VudCkuaW5kZXhPZigiaVBob25lIikgPj0gMCA/IHRydWUgOiBmYWxzZSksCiAgaWU6ICh0eXBlb2YgZG9jdW1lbnQuYWxsICE9ICJ1bmRlZmluZWQiICYmICF0aGlzLm9wZXJhKSwKICBpZTY6ICghdGhpcy5uc19wb3MgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJNU0lFIDYiKSAhPSAtMSksCiAgaWU3OiAoIXRoaXMubnNfcG9zICYmIG5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiTVNJRSA3IikgIT0gLTEpLAogIGllODogKCF0aGlzLm5zX3BvcyAmJiBuYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIk1TSUUgOCIpICE9IC0xKSwKICBpZTk6ICghdGhpcy5uc19wb3MgJiYgbmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJNU0lFIDkiKSAhPSAtMSksCiAga2V5Ym9hcmRsZXNzOiAodGhpcy5pcGFkIHx8IHRoaXMuaXBob25lKSwKCiAgLy8gYXJlIHdlIHJ1bm5pbmcgYXMgWEhUTUw/IChkb2Vzbid0IHdvcmsgb24gT3BlcmEpCiAgaXNfeGh0bWw6IC94bWwvLnRlc3QoZG9jdW1lbnQuY29udGVudFR5cGUpLAoKICBzbGlkZV9udW1iZXI6IDAsIC8vIGludGVnZXIgc2xpZGUgY291bnQ6IDAsIDEsIDIsIC4uLgogIHNsaWRlX251bWJlcl9lbGVtZW50OiBudWxsLCAvLyBlbGVtZW50IGNvbnRhaW5pbmcgc2xpZGUgbnVtYmVyCiAgc2xpZGVzOiBbXSwgLy8gc2V0IHRvIGFycmF5IG9mIHNsaWRlIGRpdidzCiAgbm90ZXM6IFtdLCAvLyBzZXQgdG8gYXJyYXkgb2YgaGFuZG91dCBkaXYncwogIGJhY2tncm91bmRzOiBbXSwgLy8gc2V0IHRvIGFycmF5IG9mIGJhY2tncm91bmQgZGl2J3MKICB0b29sYmFyOiBudWxsLCAvLyBlbGVtZW50IGNvbnRhaW5pbmcgdG9vbGJhcgogIHRpdGxlOiBudWxsLCAvLyBkb2N1bWVudCB0aXRsZQogIGxhc3Rfc2hvd246IG51bGwsIC8vIGxhc3QgaW5jcmVtZW50YWxseSBzaG93biBpdGVtCiAgZW9zOiBudWxsLCAgLy8gc3BhbiBlbGVtZW50IGZvciBlbmQgb2Ygc2xpZGUgaW5kaWNhdG9yCiAgdG9jOiBudWxsLCAvLyB0YWJsZSBvZiBjb250ZW50cwogIG91dGxpbmU6IG51bGwsIC8vIG91dGxpbmUgZWxlbWVudCB3aXRoIHRoZSBmb2N1cwogIHNlbGVjdGVkX3RleHRfbGVuOiAwLCAvLyBsZW5ndGggb2YgZHJhZyBzZWxlY3Rpb24gb24gZG9jdW1lbnQKICB2aWV3X2FsbDogMCwgIC8vIDEgdG8gdmlldyBhbGwgc2xpZGVzICsgaGFuZG91dHMKICB3YW50X3Rvb2xiYXI6IHRydWUsICAvLyB1c2VyIHByZWZlcmVuY2UgdG8gc2hvdy9oaWRlIHRvb2xiYXIKICBtb3VzZV9jbGlja19lbmFibGVkOiB0cnVlLCAvLyBlbmFibGVzIGxlZnQgY2xpY2sgZm9yIG5leHQgc2xpZGUKICBzY3JvbGxfaGFjazogMCwgLy8gSUUgd29yayBhcm91bmQgZm9yIHBvc2l0aW9uOiBmaXhlZAogIGRpc2FibGVfc2xpZGVfY2xpY2s6IGZhbHNlLCAgLy8gdXNlZCBieSBjbGlja2VkIGFuY2hvcnMKCiAgbGFuZzogImVuIiwgLy8gdXBkYXRlZCB0byBsYW5ndWFnZSBzcGVjaWZpZWQgYnkgaHRtbCBmaWxlCgogIGhlbHBfYW5jaG9yOiBudWxsLCAvLyB1c2VkIGZvciBrZXlib2FyZCBmb2N1cyBoYWNrIGluIHNob3dUb29sYmFyKCkKICBoZWxwX3BhZ2U6ICJodHRwOi8vd3d3LnczLm9yZy9UYWxrcy9Ub29scy9TbGlkeTIvaGVscC9oZWxwLmh0bWwiLAogIGhlbHBfdGV4dDogIk5hdmlnYXRlIHdpdGggbW91c2UgY2xpY2ssIHNwYWNlIGJhciwgQ3Vyc29yIExlZnQvUmlnaHQsICIgKwogICAgICAgICAgICAgIm9yIFBnIFVwIGFuZCBQZyBEbi4gVXNlIFMgYW5kIEIgdG8gY2hhbmdlIGZvbnQgc2l6ZS4iLAoKICBzaXplX2luZGV4OiAwLAogIHNpemVfYWRqdXN0bWVudDogMCwKICBzaXplczogIG5ldyBBcnJheSgiMTBwdCIsICIxMnB0IiwgIjE0cHQiLCAiMTZwdCIsICIxOHB0IiwgIjIwcHQiLAogICAgICAgICAgICAgICAgICAgICIyMnB0IiwgIjI0cHQiLCAiMjZwdCIsICIyOHB0IiwgIjMwcHQiLCAiMzJwdCIpLAoKICAvLyBuZWVkZWQgZm9yIGVmZmljaWVudCByZXNpemluZwogIGxhc3Rfd2lkdGg6IDAsCiAgbGFzdF9oZWlnaHQ6IDAsCgoKICAvLyBOZWVkZWQgZm9yIGNyb3NzIGJyb3dzZXIgc3VwcG9ydCBmb3IgcmVsYXRpdmUgd2lkdGgvaGVpZ2h0IG9uCiAgLy8gb2JqZWN0IGVsZW1lbnRzLiBUaGUgd29yayBhcm91bmQgaXMgdG8gc2F2ZSB3aWR0aC9oZWlnaHQgYXR0cmlidXRlcwogIC8vIGFuZCB0aGVuIHRvIHJlY29tcHV0ZSBhYnNvbHV0ZSB3aWR0aC9oZWlnaHQgZGltZW5zaW9ucyBvbiByZXNpemluZwogICBvYmplY3RzOiBbXSwKCiAgLy8gYXR0YWNoIGluaXRpYWxpYXRpb24gZXZlbnQgaGFuZGxlcnMKICBzZXRfdXA6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBpbml0ID0gZnVuY3Rpb24oKSB7IHczY19zbGlkeS5pbml0KCk7IH07CiAgICBpZiAodHlwZW9mIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyICE9ICJ1bmRlZmluZWQiKQogICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigibG9hZCIsIGluaXQsIGZhbHNlKTsKICAgIGVsc2UKICAgICAgd2luZG93LmF0dGFjaEV2ZW50KCJvbmxvYWQiLCBpbml0KTsKICB9LAoKICBoaWRlX3NsaWRlczogZnVuY3Rpb24gKCkgewogICAgaWYgKGRvY3VtZW50LmJvZHkgJiYgIXczY19zbGlkeS5pbml0aWFsaXplZCkKICAgICAgZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gImhpZGRlbiI7CiAgICBlbHNlCiAgICAgIHNldFRpbWVvdXQodzNjX3NsaWR5LmhpZGVfc2xpZGVzLCA1MCk7CiAgfSwKCiAgLy8gaGFjayB0byBwZXJzdWFkZSBJRSB0byBjb21wdXRlIGNvcnJlY3QgZG9jdW1lbnQgaGVpZ2h0CiAgLy8gYXMgbmVlZGVkIGZvciBzaW11bGF0aW5nIGZpeGVkIHBvc2l0aW9uaW5nIG9mIHRvb2xiYXIKICBpZV9oYWNrOiBmdW5jdGlvbiAoKSB7CiAgICB3aW5kb3cucmVzaXplQnkoMCwtMSk7CiAgICB3aW5kb3cucmVzaXplQnkoMCwgMSk7CiAgfSwKCiAgaW5pdDogZnVuY3Rpb24gKCkgewogICAgLy9hbGVydCgic2xpZHkgc3RhcnRpbmcgdGVzdCAxMCIpOwogICAgZG9jdW1lbnQuYm9keS5zdHlsZS52aXNpYmlsaXR5ID0gInZpc2libGUiOwogICAgdGhpcy5pbml0X2xvY2FsaXphdGlvbigpOwogICAgdGhpcy5hZGRfdG9vbGJhcigpOwogICAgdGhpcy53cmFwX2ltcGxpY2l0X3NsaWRlcygpOwogICAgdGhpcy5jb2xsZWN0X3NsaWRlcygpOwogICAgdGhpcy5jb2xsZWN0X25vdGVzKCk7CiAgICB0aGlzLmNvbGxlY3RfYmFja2dyb3VuZHMoKTsKICAgIHRoaXMub2JqZWN0cyA9IGRvY3VtZW50LmJvZHkuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm9iamVjdCIpOwogICAgdGhpcy5wYXRjaF9hbmNob3JzKCk7CiAgICB0aGlzLnNsaWRlX251bWJlciA9IHRoaXMuZmluZF9zbGlkZV9udW1iZXIobG9jYXRpb24uaHJlZik7CiAgICB3aW5kb3cub2Zmc2NyZWVuYnVmZmVyaW5nID0gdHJ1ZTsKICAgIHRoaXMuc2l6ZV9hZGp1c3RtZW50ID0gdGhpcy5maW5kX3NpemVfYWRqdXN0KCk7CiAgICB0aGlzLnRpbWVfbGVmdCA9IHRoaXMuZmluZF9kdXJhdGlvbigpOwogICAgdGhpcy5oaWRlX2ltYWdlX3Rvb2xiYXIoKTsgIC8vIHN1cHByZXNzIElFIGltYWdlIHRvb2xiYXIgcG9wdXAKICAgIHRoaXMuaW5pdF9vdXRsaW5lcigpOyAgLy8gYWN0aXZhdGUgZm9sZC91bmZvbGQgc3VwcG9ydAogICAgdGhpcy50aXRsZSA9IGRvY3VtZW50LnRpdGxlOwoKICAgIC8vIHdvcmsgYXJvdW5kIGZvciBvcGVyYSBidWcKICAgIHRoaXMuaXNfeGh0bWwgPSAoZG9jdW1lbnQuYm9keS50YWdOYW1lID09ICJCT0RZIiA/IGZhbHNlIDogdHJ1ZSk7CgogICAgaWYgKHRoaXMuc2xpZGVzLmxlbmd0aCA+IDApCiAgICB7CiAgICAgIHZhciBzbGlkZSA9IHRoaXMuc2xpZGVzW3RoaXMuc2xpZGVfbnVtYmVyXTsKICAgCiAgICAgIGlmICh0aGlzLnNsaWRlX251bWJlciA+IDApCiAgICAgIHsKICAgICAgICB0aGlzLnNldF92aXNpYmlsaXR5X2FsbF9pbmNyZW1lbnRhbCgidmlzaWJsZSIpOwogICAgICAgIHRoaXMubGFzdF9zaG93biA9IHRoaXMucHJldmlvdXNfaW5jcmVtZW50YWxfaXRlbShudWxsKTsKICAgICAgICB0aGlzLnNldF9lb3Nfc3RhdHVzKHRydWUpOwogICAgICB9CiAgICAgIGVsc2UKICAgICAgewogICAgICAgIHRoaXMubGFzdF9zaG93biA9IG51bGw7CiAgICAgICAgdGhpcy5zZXRfdmlzaWJpbGl0eV9hbGxfaW5jcmVtZW50YWwoImhpZGRlbiIpOwogICAgICAgIHRoaXMuc2V0X2Vvc19zdGF0dXMoIXRoaXMubmV4dF9pbmNyZW1lbnRhbF9pdGVtKHRoaXMubGFzdF9zaG93bikpOwogICAgICB9CgogICAgICB0aGlzLnNldF9sb2NhdGlvbigpOwogICAgICB0aGlzLmFkZF9jbGFzcyh0aGlzLnNsaWRlc1swXSwgImZpcnN0LXNsaWRlIik7CiAgICAgIHczY19zbGlkeS5zaG93X3NsaWRlKHNsaWRlKTsKICAgIH0KCiAgICB0aGlzLnRvYyA9IHRoaXMudGFibGVfb2ZfY29udGVudHMoKTsKCiAgICB0aGlzLmFkZF9pbml0aWFsX3Byb21wdCgpOwoKICAgIC8vIGJpbmQgZXZlbnQgaGFuZGxlcnMgd2l0aG91dCBpbnRlcmZlcmluZyB3aXRoIGN1c3RvbSBwYWdlIHNjcmlwdHMKICAgIC8vIFRhcCBldmVudHMgYmVoYXZlIHRvbyB3ZWlyZGx5IHRvIHN1cHBvcnQgY2xpY2tzIHJlbGlhYmx5IG9uCiAgICAvLyBpUGhvbmUgYW5kIGlQYWQsIHNvIGV4Y2x1ZGUgdGhlc2UgZnJvbSBjbGljayBoYW5kbGVyCgogICAgaWYgKCF0aGlzLmtleWJvYXJkbGVzcykKICAgICAgdGhpcy5hZGRfbGlzdGVuZXIoZG9jdW1lbnQuYm9keSwgImNsaWNrIiwgdGhpcy5tb3VzZV9idXR0b25fY2xpY2spOwoKICAgIHRoaXMuYWRkX2xpc3RlbmVyKGRvY3VtZW50LCAia2V5ZG93biIsIHRoaXMua2V5X2Rvd24pOwogICAgdGhpcy5hZGRfbGlzdGVuZXIoZG9jdW1lbnQsICJrZXlwcmVzcyIsIHRoaXMua2V5X3ByZXNzKTsKICAgIHRoaXMuYWRkX2xpc3RlbmVyKHdpbmRvdywgInJlc2l6ZSIsIHRoaXMucmVzaXplZCk7CiAgICB0aGlzLmFkZF9saXN0ZW5lcih3aW5kb3csICJzY3JvbGwiLCB0aGlzLnNjcm9sbGVkKTsKICAgIHRoaXMuYWRkX2xpc3RlbmVyKHdpbmRvdywgInVubG9hZCIsIHRoaXMudW5sb2FkZWQpOwoKICAgIC8vIHRoaXMgc2VlbXMgdG8gYmUgYSBkZWJ1Z2dpbmcgaGFjawogICAgLy9pZiAoIWRvY3VtZW50LmJvZHkub25jbGljaykKICAgIC8vICBkb2N1bWVudC5ib2R5Lm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7IH07CgogICAgdGhpcy5zaW5nbGVfc2xpZGVfdmlldygpOwoKICAgIC8vdGhpcy5zZXRfbG9jYXRpb24oKTsKCiAgICB0aGlzLnJlc2l6ZWQoKTsKCiAgICBpZiAodGhpcy5pZTcpCiAgICAgIHNldFRpbWVvdXQodzNjX3NsaWR5LmllX2hhY2ssIDEwMCk7CgogICAgdGhpcy5zaG93X3Rvb2xiYXIoKTsKCiAgICAvLyBmb3IgYmFjayBidXR0b24gZGV0ZWN0aW9uCiAgICBzZXRJbnRlcnZhbChmdW5jdGlvbiAoKSB7IHczY19zbGlkeS5jaGVja19sb2NhdGlvbigpOyB9LCAyMDApOwogICAgdzNjX3NsaWR5LmluaXRpYWxpemVkID0gdHJ1ZTsKICB9LAoKICAvLyBjcmVhdGUgZGl2IGVsZW1lbnQgd2l0aCBsaW5rcyB0byBlYWNoIHNsaWRlCiAgdGFibGVfb2ZfY29udGVudHM6IGZ1bmN0aW9uICgpIHsKICAgIHZhciB0b2MgPSB0aGlzLmNyZWF0ZV9lbGVtZW50KCJkaXYiKTsKICAgIHRoaXMuYWRkX2NsYXNzKHRvYywgInNsaWR5X3RvYyBoaWRkZW4iKTsKICAgIC8vdG9jLnNldEF0dHJpYnV0ZSgidGFiaW5kZXgiLCAiMCIpOwoKICAgIHZhciBoZWFkaW5nID0gdGhpcy5jcmVhdGVfZWxlbWVudCgiZGl2Iik7CiAgICB0aGlzLmFkZF9jbGFzcyhoZWFkaW5nLCAidG9jLWhlYWRpbmciKTsKICAgIGhlYWRpbmcuaW5uZXJIVE1MID0gdGhpcy5sb2NhbGl6ZSgiVGFibGUgb2YgQ29udGVudHMiKTsKCiAgICB0b2MuYXBwZW5kQ2hpbGQoaGVhZGluZyk7CiAgICB2YXIgcHJldmlvdXMgPSBudWxsOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5zbGlkZXMubGVuZ3RoOyArK2kpCiAgICB7CiAgICAgIHZhciB0aXRsZSA9IHRoaXMuaGFzX2NsYXNzKHRoaXMuc2xpZGVzW2ldLCAidGl0bGUiKTsKICAgICAgdmFyIG51bSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKChpICsgMSkgKyAiLiAiKTsKCiAgICAgIHRvYy5hcHBlbmRDaGlsZChudW0pOwoKICAgICAgdmFyIGEgPSB0aGlzLmNyZWF0ZV9lbGVtZW50KCJhIik7CiAgICAgIGEuc2V0QXR0cmlidXRlKCJocmVmIiwgIiMoIiArIChpKzEpICsgIikiKTsKCiAgICAgIGlmICh0aXRsZSkKICAgICAgICB0aGlzLmFkZF9jbGFzcyhhLCAidGl0bGVzbGlkZSIpOwoKICAgICAgdmFyIG5hbWUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0aGlzLnNsaWRlX25hbWUoaSkpOwogICAgICBhLmFwcGVuZENoaWxkKG5hbWUpOwogICAgICBhLm9uY2xpY2sgPSB3M2Nfc2xpZHkudG9jX2NsaWNrOwogICAgICBhLm9ua2V5ZG93biA9IHczY19zbGlkeS50b2Nfa2V5X2Rvd247CiAgICAgIGEucHJldmlvdXMgPSBwcmV2aW91czsKCiAgICAgIGlmIChwcmV2aW91cykKICAgICAgICBwcmV2aW91cy5uZXh0ID0gYTsKCiAgICAgIHRvYy5hcHBlbmRDaGlsZChhKTsKCiAgICAgIGlmIChpID09IDApCiAgICAgICAgdG9jLmZpcnN0ID0gYTsKCiAgICAgIGlmIChpIDwgdGhpcy5zbGlkZXMubGVuZ3RoIC0gMSkKICAgICAgewogICAgICAgIHZhciBiciA9IHRoaXMuY3JlYXRlX2VsZW1lbnQoImJyIik7CiAgICAgICAgdG9jLmFwcGVuZENoaWxkKGJyKTsKICAgICAgfQoKICAgICAgcHJldmlvdXMgPSBhOwogICAgfQoKICAgIHRvYy5mb2N1cyA9IGZ1bmN0aW9uICgpIHsKICAgICAgaWYgKHRoaXMuZmlyc3QpCiAgICAgICAgdGhpcy5maXJzdC5mb2N1cygpOwogICAgfQoKICAgIHRvYy5vbm1vdXNldXAgPSB3M2Nfc2xpZHkubW91c2VfYnV0dG9uX3VwOwoKICAgIHRvYy5vbmNsaWNrID0gZnVuY3Rpb24gKGUpIHsKICAgICAgZXx8KGU9d2luZG93LmV2ZW50KTsKCiAgICAgIGlmICh3M2Nfc2xpZHkuc2VsZWN0ZWRfdGV4dF9sZW4gPD0gMCkKICAgICAgICAgdzNjX3NsaWR5LmhpZGVfdGFibGVfb2ZfY29udGVudHModHJ1ZSk7CgogICAgICB3M2Nfc2xpZHkuc3RvcF9wcm9wYWdhdGlvbihlKTsKICAgIAogICAgICBpZiAoZS5jYW5jZWwgIT0gdW5kZWZpbmVkKQogICAgICAgIGUuY2FuY2VsID0gdHJ1ZTsKICAgICAgCiAgICAgIGlmIChlLnJldHVyblZhbHVlICE9IHVuZGVmaW5lZCkKICAgICAgICBlLnJldHVyblZhbHVlID0gZmFsc2U7CiAgICAgIAogICAgICByZXR1cm4gZmFsc2U7CiAgICB9OwoKICAgIGRvY3VtZW50LmJvZHkuaW5zZXJ0QmVmb3JlKHRvYywgZG9jdW1lbnQuYm9keS5maXJzdENoaWxkKTsKICAgIHJldHVybiB0b2M7CiAgfSwKCiAgaXNfc2hvd25fdG9jOiBmdW5jdGlvbiAoKSB7CiAgICByZXR1cm4gIXczY19zbGlkeS5oYXNfY2xhc3ModzNjX3NsaWR5LnRvYywgImhpZGRlbiIpOwogIH0sCgogIHNob3dfdGFibGVfb2ZfY29udGVudHM6IGZ1bmN0aW9uICgpIHsKICAgIHczY19zbGlkeS5yZW1vdmVfY2xhc3ModzNjX3NsaWR5LnRvYywgImhpZGRlbiIpOwogICAgdmFyIHRvYyA9IHczY19zbGlkeS50b2M7CiAgICB0b2MuZm9jdXMoKTsKCiAgICBpZiAodzNjX3NsaWR5LmllNyAmJiB3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyID09IDApCiAgICAgIHNldFRpbWVvdXQodzNjX3NsaWR5LmllX2hhY2ssIDEwMCk7CiAgfSwKCiAgaGlkZV90YWJsZV9vZl9jb250ZW50czogZnVuY3Rpb24gKGZvY3VzKSB7CiAgICB3M2Nfc2xpZHkuYWRkX2NsYXNzKHczY19zbGlkeS50b2MsICJoaWRkZW4iKTsKCiAgICBpZiAoZm9jdXMgJiYgIXczY19zbGlkeS5vcGVyYSkKICAgICAgdzNjX3NsaWR5LmhlbHBfYW5jaG9yLmZvY3VzKCk7CiAgfSwKCiAgdG9nZ2xlX3RhYmxlX29mX2NvbnRlbnRzOiBmdW5jdGlvbiAoKSB7CiAgICBpZiAodzNjX3NsaWR5LmlzX3Nob3duX3RvYygpKQogICAgICB3M2Nfc2xpZHkuaGlkZV90YWJsZV9vZl9jb250ZW50cyh0cnVlKTsKICAgIGVsc2UKICAgICAgdzNjX3NsaWR5LnNob3dfdGFibGVfb2ZfY29udGVudHMoKTsKICB9LAoKICAvLyBjYWxsZWQgb24gY2xpY2tpbmcgdG9jIGVudHJ5CiAgdG9jX2NsaWNrOiBmdW5jdGlvbiAoZSkgewogICAgaWYgKCFlKQogICAgICBlID0gd2luZG93LmV2ZW50OwoKICAgIHZhciB0YXJnZXQgPSB3M2Nfc2xpZHkuZ2V0X3RhcmdldChlKTsKCiAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5ub2RlVHlwZSA9PSAxKQogICAgewogICAgICB2YXIgdXJpID0gdGFyZ2V0LmdldEF0dHJpYnV0ZSgiaHJlZiIpOwoKICAgICAgaWYgKHVyaSkKICAgICAgewogICAgICAgIC8vYWxlcnQoImdvaW5nIHRvICIgKyB1cmkpOwogICAgICAgIHZhciBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CiAgICAgICAgdzNjX3NsaWR5LmhpZGVfc2xpZGUoc2xpZGUpOwogICAgICAgIHczY19zbGlkeS5zbGlkZV9udW1iZXIgPSB3M2Nfc2xpZHkuZmluZF9zbGlkZV9udW1iZXIodXJpKTsKICAgICAgICBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CiAgICAgICAgdzNjX3NsaWR5Lmxhc3Rfc2hvd24gPSBudWxsOwogICAgICAgIHczY19zbGlkeS5zZXRfbG9jYXRpb24oKTsKICAgICAgICB3M2Nfc2xpZHkuc2V0X3Zpc2liaWxpdHlfYWxsX2luY3JlbWVudGFsKCJoaWRkZW4iKTsKICAgICAgICB3M2Nfc2xpZHkuc2V0X2Vvc19zdGF0dXMoIXczY19zbGlkeS5uZXh0X2luY3JlbWVudGFsX2l0ZW0odzNjX3NsaWR5Lmxhc3Rfc2hvd24pKTsKICAgICAgICB3M2Nfc2xpZHkuc2hvd19zbGlkZShzbGlkZSk7CiAgICAgICAgLy90YXJnZXQuZm9jdXMoKTsKCiAgICAgICAgdHJ5CiAgICAgICAgewogICAgICAgICAgaWYgKCF3M2Nfc2xpZHkub3BlcmEpCiAgICAgICAgICAgIHczY19zbGlkeS5oZWxwX2FuY2hvci5mb2N1cygpOwogICAgICAgIH0KICAgICAgICBjYXRjaCAoZSkKICAgICAgICB7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgdzNjX3NsaWR5LmhpZGVfdGFibGVfb2ZfY29udGVudHModHJ1ZSk7CiAgICBpZiAodzNjX3NsaWR5LmllNykgdzNjX3NsaWR5LmllX2hhY2soKTsKICAgIHczY19zbGlkeS5zdG9wX3Byb3BhZ2F0aW9uKGUpOwogICAgcmV0dXJuIHczY19zbGlkeS5jYW5jZWwoZSk7CiAgfSwKCiAgLy8gY2FsbGVkIG9ua2V5ZG93biBmb3IgdG9jIGVudHJ5CiAgdG9jX2tleV9kb3duOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIHZhciBrZXk7CgogICAgaWYgKCFldmVudCkKICAgICAgdmFyIGV2ZW50ID0gd2luZG93LmV2ZW50OwoKICAgIC8vIGtsdWRnZSBhcm91bmQgTlMvSUUgZGlmZmVyZW5jZXMgCiAgICBpZiAod2luZG93LmV2ZW50KQogICAgICBrZXkgPSB3aW5kb3cuZXZlbnQua2V5Q29kZTsKICAgIGVsc2UgaWYgKGV2ZW50LndoaWNoKQogICAgICBrZXkgPSBldmVudC53aGljaDsKICAgIGVsc2UKICAgICAgcmV0dXJuIHRydWU7IC8vIFlpa2VzISB1bmtub3duIGJyb3dzZXIKCiAgICAvLyBpZ25vcmUgZXZlbnQgaWYga2V5IHZhbHVlIGlzIHplcm8KICAgIC8vIGFzIGZvciBhbHQgb24gT3BlcmEgYW5kIEtvbnF1ZXJvcgogICAgaWYgKCFrZXkpCiAgICAgIHJldHVybiB0cnVlOwoKICAgIC8vIGNoZWNrIGZvciBjb25jdXJyZW50IGNvbnRyb2wvY29tbWFuZC9hbHQga2V5CiAgICAvLyBidXQgYXJlIHRoZXNlIG9ubHkgcHJlc2VudCBvbiBtb3VzZSBldmVudHM/CgogICAgaWYgKGV2ZW50LmN0cmxLZXkgfHwgZXZlbnQuYWx0S2V5KQogICAgICByZXR1cm4gdHJ1ZTsKCiAgICBpZiAoa2V5ID09IDEzKQogICAgewogICAgICB2YXIgdXJpID0gdGhpcy5nZXRBdHRyaWJ1dGUoImhyZWYiKTsKCiAgICAgIGlmICh1cmkpCiAgICAgIHsKICAgICAgICAvL2FsZXJ0KCJnb2luZyB0byAiICsgdXJpKTsKICAgICAgIHZhciBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CiAgICAgICAgdzNjX3NsaWR5LmhpZGVfc2xpZGUoc2xpZGUpOwogICAgICAgIHczY19zbGlkeS5zbGlkZV9udW1iZXIgPSB3M2Nfc2xpZHkuZmluZF9zbGlkZV9udW1iZXIodXJpKTsKICAgICAgICBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CiAgICAgICAgdzNjX3NsaWR5Lmxhc3Rfc2hvd24gPSBudWxsOwogICAgICAgIHczY19zbGlkeS5zZXRfbG9jYXRpb24oKTsKICAgICAgICB3M2Nfc2xpZHkuc2V0X3Zpc2liaWxpdHlfYWxsX2luY3JlbWVudGFsKCJoaWRkZW4iKTsKICAgICAgICB3M2Nfc2xpZHkuc2V0X2Vvc19zdGF0dXMoIXczY19zbGlkeS5uZXh0X2luY3JlbWVudGFsX2l0ZW0odzNjX3NsaWR5Lmxhc3Rfc2hvd24pKTsKICAgICAgICB3M2Nfc2xpZHkuc2hvd19zbGlkZShzbGlkZSk7CiAgICAgICAgLy90YXJnZXQuZm9jdXMoKTsKCiAgICAgICAgdHJ5CiAgICAgICAgewogICAgICAgICAgaWYgKCF3M2Nfc2xpZHkub3BlcmEpCiAgICAgICAgICAgIHczY19zbGlkeS5oZWxwX2FuY2hvci5mb2N1cygpOwogICAgICAgIH0KICAgICAgICBjYXRjaCAoZSkKICAgICAgICB7CiAgICAgICAgfQogICAgICB9CgogICAgICB3M2Nfc2xpZHkuaGlkZV90YWJsZV9vZl9jb250ZW50cyh0cnVlKTsKCiAgICAgIGlmIChzZWxmLmllNykKICAgICAgIHczY19zbGlkeS5pZV9oYWNrKCk7CgogICAgICByZXR1cm4gdzNjX3NsaWR5LmNhbmNlbChldmVudCk7CiAgICB9CgogICAgaWYgKGtleSA9PSA0MCAmJiB0aGlzLm5leHQpCiAgICB7CiAgICAgIHRoaXMubmV4dC5mb2N1cygpOwogICAgICByZXR1cm4gdzNjX3NsaWR5LmNhbmNlbChldmVudCk7CiAgICB9CgogICAgaWYgKGtleSA9PSAzOCAmJiB0aGlzLnByZXZpb3VzKQogICAgewogICAgICB0aGlzLnByZXZpb3VzLmZvY3VzKCk7CiAgICAgIHJldHVybiB3M2Nfc2xpZHkuY2FuY2VsKGV2ZW50KTsKICAgIH0KCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKCiAgLy8gIyMjIE9CU09MRVRFICMjIwogIGJlZm9yZV9wcmludDogZnVuY3Rpb24gKCkgewogICAgdGhpcy5zaG93X2FsbF9zbGlkZXMoKTsKICAgIHRoaXMuaGlkZV90b29sYmFyKCk7CiAgICBhbGVydCgiYmVmb3JlIHByaW50Iik7CiAgfSwKCiAgLy8gIyMjIE9CU09MRVRFICMjIwogIGFmdGVyX3ByaW50OiBmdW5jdGlvbiAoKSB7CiAgICBpZiAoIXRoaXMudmlld19hbGwpCiAgICB7CiAgICAgIHRoaXMuc2luZ2xlX3NsaWRlX3ZpZXcoKTsKICAgICAgdGhpcy5zaG93X3Rvb2xiYXIoKTsKICAgIH0KICAgIGFsZXJ0KCJhZnRlciBwcmludCIpOwogIH0sCgogIC8vICMjIyBPQlNPTEVURSAjIyMKICBwcmludF9zbGlkZXM6IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuYmVmb3JlX3ByaW50KCk7CiAgICB3aW5kb3cucHJpbnQoKTsKICAgIHRoaXMuYWZ0ZXJfcHJpbnQoKTsKICB9LAoKICAvLyAjIyMgT0JTT0xFVEUgPz8gIyMjCiAgdG9nZ2xlX3ZpZXc6IGZ1bmN0aW9uICgpIHsKICAgIGlmICh0aGlzLnZpZXdfYWxsKQogICAgewogICAgICB0aGlzLnNpbmdsZV9zbGlkZV92aWV3KCk7CiAgICAgIHRoaXMuc2hvd190b29sYmFyKCk7CiAgICAgIHRoaXMudmlld19hbGwgPSAwOwogICAgfQogICAgZWxzZQogICAgewogICAgICB0aGlzLnNob3dfYWxsX3NsaWRlcygpOwogICAgICB0aGlzLmhpZGVfdG9vbGJhcigpOwogICAgICB0aGlzLnZpZXdfYWxsID0gMTsKICAgIH0KICB9LAoKICAvLyBwcmVwYXJlIGZvciBwcmludGluZyAgIyMjIE9CU09MRVRFICMjIwogIHNob3dfYWxsX3NsaWRlczogZnVuY3Rpb24gKCkgewogICAgdGhpcy5yZW1vdmVfY2xhc3MoZG9jdW1lbnQuYm9keSwgInNpbmdsZV9zbGlkZSIpOwogICAgdGhpcy5zZXRfdmlzaWJpbGl0eV9hbGxfaW5jcmVtZW50YWwoInZpc2libGUiKTsKICB9LAoKICAvLyByZXN0b3JlIGFmdGVyIHByaW50aW5nICAjIyMgT0JTT0xFVEUgIyMjCiAgc2luZ2xlX3NsaWRlX3ZpZXc6IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMuYWRkX2NsYXNzKGRvY3VtZW50LmJvZHksICJzaW5nbGVfc2xpZGUiKTsKICAgIHRoaXMuc2V0X3Zpc2liaWxpdHlfYWxsX2luY3JlbWVudGFsKCJ2aXNpYmxlIik7CiAgICB0aGlzLmxhc3Rfc2hvd24gPSB0aGlzLnByZXZpb3VzX2luY3JlbWVudGFsX2l0ZW0obnVsbCk7CiAgfSwKCiAgLy8gc3VwcHJlc3MgSUUncyBpbWFnZSB0b29sYmFyIHBvcCB1cAogIGhpZGVfaW1hZ2VfdG9vbGJhcjogZnVuY3Rpb24gKCkgewogICAgaWYgKCF0aGlzLm5zX3BvcykKICAgIHsKICAgICAgdmFyIGltYWdlcyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJJTUciKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgaW1hZ2VzLmxlbmd0aDsgKytpKQogICAgICAgIGltYWdlc1tpXS5zZXRBdHRyaWJ1dGUoImdhbGxlcnlpbWciLCAibm8iKTsKICAgIH0KICB9LAoKICB1bmxvYWRlZDogZnVuY3Rpb24gKGUpIHsKICAgIC8vYWxlcnQoInVubG9hZGVkIik7CiAgfSwKCiAgLy8gU2FmYXJpIGFuZCBLb25xdWVyb3IgZG9uJ3QgeWV0IHN1cHBvcnQgZ2V0Q29tcHV0ZWRTdHlsZSgpCiAgLy8gYW5kIHRoZXkgYWx3YXlzIHJlbG9hZCBwYWdlIHdoZW4gbG9jYXRpb24uaHJlZiBpcyB1cGRhdGVkCiAgaXNfS0hUTUw6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBhZ2VudCA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CiAgICByZXR1cm4gKGFnZW50LmluZGV4T2YoIktIVE1MIikgPj0gMCA/IHRydWUgOiBmYWxzZSk7CiAgfSwKCiAgLy8gZmluZCBzbGlkZSBuYW1lIGZyb20gZmlyc3QgaDEgZWxlbWVudAogIC8vIGRlZmF1bHQgdG8gZG9jdW1lbnQgdGl0bGUgKyBzbGlkZSBudW1iZXIKICBzbGlkZV9uYW1lOiBmdW5jdGlvbiAoaW5kZXgpIHsKICAgIHZhciBuYW1lID0gbnVsbDsKICAgIHZhciBzbGlkZSA9IHRoaXMuc2xpZGVzW2luZGV4XTsKCiAgICB2YXIgaGVhZGluZyA9IHRoaXMuZmluZF9oZWFkaW5nKHNsaWRlKTsKCiAgICBpZiAoaGVhZGluZykKICAgICAgbmFtZSA9IHRoaXMuZXh0cmFjdF90ZXh0KGhlYWRpbmcpOwoKICAgIGlmICghbmFtZSkKICAgICAgbmFtZSA9IHRoaXMudGl0bGUgKyAiKCIgKyAoaW5kZXggKyAxKSArICIpIjsKCiAgICBuYW1lLnJlcGxhY2UoL1wmL2csICImYW1wOyIpOwogICAgbmFtZS5yZXBsYWNlKC9cPC9nLCAiJmx0OyIpOwogICAgbmFtZS5yZXBsYWNlKC9cPi9nLCAiJmd0OyIpOwoKICAgIHJldHVybiBuYW1lOwogIH0sCgogIC8vIGZpbmQgZmlyc3QgaDEgZWxlbWVudCBpbiBET00gdHJlZQogIGZpbmRfaGVhZGluZzogZnVuY3Rpb24gKG5vZGUpIHsKICAgIGlmICghbm9kZSB8fCBub2RlLm5vZGVUeXBlICE9IDEpCiAgICAgIHJldHVybiBudWxsOwoKICAgIGlmIChub2RlLm5vZGVOYW1lID09ICJIMSIgfHwgbm9kZS5ub2RlTmFtZSA9PSAiaDEiKQogICAgICByZXR1cm4gbm9kZTsKCiAgICB2YXIgY2hpbGQgPSBub2RlLmZpcnN0Q2hpbGQ7CgogICAgd2hpbGUgKGNoaWxkKQogICAgewogICAgICBub2RlID0gdGhpcy5maW5kX2hlYWRpbmcoY2hpbGQpOwoKICAgICAgaWYgKG5vZGUpCiAgICAgICAgcmV0dXJuIG5vZGU7CgogICAgICBjaGlsZCA9IGNoaWxkLm5leHRTaWJsaW5nOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH0sCgogIC8vIHJlY3Vyc2l2ZWx5IGV4dHJhY3QgdGV4dCBmcm9tIERPTSB0cmVlCiAgZXh0cmFjdF90ZXh0OiBmdW5jdGlvbiAobm9kZSkgewogICAgaWYgKCFub2RlKQogICAgICByZXR1cm4gIiI7CgogICAgLy8gdGV4dCBub2RlcwogICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMykKICAgICAgcmV0dXJuIG5vZGUubm9kZVZhbHVlOwoKICAgIC8vIGVsZW1lbnRzCiAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKQogICAgewogICAgICBub2RlID0gbm9kZS5maXJzdENoaWxkOwogICAgICB2YXIgdGV4dCA9ICIiOwoKICAgICAgd2hpbGUgKG5vZGUpCiAgICAgIHsKICAgICAgICB0ZXh0ID0gdGV4dCArIHRoaXMuZXh0cmFjdF90ZXh0KG5vZGUpOwogICAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICB9CgogICAgICByZXR1cm4gdGV4dDsKICAgIH0KCiAgICByZXR1cm4gIiI7CiAgfSwKCiAgLy8gZmluZCBjb3B5cmlnaHQgdGV4dCBmcm9tIG1ldGEgZWxlbWVudAogIGZpbmRfY29weXJpZ2h0OiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgbmFtZSwgY29udGVudDsKICAgIHZhciBtZXRhID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoIm1ldGEiKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IG1ldGEubGVuZ3RoOyArK2kpCiAgICB7CiAgICAgIG5hbWUgPSBtZXRhW2ldLmdldEF0dHJpYnV0ZSgibmFtZSIpOwogICAgICBjb250ZW50ID0gbWV0YVtpXS5nZXRBdHRyaWJ1dGUoImNvbnRlbnQiKTsKCiAgICAgIGlmIChuYW1lID09ICJjb3B5cmlnaHQiKQogICAgICAgIHJldHVybiBjb250ZW50OwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH0sCgogIGZpbmRfc2l6ZV9hZGp1c3Q6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBuYW1lLCBjb250ZW50LCBvZmZzZXQ7CiAgICB2YXIgbWV0YSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJtZXRhIik7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZXRhLmxlbmd0aDsgKytpKQogICAgewogICAgICBuYW1lID0gbWV0YVtpXS5nZXRBdHRyaWJ1dGUoIm5hbWUiKTsKICAgICAgY29udGVudCA9IG1ldGFbaV0uZ2V0QXR0cmlidXRlKCJjb250ZW50Iik7CgogICAgICBpZiAobmFtZSA9PSAiZm9udC1zaXplLWFkanVzdG1lbnQiKQogICAgICAgIHJldHVybiAxICogY29udGVudDsKICAgIH0KCiAgICByZXR1cm4gMTsKICB9LAoKICAvLyA8bWV0YSBuYW1lPSJkdXJhdGlvbiIgY29udGVudD0iMjAiIC8+ICBmb3IgMjAgbWludXRlcwogIGZpbmRfZHVyYXRpb246IGZ1bmN0aW9uICgpIHsKICAgIHZhciBuYW1lLCBjb250ZW50LCBvZmZzZXQ7CiAgICB2YXIgbWV0YSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJtZXRhIik7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBtZXRhLmxlbmd0aDsgKytpKQogICAgewogICAgICBuYW1lID0gbWV0YVtpXS5nZXRBdHRyaWJ1dGUoIm5hbWUiKTsKICAgICAgY29udGVudCA9IG1ldGFbaV0uZ2V0QXR0cmlidXRlKCJjb250ZW50Iik7CgogICAgICBpZiAobmFtZSA9PSAiZHVyYXRpb24iKQogICAgICAgIHJldHVybiA2MDAwMCAqIGNvbnRlbnQ7CiAgICB9CgogICAgcmV0dXJuIG51bGw7CiAgfSwKCiAgcmVwbGFjZV9ieV9ub25fYnJlYWtpbmdfc3BhY2U6IGZ1bmN0aW9uIChzdHIpIHsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc3RyLmxlbmd0aDsgKytpKQogICAgICBzdHJbaV0gPSAxNjA7CiAgfSwKCiAgLy8gIyMjIENIRUNLIE1FICMjIyBpcyB1c2Ugb2YgImxpIiBva2F5IGZvciB0ZXh0L2h0bWw/CiAgLy8gZm9yIFhIVE1MIGRvIHdlIGFsc28gbmVlZCB0byBzcGVjaWZ5IG5hbWVzcGFjZT8KICBpbml0X291dGxpbmVyOiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgaXRlbXMgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgibGkiKTsKCiAgICBmb3IgKHZhciBpID0gMDsgaSA8IGl0ZW1zLmxlbmd0aDsgKytpKQogICAgewogICAgICB2YXIgdGFyZ2V0ID0gaXRlbXNbaV07CgogICAgICBpZiAoIXRoaXMuaGFzX2NsYXNzKHRhcmdldC5wYXJlbnROb2RlLCAib3V0bGluZSIpKQogICAgICAgIGNvbnRpbnVlOwoKICAgICAgdGFyZ2V0Lm9uY2xpY2sgPSB0aGlzLm91dGxpbmVfY2xpY2s7Ci8qICMjIyBtb3JlIHdvcmsgbmVlZGVkIGZvciBJRTYKICAgICAgaWYgKCF0aGlzLm5zX3BvcykKICAgICAgewogICAgICAgIHRhcmdldC5vbm1vdXNlb3ZlciA9IHRoaXMuaG92ZXJfb3V0bGluZTsKICAgICAgICB0YXJnZXQub25tb3VzZW91dCA9IHRoaXMudW5ob3Zlcl9vdXRsaW5lOwogICAgICB9CiovCiAgICAgIGlmICh0aGlzLmZvbGRhYmxlKHRhcmdldCkpCiAgICAgIHsKICAgICAgICB0YXJnZXQuZm9sZGFibGUgPSB0cnVlOwogICAgICAgIHRhcmdldC5vbmZvY3VzID0gZnVuY3Rpb24gKCkge3czY19zbGlkeS5vdXRsaW5lID0gdGhpczt9OwogICAgICAgIHRhcmdldC5vbmJsdXIgPSBmdW5jdGlvbiAoKSB7dzNjX3NsaWR5Lm91dGxpbmUgPSBudWxsO307CgogICAgICAgIGlmICghdGFyZ2V0LmdldEF0dHJpYnV0ZSgidGFiaW5kZXgiKSkKICAgICAgICAgIHRhcmdldC5zZXRBdHRyaWJ1dGUoInRhYmluZGV4IiwgIjAiKTsKCiAgICAgICAgaWYgKHRoaXMuaGFzX2NsYXNzKHRhcmdldCwgImV4cGFuZCIpKQogICAgICAgICAgdGhpcy51bmZvbGQodGFyZ2V0KTsKICAgICAgICBlbHNlCiAgICAgICAgICB0aGlzLmZvbGQodGFyZ2V0KTsKICAgICAgfQogICAgICBlbHNlCiAgICAgIHsKICAgICAgICB0aGlzLmFkZF9jbGFzcyh0YXJnZXQsICJub2ZvbGQiKTsKICAgICAgICB0YXJnZXQudmlzaWJsZSA9IHRydWU7CiAgICAgICAgdGFyZ2V0LmZvbGRhYmxlID0gZmFsc2U7CiAgICAgIH0KICAgIH0KICB9LAoKICBmb2xkYWJsZTogZnVuY3Rpb24gKGl0ZW0pIHsKICAgIGlmICghaXRlbSB8fCBpdGVtLm5vZGVUeXBlICE9IDEpCiAgICAgIHJldHVybiBmYWxzZTsKCiAgICB2YXIgbm9kZSA9IGl0ZW0uZmlyc3RDaGlsZDsKCiAgICB3aGlsZSAobm9kZSkKICAgIHsKICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSAmJiB0aGlzLmlzX2Jsb2NrKG5vZGUpKQogICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgbm9kZSA9IG5vZGUubmV4dFNpYmxpbmc7CiAgICB9CgogICAgcmV0dXJuIGZhbHNlOwogIH0sCgogIC8vICMjIyBDSEVDSyBNRSAjIyMgc3dpdGNoIHRvIGFkZC9yZW1vdmUgImhpZGRlbiIgY2xhc3MKICBmb2xkOiBmdW5jdGlvbiAoaXRlbSkgewogICAgaWYgKGl0ZW0pCiAgICB7CiAgICAgIHRoaXMucmVtb3ZlX2NsYXNzKGl0ZW0sICJ1bmZvbGRlZCIpOwogICAgICB0aGlzLmFkZF9jbGFzcyhpdGVtLCAiZm9sZGVkIik7CiAgICB9CgogICAgdmFyIG5vZGUgPSBpdGVtID8gaXRlbS5maXJzdENoaWxkIDogbnVsbDsKCiAgICB3aGlsZSAobm9kZSkKICAgIHsKICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSAmJiB0aGlzLmlzX2Jsb2NrKG5vZGUpKSAvLyBlbGVtZW50CiAgICAgIHsKICAgICAgICAgdzNjX3NsaWR5LmFkZF9jbGFzcyhub2RlLCAiaGlkZGVuIik7CiAgICAgIH0KCiAgICAgIG5vZGUgPSBub2RlLm5leHRTaWJsaW5nOwogICAgfQoKICAgIGl0ZW0udmlzaWJsZSA9IGZhbHNlOwogIH0sCgogIC8vICMjIyBDSEVDSyBNRSAjIyMgc3dpdGNoIHRvIGFkZC9yZW1vdmUgImhpZGRlbiIgY2xhc3MKICB1bmZvbGQ6IGZ1bmN0aW9uIChpdGVtKSB7CiAgICBpZiAoaXRlbSkKICAgIHsKICAgICAgdGhpcy5hZGRfY2xhc3MoaXRlbSwgInVuZm9sZGVkIik7CiAgICAgIHRoaXMucmVtb3ZlX2NsYXNzKGl0ZW0sICJmb2xkZWQiKTsKICAgIH0KCiAgICB2YXIgbm9kZSA9IGl0ZW0gPyBpdGVtLmZpcnN0Q2hpbGQgOiBudWxsOwoKICAgIHdoaWxlIChub2RlKQogICAgewogICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAxICYmIHRoaXMuaXNfYmxvY2sobm9kZSkpIC8vIGVsZW1lbnQKICAgICAgewogICAgICAgIHczY19zbGlkeS5yZW1vdmVfY2xhc3Mobm9kZSwgImhpZGRlbiIpOwogICAgICB9CgogICAgICBub2RlID0gbm9kZS5uZXh0U2libGluZzsKICAgIH0KCiAgICBpdGVtLnZpc2libGUgPSB0cnVlOwogIH0sCgogIG91dGxpbmVfY2xpY2s6IGZ1bmN0aW9uIChlKSB7CiAgICBpZiAoIWUpCiAgICAgIGUgPSB3aW5kb3cuZXZlbnQ7CgogICAgdmFyIHJpZ2h0Y2xpY2sgPSBmYWxzZTsKICAgIHZhciB0YXJnZXQgPSB3M2Nfc2xpZHkuZ2V0X3RhcmdldChlKTsKCiAgICB3aGlsZSAodGFyZ2V0ICYmIHRhcmdldC52aXNpYmxlID09IHVuZGVmaW5lZCkKICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgogICAgaWYgKCF0YXJnZXQpCiAgICAgIHJldHVybiB0cnVlOwoKICAgIGlmIChlLndoaWNoKQogICAgICByaWdodGNsaWNrID0gKGUud2hpY2ggPT0gMyk7CiAgICBlbHNlIGlmIChlLmJ1dHRvbikKICAgICAgcmlnaHRjbGljayA9IChlLmJ1dHRvbiA9PSAyKTsKCiAgICBpZiAoIXJpZ2h0Y2xpY2sgJiYgdGFyZ2V0LnZpc2libGUgIT0gdW5kZWZpbmVkKQogICAgewogICAgICBpZiAodGFyZ2V0LmZvbGRhYmxlKQogICAgICB7CiAgICAgICAgaWYgKHRhcmdldC52aXNpYmxlKQogICAgICAgICAgdzNjX3NsaWR5LmZvbGQodGFyZ2V0KTsKICAgICAgICBlbHNlCiAgICAgICAgICB3M2Nfc2xpZHkudW5mb2xkKHRhcmdldCk7CiAgICAgIH0KCiAgICAgIHczY19zbGlkeS5zdG9wX3Byb3BhZ2F0aW9uKGUpOwogICAgICBlLmNhbmNlbCA9IHRydWU7CiAgICAgIGUucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgYWRkX2luaXRpYWxfcHJvbXB0OiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgcHJvbXB0ID0gdGhpcy5jcmVhdGVfZWxlbWVudCgiZGl2Iik7CiAgICBwcm9tcHQuc2V0QXR0cmlidXRlKCJjbGFzcyIsICJpbml0aWFsX3Byb21wdCIpOwoKICAgIHZhciBwMSA9IHRoaXMuY3JlYXRlX2VsZW1lbnQoInAiKTsKICAgIHByb21wdC5hcHBlbmRDaGlsZChwMSk7CiAgICBwMS5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgImhlbHAiKTsKCiAgICBpZiAodGhpcy5rZXlib2FyZGxlc3MpCiAgICAgIHAxLmlubmVySFRNTCA9ICJUYXAgZm9vdGVyIHRvIG1vdmUgdG8gbmV4dCBzbGlkZSI7CiAgICBlbHNlCiAgICAgIHAxLmlubmVySFRNTCA9ICJTcGFjZSBvciBSaWdodCBBcnJvdyB0byBtb3ZlIHRvIG5leHQgIiArCiAgICAgICAgICAgICAgICAgICAgICJzbGlkZSwgY2xpY2sgaGVscCBiZWxvdyBmb3IgbW9yZSBkZXRhaWxzIjsKCiAgICB0aGlzLmFkZF9saXN0ZW5lcihwcm9tcHQsICJjbGljayIsIGZ1bmN0aW9uIChlKSB7CiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQocHJvbXB0KTsKICAgICAgdzNjX3NsaWR5LnN0b3BfcHJvcGFnYXRpb24oZSk7CiAgICAKICAgICAgaWYgKGUuY2FuY2VsICE9IHVuZGVmaW5lZCkKICAgICAgICBlLmNhbmNlbCA9IHRydWU7CiAgICAgIAogICAgICBpZiAoZS5yZXR1cm5WYWx1ZSAhPSB1bmRlZmluZWQpCiAgICAgICAgZS5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICAKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfSk7CgogICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChwcm9tcHQpOwogICAgdGhpcy5pbml0aWFsX3Byb21wdCA9IHByb21wdDsKICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7ZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChwcm9tcHQpO30sIDUwMDApOwogIH0sCgogIGFkZF90b29sYmFyOiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgY291bnRlciwgcGFnZTsKCiAgICAgdGhpcy50b29sYmFyID0gdGhpcy5jcmVhdGVfZWxlbWVudCgiZGl2Iik7CiAgICAgdGhpcy50b29sYmFyLnNldEF0dHJpYnV0ZSgiY2xhc3MiLCAidG9vbGJhciIpOwoKICAgICAvLyBhIHJlYXNvbmFibHkgYmVoYXZlZCBicm93c2VyCiAgICAgaWYgKHRoaXMubnNfcG9zIHx8ICF0aGlzLmllNikKICAgICB7CiAgICAgICB2YXIgcmlnaHQgPSB0aGlzLmNyZWF0ZV9lbGVtZW50KCJkaXYiKTsKICAgICAgIHJpZ2h0LnNldEF0dHJpYnV0ZSgic3R5bGUiLCAiZmxvYXQ6IHJpZ2h0OyB0ZXh0LWFsaWduOiByaWdodCIpOwoKICAgICAgIGNvdW50ZXIgPSB0aGlzLmNyZWF0ZV9lbGVtZW50KCJzcGFuIikKICAgICAgIGNvdW50ZXIuaW5uZXJIVE1MID0gdGhpcy5sb2NhbGl6ZSgic2xpZGUiKSArICIgbi9tIjsKICAgICAgIHJpZ2h0LmFwcGVuZENoaWxkKGNvdW50ZXIpOwogICAgICAgdGhpcy50b29sYmFyLmFwcGVuZENoaWxkKHJpZ2h0KTsKCiAgICAgICB2YXIgbGVmdCA9IHRoaXMuY3JlYXRlX2VsZW1lbnQoImRpdiIpOwogICAgICAgbGVmdC5zZXRBdHRyaWJ1dGUoInN0eWxlIiwgInRleHQtYWxpZ246IGxlZnQiKTsKCiAgICAgICAvLyBnbG9iYWwgZW5kIG9mIHNsaWRlIGluZGljYXRvcgogICAgICAgdGhpcy5lb3MgPSB0aGlzLmNyZWF0ZV9lbGVtZW50KCJzcGFuIik7CiAgICAgICB0aGlzLmVvcy5pbm5lckhUTUwgPSAiKiAiOwogICAgICAgbGVmdC5hcHBlbmRDaGlsZCh0aGlzLmVvcyk7CgogICAgICAgdmFyIGhlbHAgPSB0aGlzLmNyZWF0ZV9lbGVtZW50KCJhIik7CiAgICAgICBoZWxwLnNldEF0dHJpYnV0ZSgiaHJlZiIsIHRoaXMuaGVscF9wYWdlKTsKICAgICAgIGhlbHAuc2V0QXR0cmlidXRlKCJ0aXRsZSIsIHRoaXMubG9jYWxpemUodGhpcy5oZWxwX3RleHQpKTsKICAgICAgIGhlbHAuaW5uZXJIVE1MID0gdGhpcy5sb2NhbGl6ZSgiaGVscD8iKTsKICAgICAgIGxlZnQuYXBwZW5kQ2hpbGQoaGVscCk7CiAgICAgICB0aGlzLmhlbHBfYW5jaG9yID0gaGVscDsgIC8vIHNhdmUgZm9yIGZvY3VzIGhhY2sKCiAgICAgICB2YXIgZ2FwMSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIgIik7CiAgICAgICBsZWZ0LmFwcGVuZENoaWxkKGdhcDEpOwoKICAgICAgIHZhciBjb250ZW50cyA9IHRoaXMuY3JlYXRlX2VsZW1lbnQoImEiKTsKICAgICAgIGNvbnRlbnRzLnNldEF0dHJpYnV0ZSgiaHJlZiIsICJqYXZhc2NyaXB0OnczY19zbGlkeS50b2dnbGVfdGFibGVfb2ZfY29udGVudHMoKSIpOwogICAgICAgY29udGVudHMuc2V0QXR0cmlidXRlKCJ0aXRsZSIsIHRoaXMubG9jYWxpemUoInRhYmxlIG9mIGNvbnRlbnRzIikpOwogICAgICAgY29udGVudHMuaW5uZXJIVE1MID0gdGhpcy5sb2NhbGl6ZSgiY29udGVudHM/Iik7CiAgICAgICBsZWZ0LmFwcGVuZENoaWxkKGNvbnRlbnRzKTsKCiAgICAgICB2YXIgZ2FwMiA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIgIik7CiAgICAgICBsZWZ0LmFwcGVuZENoaWxkKGdhcDIpOwoKICAgICAgIHZhciBjb3B5cmlnaHQgPSB0aGlzLmZpbmRfY29weXJpZ2h0KCk7CgogICAgICAgaWYgKGNvcHlyaWdodCkKICAgICAgIHsKICAgICAgICAgdmFyIHNwYW4gPSB0aGlzLmNyZWF0ZV9lbGVtZW50KCJzcGFuIik7CiAgICAgICAgIHNwYW4uY2xhc3NOYW1lID0gImNvcHlyaWdodCI7CiAgICAgICAgIHNwYW4uaW5uZXJIVE1MID0gY29weXJpZ2h0OwogICAgICAgICBsZWZ0LmFwcGVuZENoaWxkKHNwYW4pOwogICAgICAgfQoKICAgICAgIHRoaXMudG9vbGJhci5zZXRBdHRyaWJ1dGUoInRhYmluZGV4IiwgIjAiKTsKICAgICAgIHRoaXMudG9vbGJhci5hcHBlbmRDaGlsZChsZWZ0KTsKICAgICB9CiAgICAgZWxzZSAvLyBJRTYgc28gbmVlZCB0byB3b3JrIGFyb3VuZCBpdHMgcG9vciBDU1Mgc3VwcG9ydAogICAgIHsKICAgICAgIHRoaXMudG9vbGJhci5zdHlsZS5wb3NpdGlvbiA9ICh0aGlzLmllNyA/ICJmaXhlZCIgOiAiYWJzb2x1dGUiKTsKICAgICAgIHRoaXMudG9vbGJhci5zdHlsZS56SW5kZXggPSAiMjAwIjsKICAgICAgIHRoaXMudG9vbGJhci5zdHlsZS53aWR0aCA9ICI5OS45JSI7CiAgICAgICB0aGlzLnRvb2xiYXIuc3R5bGUuaGVpZ2h0ID0gIjEuMmVtIjsKICAgICAgIHRoaXMudG9vbGJhci5zdHlsZS50b3AgPSAiYXV0byI7CiAgICAgICB0aGlzLnRvb2xiYXIuc3R5bGUuYm90dG9tID0gIjAiOwogICAgICAgdGhpcy50b29sYmFyLnN0eWxlLmxlZnQgPSAiMCI7CiAgICAgICB0aGlzLnRvb2xiYXIuc3R5bGUucmlnaHQgPSAiMCI7CiAgICAgICB0aGlzLnRvb2xiYXIuc3R5bGUudGV4dEFsaWduID0gImxlZnQiOwogICAgICAgdGhpcy50b29sYmFyLnN0eWxlLmZvbnRTaXplID0gIjYwJSI7CiAgICAgICB0aGlzLnRvb2xiYXIuc3R5bGUuY29sb3IgPSAicmVkIjsKICAgICAgIHRoaXMudG9vbGJhci5ib3JkZXJXaWR0aCA9IDA7CiAgICAgICB0aGlzLnRvb2xiYXIuY2xhc3NOYW1lID0gInRvb2xiYXIiOwogICAgICAgdGhpcy50b29sYmFyLnN0eWxlLmJhY2tncm91bmQgPSAicmdiKDI0MCwyNDAsMjQwKSI7CgogICAgICAgLy8gd291bGQgbGlrZSB0byBoYXZlIGhlbHAgdGV4dCBsZWZ0IGFsaWduZWQKICAgICAgIC8vIGFuZCBwYWdlIGNvdW50ZXIgcmlnaHQgYWxpZ25lZCwgZmxvYXRpbmcKICAgICAgIC8vIGRpdidzIGRvbid0IHdvcmssIHNvIGluc3RlYWQgdXNlIG5lc3RlZAogICAgICAgLy8gYWJzb2x1dGVseSBwb3NpdGlvbmVkIGRpdidzLgoKICAgICAgIHZhciBzcCA9IHRoaXMuY3JlYXRlX2VsZW1lbnQoInNwYW4iKTsKICAgICAgIHNwLmlubmVySFRNTCA9ICImbmJzcDsmbmJzcDsqJm5ic3A7IjsKICAgICAgIHRoaXMudG9vbGJhci5hcHBlbmRDaGlsZChzcCk7CiAgICAgICB0aGlzLmVvcyA9IHNwOyAgLy8gZW5kIG9mIHNsaWRlIGluZGljYXRvcgoKICAgICAgIHZhciBoZWxwID0gdGhpcy5jcmVhdGVfZWxlbWVudCgiYSIpOwogICAgICAgaGVscC5zZXRBdHRyaWJ1dGUoImhyZWYiLCB0aGlzLmhlbHBfcGFnZSk7CiAgICAgICBoZWxwLnNldEF0dHJpYnV0ZSgidGl0bGUiLCB0aGlzLmxvY2FsaXplKHRoaXMuaGVscF90ZXh0KSk7CiAgICAgICBoZWxwLmlubmVySFRNTCA9IHRoaXMubG9jYWxpemUoImhlbHA/Iik7CiAgICAgICB0aGlzLnRvb2xiYXIuYXBwZW5kQ2hpbGQoaGVscCk7CiAgICAgICB0aGlzLmhlbHBfYW5jaG9yID0gaGVscDsgIC8vIHNhdmUgZm9yIGZvY3VzIGhhY2sKCiAgICAgICB2YXIgZ2FwMSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIgIik7CiAgICAgICB0aGlzLnRvb2xiYXIuYXBwZW5kQ2hpbGQoZ2FwMSk7CgogICAgICAgdmFyIGNvbnRlbnRzID0gdGhpcy5jcmVhdGVfZWxlbWVudCgiYSIpOwogICAgICAgY29udGVudHMuc2V0QXR0cmlidXRlKCJocmVmIiwgImphdmFzY3JpcHQ6dG9nZ2xlVGFibGVPZkNvbnRlbnRzKCkiKTsKICAgICAgIGNvbnRlbnRzLnNldEF0dHJpYnV0ZSgidGl0bGUiLCB0aGlzLmxvY2FsaXplKCJ0YWJsZSBvZiBjb250ZW50cyIubG9jYWxpemUpKTsKICAgICAgIGNvbnRlbnRzLmlubmVySFRNTCA9IHRoaXMubG9jYWxpemUoImNvbnRlbnRzPyIpOwogICAgICAgdGhpcy50b29sYmFyLmFwcGVuZENoaWxkKGNvbnRlbnRzKTsKCiAgICAgICB2YXIgZ2FwMiA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKCIgIik7CiAgICAgICB0aGlzLnRvb2xiYXIuYXBwZW5kQ2hpbGQoZ2FwMik7CgogICAgICAgdmFyIGNvcHlyaWdodCA9IHRoaXMuZmluZF9jb3B5cmlnaHQoKTsKCiAgICAgICBpZiAoY29weXJpZ2h0KQogICAgICAgewogICAgICAgICB2YXIgc3BhbiA9IHRoaXMuY3JlYXRlX2VsZW1lbnQoInNwYW4iKTsKICAgICAgICAgc3Bhbi5pbm5lckhUTUwgPSBjb3B5cmlnaHQ7CiAgICAgICAgIHNwYW4uc3R5bGUuY29sb3IgPSAiYmxhY2siOwogICAgICAgICBzcGFuLnN0eWxlLm1hcmdpbkxlZnQgPSAiMC41ZW0iOwogICAgICAgICB0aGlzLnRvb2xiYXIuYXBwZW5kQ2hpbGQoc3Bhbik7CiAgICAgICB9CgogICAgICAgY291bnRlciA9IHRoaXMuY3JlYXRlX2VsZW1lbnQoImRpdiIpCiAgICAgICBjb3VudGVyLnN0eWxlLnBvc2l0aW9uID0gImFic29sdXRlIjsKICAgICAgIGNvdW50ZXIuc3R5bGUud2lkdGggPSAiYXV0byI7IC8vIjIwJSI7CiAgICAgICBjb3VudGVyLnN0eWxlLmhlaWdodCA9ICIxLjJlbSI7CiAgICAgICBjb3VudGVyLnN0eWxlLnRvcCA9ICJhdXRvIjsKICAgICAgIGNvdW50ZXIuc3R5bGUuYm90dG9tID0gMDsKICAgICAgIGNvdW50ZXIuc3R5bGUucmlnaHQgPSAiMCI7CiAgICAgICBjb3VudGVyLnN0eWxlLnRleHRBbGlnbiA9ICJyaWdodCI7CiAgICAgICBjb3VudGVyLnN0eWxlLmNvbG9yID0gInJlZCI7CiAgICAgICBjb3VudGVyLnN0eWxlLmJhY2tncm91bmQgPSAicmdiKDI0MCwyNDAsMjQwKSI7CgogICAgICAgY291bnRlci5pbm5lckhUTUwgPSB0aGlzLmxvY2FsaXplKCJzbGlkZSIpICsgIiBuL20iOwogICAgICAgdGhpcy50b29sYmFyLmFwcGVuZENoaWxkKGNvdW50ZXIpOwogICAgIH0KCiAgICAgLy8gZW5zdXJlIHRoYXQgY2xpY2sgaXNuJ3QgcGFzc2VkIHRocm91Z2ggdG8gdGhlIHBhZ2UKICAgICB0aGlzLnRvb2xiYXIub25jbGljayA9CiAgICAgICAgIGZ1bmN0aW9uIChlKSB7CiAgICAgICAgICAgaWYgKCFlKQogICAgICAgICAgICAgZSA9IHdpbmRvdy5ldmVudDsKCiAgICAgICAgICAgdmFyIHRhcmdldCA9IGUudGFyZ2V0OwoKICAgICAgICAgICBpZiAoIXRhcmdldCAmJiBlLnNyY0VsZW1lbnQpCiAgICAgICAgICAgICB0YXJnZXQgPSBlLnNyY0VsZW1lbnQ7CgogICAgICAgICAgIC8vIHdvcmsgYXJvdW5kIFNhZmFyaSBidWcKICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5ub2RlVHlwZSA9PSAzKQogICAgICAgICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgogICAgICAgICAgIHczY19zbGlkeS5zdG9wX3Byb3BhZ2F0aW9uKGUpOwoKICAgICAgICAgICBpZiAodGFyZ2V0ICYmIHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpICE9ICJhIikKICAgICAgICAgICAgIHczY19zbGlkeS5tb3VzZV9idXR0b25fY2xpY2soZSk7CiAgICAgICAgIH07CgogICAgIHRoaXMuc2xpZGVfbnVtYmVyX2VsZW1lbnQgPSBjb3VudGVyOwogICAgIHRoaXMuc2V0X2Vvc19zdGF0dXMoZmFsc2UpOwogICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy50b29sYmFyKTsKICB9LAoKICAvLyB3eXNpd3lnIGVkaXRvcnMgbWFrZSBpdCBoYXJkIHRvIHVzZSBkaXYgZWxlbWVudHMKICAvLyBlLmcuIGFtYXlhIGxvc2VzIHRoZSBkaXYgd2hlbiB5b3UgY29weSBhbmQgcGFzdGUKICAvLyB0aGlzIGZ1bmN0aW9uIHdyYXBzIGRpdiBlbGVtZW50cyBhcm91bmQgaW1wbGljaXQKICAvLyBzbGlkZXMgd2hpY2ggc3RhcnQgd2l0aCBhbiBoMSBlbGVtZW50IGFuZCBjb250aW51ZQogIC8vIHVwIHRvIHRoZSBuZXh0IGhlYWRpbmcgb3IgZGl2IGVsZW1lbnQKICB3cmFwX2ltcGxpY2l0X3NsaWRlczogZnVuY3Rpb24gKCkgewogICAgdmFyIGksIGhlYWRpbmcsIG5vZGUsIG5leHQsIGRpdjsKICAgIHZhciBoZWFkaW5ncyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJoMSIpOwoKICAgIGlmICghaGVhZGluZ3MpCiAgICAgIHJldHVybjsKCiAgICBmb3IgKGkgPSAwOyBpIDwgaGVhZGluZ3MubGVuZ3RoOyArK2kpCiAgICB7CiAgICAgIGhlYWRpbmcgPSBoZWFkaW5nc1tpXTsKCiAgICAgIGlmIChoZWFkaW5nLnBhcmVudE5vZGUgIT0gZG9jdW1lbnQuYm9keSkKICAgICAgICBjb250aW51ZTsKCiAgICAgIG5vZGUgPSBoZWFkaW5nLm5leHRTaWJsaW5nOwoKICAgICAgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgIHRoaXMuYWRkX2NsYXNzKGRpdiwgInNsaWRlIik7CiAgICAgIGRvY3VtZW50LmJvZHkucmVwbGFjZUNoaWxkKGRpdiwgaGVhZGluZyk7CiAgICAgIGRpdi5hcHBlbmRDaGlsZChoZWFkaW5nKTsKCiAgICAgIHdoaWxlIChub2RlKQogICAgICB7CiAgICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSAmJiAgICAvLyBhbiBlbGVtZW50CiAgICAgICAgICAgICAobm9kZS5ub2RlTmFtZSA9PSAiSDEiIHx8CiAgICAgICAgICAgICAgbm9kZS5ub2RlTmFtZSA9PSAiaDEiIHx8CiAgICAgICAgICAgICAgbm9kZS5ub2RlTmFtZSA9PSAiRElWIiB8fAogICAgICAgICAgICAgIG5vZGUubm9kZU5hbWUgPT0gImRpdiIpKQogICAgICAgICAgYnJlYWs7CgogICAgICAgIG5leHQgPSBub2RlLm5leHRTaWJsaW5nOwogICAgICAgIG5vZGUgPSBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKG5vZGUpOwogICAgICAgIGRpdi5hcHBlbmRDaGlsZChub2RlKTsKICAgICAgICBub2RlID0gbmV4dDsKICAgICAgfSAKICAgIH0KICB9LAoKLy8gcmV0dXJuIG5ldyBhcnJheSBvZiBhbGwgc2xpZGVzCiAgY29sbGVjdF9zbGlkZXM6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzbGlkZXMgPSBuZXcgQXJyYXkoKTsKICAgIHZhciBkaXZzID0gZG9jdW1lbnQuYm9keS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiZGl2Iik7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXZzLmxlbmd0aDsgKytpKQogICAgewogICAgICBkaXYgPSBkaXZzLml0ZW0oaSk7CgogICAgICBpZiAodGhpcy5oYXNfY2xhc3MoZGl2LCAic2xpZGUiKSkKICAgICAgewogICAgICAgIC8vIGFkZCBzbGlkZSB0byBjb2xsZWN0aW9uCiAgICAgICAgc2xpZGVzW3NsaWRlcy5sZW5ndGhdID0gZGl2OwoKICAgICAgICAvLyBoaWRlIGVhY2ggc2xpZGUgYXMgaXQgaXMgZm91bmQKICAgICAgICB0aGlzLmFkZF9jbGFzcyhkaXYsICJoaWRkZW4iKTsKCiAgICAgICAgLy8gYWRkIGR1bW15IDxici8+IGF0IGVuZCBmb3Igc2Nyb2xsaW5nIGhhY2sKICAgICAgICB2YXIgbm9kZTEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJiciIpOwogICAgICAgIGRpdi5hcHBlbmRDaGlsZChub2RlMSk7CiAgICAgICAgdmFyIG5vZGUyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiYnIiKTsKICAgICAgICBkaXYuYXBwZW5kQ2hpbGQobm9kZTIpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKHRoaXMuaGFzX2NsYXNzKGRpdiwgImJhY2tncm91bmQiKSkKICAgICAgeyAgLy8gd29yayBhcm91bmQgZm9yIEZpcmVmb3ggU1ZHIHJlbG9hZCBidWcKICAgICAgICAvLyB3aGljaCBvdGhlcndpc2UgcmVwbGFjZXMgMXN0IFNWRyBncmFwaGljIHdpdGggMm5kCiAgICAgICAgZGl2LnN0eWxlLmRpc3BsYXkgPSAiYmxvY2siOwogICAgICB9CiAgICB9CgogICAgdGhpcy5zbGlkZXMgPSBzbGlkZXM7CiAgfSwKCiAgLy8gcmV0dXJuIG5ldyBhcnJheSBvZiBhbGwgPGRpdiBjbGFzcz0iaGFuZG91dCI+CiAgY29sbGVjdF9ub3RlczogZnVuY3Rpb24gKCkgewogICAgdmFyIG5vdGVzID0gbmV3IEFycmF5KCk7CiAgICB2YXIgZGl2cyA9IGRvY3VtZW50LmJvZHkuZ2V0RWxlbWVudHNCeVRhZ05hbWUoImRpdiIpOwoKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZGl2cy5sZW5ndGg7ICsraSkKICAgIHsKICAgICAgZGl2ID0gZGl2cy5pdGVtKGkpOwoKICAgICAgaWYgKHRoaXMuaGFzX2NsYXNzKGRpdiwgImhhbmRvdXQiKSkKICAgICAgewogICAgICAgIC8vIGFkZCBub3RlIHRvIGNvbGxlY3Rpb24KICAgICAgICBub3Rlc1tub3Rlcy5sZW5ndGhdID0gZGl2OwoKICAgICAgICAvLyBhbmQgaGlkZSBpdAogICAgICAgIHRoaXMuYWRkX2NsYXNzKGRpdiwgImhpZGRlbiIpOwogICAgICB9CiAgICB9CgogICAgdGhpcy5ub3RlcyA9IG5vdGVzOwogIH0sCgogIC8vIHJldHVybiBuZXcgYXJyYXkgb2YgYWxsIDxkaXYgY2xhc3M9ImJhY2tncm91bmQiPgogIC8vIGluY2x1ZGluZyBuYW1lZCBiYWNrZ3JvdW5kcyBlLmcuIGNsYXNzPSJiYWNrZ3JvdW5kIHRpdGxlcGFnZSIKICBjb2xsZWN0X2JhY2tncm91bmRzOiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgYmFja2dyb3VuZHMgPSBuZXcgQXJyYXkoKTsKICAgIHZhciBkaXZzID0gZG9jdW1lbnQuYm9keS5nZXRFbGVtZW50c0J5VGFnTmFtZSgiZGl2Iik7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkaXZzLmxlbmd0aDsgKytpKQogICAgewogICAgICBkaXYgPSBkaXZzLml0ZW0oaSk7CgogICAgICBpZiAodGhpcy5oYXNfY2xhc3MoZGl2LCAiYmFja2dyb3VuZCIpKQogICAgICB7CiAgICAgICAgLy8gYWRkIGJhY2tncm91bmQgdG8gY29sbGVjdGlvbgogICAgICAgIGJhY2tncm91bmRzW2JhY2tncm91bmRzLmxlbmd0aF0gPSBkaXY7CgogICAgICAgIC8vIGFuZCBoaWRlIGl0CiAgICAgICAgdGhpcy5hZGRfY2xhc3MoZGl2LCAiaGlkZGVuIik7CiAgICAgIH0KICAgIH0KCiAgICB0aGlzLmJhY2tncm91bmRzID0gYmFja2dyb3VuZHM7CiAgfSwKCiAgLy8gc2V0IGNsaWNrIGhhbmRsZXJzIG9uIGFsbCBhbmNob3JzCiAgcGF0Y2hfYW5jaG9yczogZnVuY3Rpb24gKCkgewogICAgdmFyIHNlbGYgPSB3M2Nfc2xpZHk7CiAgICB2YXIgaGFuZGxlciA9IGZ1bmN0aW9uIChldmVudCkgewogICAgICAvLyBjb21wYXJlIHRoaXMuaHJlZiB3aXRoIGxvY2F0aW9uLmhyZWYKICAgICAgLy8gZm9yIGxpbmsgdG8gYW5vdGhlciBzbGlkZSBpbiB0aGlzIGRvYwoKICAgICAgaWYgKHNlbGYucGFnZV9hZGRyZXNzKHRoaXMuaHJlZikgPT0gc2VsZi5wYWdlX2FkZHJlc3MobG9jYXRpb24uaHJlZikpCiAgICAgIHsKICAgICAgICAvLyB5ZXMsIHNvIGZpbmQgbmV3IHNsaWRlIG51bWJlcgogICAgICAgIHZhciBuZXdzbGlkZW51bSA9IHNlbGYuZmluZF9zbGlkZV9udW1iZXIodGhpcy5ocmVmKTsKCiAgICAgICAgaWYgKG5ld3NsaWRlbnVtICE9IHNlbGYuc2xpZGVfbnVtYmVyKQogICAgICAgIHsKICAgICAgICAgIHZhciBzbGlkZSA9IHNlbGYuc2xpZGVzW3NlbGYuc2xpZGVfbnVtYmVyXTsKICAgICAgICAgIHNlbGYuaGlkZV9zbGlkZShzbGlkZSk7CiAgICAgICAgICBzZWxmLnNsaWRlX251bWJlciA9IG5ld3NsaWRlbnVtOwogICAgICAgICAgc2xpZGUgPSBzZWxmLnNsaWRlc1tzZWxmLnNsaWRlX251bWJlcl07CiAgICAgICAgICBzZWxmLnNob3dfc2xpZGUoc2xpZGUpOwogICAgICAgICAgc2VsZi5zZXRfbG9jYXRpb24oKTsKICAgICAgICB9CiAgICAgIH0KICAgICAgZWxzZQogICAgICAgIHczY19zbGlkeS5zdG9wX3Byb3BhZ2F0aW9uKGV2ZW50KTsKCi8vICAgICAgZWxzZSBpZiAodGhpcy50YXJnZXQgPT0gbnVsbCkKLy8gICAgICAgIGxvY2F0aW9uLmhyZWYgPSB0aGlzLmhyZWY7CgogICAgICB0aGlzLmJsdXIoKTsKICAgICAgc2VsZi5kaXNhYmxlX3NsaWRlX2NsaWNrID0gdHJ1ZTsKICAgIH07CgogICAgdmFyIGFuY2hvcnMgPSBkb2N1bWVudC5ib2R5LmdldEVsZW1lbnRzQnlUYWdOYW1lKCJhIik7CgogICAgZm9yICh2YXIgaSA9IDA7IGkgPCBhbmNob3JzLmxlbmd0aDsgKytpKQogICAgewogICAgICBpZiAod2luZG93LmFkZEV2ZW50TGlzdGVuZXIpCiAgICAgICAgYW5jaG9yc1tpXS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGhhbmRsZXIsIGZhbHNlKTsKICAgICAgZWxzZQogICAgICAgIGFuY2hvcnNbaV0uYXR0YWNoRXZlbnQoIm9uY2xpY2siLCBoYW5kbGVyKTsKICAgIH0KICB9LAoKICAvLyAjIyMgQ0hFQ0sgTUUgIyMjIHNlZSB3aGljaCBmdW5jdGlvbnMgYXJlIGludm9rZWQgdmlhIHNldFRpbWVvdXQKICAvLyBlaXRoZXIgZGlyZWN0bHkgb3IgaW5kaXJlY3RseSBmb3IgdXNlIG9mIHczY19zbGlkeSB2cyB0aGlzCiAgc2hvd19zbGlkZV9udW1iZXI6IGZ1bmN0aW9uICgpIHsKICAgIHZhciB0aW1lciA9IHczY19zbGlkeS5nZXRfdGltZXIoKTsKICAgIHczY19zbGlkeS5zbGlkZV9udW1iZXJfZWxlbWVudC5pbm5lckhUTUwgPSB0aW1lciArIHczY19zbGlkeS5sb2NhbGl6ZSgic2xpZGUiKSArICIgIiArCiAgICAgICAgICAgKHczY19zbGlkeS5zbGlkZV9udW1iZXIgKyAxKSArICIvIiArIHczY19zbGlkeS5zbGlkZXMubGVuZ3RoOwogIH0sCgogIC8vIGV2ZXJ5IDIwMG1TIGNoZWNrIGlmIHRoZSBsb2NhdGlvbiBoYXMgYmVlbiBjaGFuZ2VkIGFzIGEKICAvLyByZXN1bHQgb2YgdGhlIHVzZXIgYWN0aXZhdGluZyB0aGUgQmFjayBidXR0b24vbWVudSBpdGVtCiAgLy8gZG9lc24ndCB3b3JrIGZvciBPcGVyYSA8IDkuNQogIGNoZWNrX2xvY2F0aW9uOiBmdW5jdGlvbiAoKSB7CiAgICB2YXIgaGFzaCA9IGxvY2F0aW9uLmhhc2g7CgogICAgaWYgKHczY19zbGlkeS5zbGlkZV9udW1iZXIgPiAwICYmIChoYXNoID09ICIiIHx8IGhhc2ggPT0gIiMiKSkKICAgICAgdzNjX3NsaWR5LmdvdG9fc2xpZGUoMCk7CiAgICBlbHNlIGlmIChoYXNoLmxlbmd0aCA+IDIgJiYgaGFzaCAhPSAiIygiKyh3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyKzEpKyIpIikKICAgIHsKICAgICAgdmFyIG51bSA9IHBhcnNlSW50KGxvY2F0aW9uLmhhc2guc3Vic3RyKDIpKTsKCiAgICAgIGlmICghaXNOYU4obnVtKSkKICAgICAgICB3M2Nfc2xpZHkuZ290b19zbGlkZShudW0tMSk7CiAgICB9CgogICAgaWYgKHczY19zbGlkeS50aW1lX2xlZnQgJiYgdzNjX3NsaWR5LnNsaWRlX251bWJlciA+IDApCiAgICB7CiAgICAgIHczY19zbGlkeS5zaG93X3NsaWRlX251bWJlcigpOwoKICAgICAgaWYgKHczY19zbGlkeS50aW1lX2xlZnQgPiAwKQogICAgICAgIHczY19zbGlkeS50aW1lX2xlZnQgLT0gMjAwOwogICAgfSAKICB9LAoKICBnZXRfdGltZXI6IGZ1bmN0aW9uICgpIHsKICAgIHZhciB0aW1lciA9ICIiOwogICAgaWYgKHczY19zbGlkeS50aW1lX2xlZnQpCiAgICB7CiAgICAgIHZhciBtaW5zLCBzZWNzOwogICAgICBzZWNzID0gTWF0aC5mbG9vcih3M2Nfc2xpZHkudGltZV9sZWZ0LzEwMDApOwogICAgICBtaW5zID0gTWF0aC5mbG9vcihzZWNzIC8gNjApOwogICAgICBzZWNzID0gc2VjcyAlIDYwOwogICAgICB0aW1lciA9IChtaW5zID8gbWlucysibSIgOiAiIikgKyBzZWNzICsgInMgIjsKICAgIH0KCiAgICByZXR1cm4gdGltZXI7CiAgfSwKCiAgLy8gdGhpcyBkb2Vzbid0IHB1c2ggbG9jYXRpb24gb250byBoaXN0b3J5IHN0YWNrIGZvciBJRQogIC8vIGZvciB3aGljaCBhIGhpZGRlbiBpZnJhbWUgaGFjayBpcyBuZWVkZWQ6IGxvYWQgcGFnZSBpbnRvCiAgLy8gdGhlIGlmcmFtZSB3aXRoIHNjcmlwdCB0aGF0IHNldCdzIHBhcmVudCdzIGxvY2F0aW9uLmhhc2gKICAvLyBidXQgdGhhdCB3b24ndCB3b3JrIGZvciBzdGFuZGFsb25lIHVzZSB1bmxlc3Mgd2UgY2FuCiAgLy8gY3JlYXRlIHRoZSBwYWdlIGR5bmFtaWNhbGx5IHZpYSBhIGphdmFzY3JpcHQ6IFVSTAogIHNldF9sb2NhdGlvbjogZnVuY3Rpb24gKCkgewogICAgIHZhciB1cmkgPSB3M2Nfc2xpZHkucGFnZV9hZGRyZXNzKGxvY2F0aW9uLmhyZWYpOwogICAgIHZhciBoYXNoID0gIiMoIiArICh3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyKzEpICsgIikiOwoKICAgICBpZiAodzNjX3NsaWR5LnNsaWRlX251bWJlciA+PSAwKQogICAgICAgdXJpID0gdXJpICsgaGFzaDsKCiAgICAgaWYgKHczY19zbGlkeS5pZSAmJiAodzNjX3NsaWR5LmllNiB8fCB3M2Nfc2xpZHkuaWU3KSkKICAgICAgIHczY19zbGlkeS5wdXNoX2hhc2goaGFzaCk7CgogICAgIGlmICh1cmkgIT0gbG9jYXRpb24uaHJlZikgLy8gJiYgIWtodG1sCiAgICAgICAgbG9jYXRpb24uaHJlZiA9IHVyaTsKCiAgICAgaWYgKHRoaXMua2h0bWwpCiAgICAgICAgaGFzaCA9ICIoIiArICh3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyKzEpICsgIikiOwoKICAgICBpZiAoIXRoaXMuaWUgJiYgbG9jYXRpb24uaGFzaCAhPSBoYXNoICYmIGxvY2F0aW9uLmhhc2ggIT0gIiIpCiAgICAgICBsb2NhdGlvbi5oYXNoID0gaGFzaDsKCiAgICAgZG9jdW1lbnQudGl0bGUgPSB3M2Nfc2xpZHkudGl0bGUgKyAiICgiICsgKHczY19zbGlkeS5zbGlkZV9udW1iZXIrMSkgKyAiKSI7CiAgICAgdzNjX3NsaWR5LnNob3dfc2xpZGVfbnVtYmVyKCk7CiAgfSwKCiAgcGFnZV9hZGRyZXNzOiBmdW5jdGlvbiAodXJpKSB7CiAgICB2YXIgaSA9IHVyaS5pbmRleE9mKCIjIik7CgogICAgaWYgKGkgPCAwKQogICAgICBpID0gdXJpLmluZGV4T2YoIiUyMyIpOwoKICAgIC8vIGNoZWNrIGlmIGFuY2hvciBpcyBlbnRpcmUgcGFnZQoKICAgIGlmIChpIDwgMCkKICAgICAgcmV0dXJuIHVyaTsgIC8vIHllcwoKICAgIHJldHVybiB1cmkuc3Vic3RyKDAsIGkpOwogIH0sCgogIC8vIG9ubHkgdXNlZCBmb3IgSUU2IGFuZCBJRTcKICBvbl9mcmFtZV9sb2FkZWQ6IGZ1bmN0aW9uIChoYXNoKSB7CiAgICBsb2NhdGlvbi5oYXNoID0gaGFzaDsKICAgIHZhciB1cmkgPSB3M2Nfc2xpZHkucGFnZV9hZGRyZXNzKGxvY2F0aW9uLmhyZWYpOwogICAgbG9jYXRpb24uaHJlZiA9IHVyaSArIGhhc2g7CiAgfSwKCiAgLy8gaGlzdG9yeSBoYWNrIHdpdGggdGhhbmtzIHRvIEJlcnRyYW5kIExlIFJveQogIHB1c2hfaGFzaDogZnVuY3Rpb24gKGhhc2gpIHsKICAgIGlmIChoYXNoID09ICIiKSBoYXNoID0gIiMoMSkiOwogICAgICB3aW5kb3cubG9jYXRpb24uaGFzaCA9IGhhc2g7CgogICAgdmFyIGRvYyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJoaXN0b3J5RnJhbWUiKS5jb250ZW50V2luZG93LmRvY3VtZW50OwogICAgZG9jLm9wZW4oImphdmFzY3JpcHQ6JzxodG1sPjwvaHRtbD4nIik7CiAgICBkb2Mud3JpdGUoIjxodG1sPjxoZWFkPjxzY3JpcHQgdHlwZT1cInRleHQvamF2YXNjcmlwdFwiPndpbmRvdy5wYXJlbnQudzNjX3NsaWR5Lm9uX2ZyYW1lX2xvYWRlZCgnIisKICAgICAgKGhhc2gpICsgIicpOzwvc2NyaXB0PjwvaGVhZD48Ym9keT5oZWxsbyBtdW08L2JvZHk+PC9odG1sPiIpOwogICAgICBkb2MuY2xvc2UoKTsKICB9LAoKICAvLyBmaW5kIGN1cnJlbnQgc2xpZGUgYmFzZWQgdXBvbiBsb2NhdGlvbgogIC8vIGZpcnN0IGZpbmQgdGFyZ2V0IGFuY2hvciBhbmQgdGhlbiBsb29rCiAgLy8gZm9yIGFzc29jaWF0ZWQgZGl2IGVsZW1lbnQgZW5jbG9zaW5nIGl0CiAgLy8gZmluYWxseSBtYXAgdGhhdCB0byBzbGlkZSBudW1iZXIKICBmaW5kX3NsaWRlX251bWJlcjogZnVuY3Rpb24gKHVyaSkgewogICAgLy8gZmlyc3QgZ2V0IGFuY2hvciBmcm9tIHBhZ2UgbG9jYXRpb24KCiAgICB2YXIgaSA9IHVyaS5pbmRleE9mKCIjIik7CgogICAgLy8gY2hlY2sgaWYgYW5jaG9yIGlzIGVudGlyZSBwYWdlCiAgICBpZiAoaSA8IDApCiAgICAgIHJldHVybiAwOyAgLy8geWVzCgogICAgdmFyIGFuY2hvciA9IHVuZXNjYXBlKHVyaS5zdWJzdHIoaSsxKSk7CgogICAgLy8gbm93IHVzZSBhbmNob3IgYXMgWE1MIElEIHRvIGZpbmQgdGFyZ2V0CiAgICB2YXIgdGFyZ2V0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoYW5jaG9yKTsKCiAgICBpZiAoIXRhcmdldCkKICAgIHsKICAgICAgLy8gZG9lcyBhbmNob3IgbG9vayBsaWtlICIoMikiIGZvciBzbGlkZSAyID8/CiAgICAgIC8vIHdoZXJlIGZpcnN0IHNsaWRlIGlzICgxKQogICAgICB2YXIgcmUgPSAvXCgoXGQpK1wpLzsKCiAgICAgIGlmIChhbmNob3IubWF0Y2gocmUpKQogICAgICB7CiAgICAgICAgdmFyIG51bSA9IHBhcnNlSW50KGFuY2hvci5zdWJzdHJpbmcoMSwgYW5jaG9yLmxlbmd0aC0xKSk7CgogICAgICAgIGlmIChudW0gPiB0aGlzLnNsaWRlcy5sZW5ndGgpCiAgICAgICAgICBudW0gPSAxOwoKICAgICAgICBpZiAoLS1udW0gPCAwKQogICAgICAgICAgbnVtID0gMDsKCiAgICAgICAgcmV0dXJuIG51bTsKICAgICAgfQoKICAgICAgLy8gYWNjZXB0IFsyXSBmb3IgYmFja3dhcmRzIGNvbXBhdGliaWxpdHkKICAgICAgcmUgPSAvXFsoXGQpK1xdLzsKCiAgICAgIGlmIChhbmNob3IubWF0Y2gocmUpKQogICAgICB7CiAgICAgICAgIHZhciBudW0gPSBwYXJzZUludChhbmNob3Iuc3Vic3RyaW5nKDEsIGFuY2hvci5sZW5ndGgtMSkpOwoKICAgICAgICAgaWYgKG51bSA+IHRoaXMuc2xpZGVzLmxlbmd0aCkKICAgICAgICAgICAgbnVtID0gMTsKCiAgICAgICAgIGlmICgtLW51bSA8IDApCiAgICAgICAgICAgIG51bSA9IDA7CgogICAgICAgICByZXR1cm4gbnVtOwogICAgICB9CgogICAgICAvLyBvaCBkZWFyIHVua25vd24gYW5jaG9yCiAgICAgIHJldHVybiAwOwogICAgfQoKICAgIC8vIHNlYXJjaCBmb3IgZW5jbG9zaW5nIHNsaWRlCgogICAgd2hpbGUgKHRydWUpCiAgICB7CiAgICAgIC8vIGJyb3dzZXIgY29lcmNlcyBodG1sIGVsZW1lbnRzIHRvIHVwcGVyY2FzZSEKICAgICAgaWYgKHRhcmdldC5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpID09ICJkaXYiICYmCiAgICAgICAgICAgIHRoaXMuaGFzX2NsYXNzKHRhcmdldCwgInNsaWRlIikpCiAgICAgIHsKICAgICAgICAvLyBmb3VuZCB0aGUgc2xpZGUgZWxlbWVudAogICAgICAgIGJyZWFrOwogICAgICB9CgogICAgICAvLyBvdGhlcndpc2UgdHJ5IHBhcmVudCBlbGVtZW50IGlmIGFueQoKICAgICAgdGFyZ2V0ID0gdGFyZ2V0LnBhcmVudE5vZGU7CgogICAgICBpZiAoIXRhcmdldCkKICAgICAgewogICAgICAgIHJldHVybiAwOyAgIC8vIG5vIGx1Y2shCiAgICAgIH0KICAgIH07CgogICAgZm9yIChpID0gMDsgaSA8IHNsaWRlcy5sZW5ndGg7ICsraSkKICAgIHsKICAgICAgaWYgKHNsaWRlc1tpXSA9PSB0YXJnZXQpCiAgICAgICAgcmV0dXJuIGk7ICAvLyBzdWNjZXNzCiAgICB9CgogICAgLy8gb2ggZGVhciBzdGlsbCBubyBsdWNrCiAgICByZXR1cm4gMDsKICB9LAoKICBwcmV2aW91c19zbGlkZTogZnVuY3Rpb24gKGluY3JlbWVudGFsKSB7CiAgICBpZiAoIXczY19zbGlkeS52aWV3X2FsbCkKICAgIHsKICAgICAgdmFyIHNsaWRlOwoKICAgICAgaWYgKChpbmNyZW1lbnRhbCB8fCB3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyID09IDApICYmIHczY19zbGlkeS5sYXN0X3Nob3duICE9IG51bGwpCiAgICAgIHsKICAgICAgICB3M2Nfc2xpZHkubGFzdF9zaG93biA9IHczY19zbGlkeS5oaWRlX3ByZXZpb3VzX2l0ZW0odzNjX3NsaWR5Lmxhc3Rfc2hvd24pOwogICAgICAgIHczY19zbGlkeS5zZXRfZW9zX3N0YXR1cyhmYWxzZSk7CiAgICAgIH0KICAgICAgZWxzZSBpZiAodzNjX3NsaWR5LnNsaWRlX251bWJlciA+IDApCiAgICAgIHsKICAgICAgICBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CiAgICAgICAgdzNjX3NsaWR5LmhpZGVfc2xpZGUoc2xpZGUpOwoKICAgICAgICB3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyID0gdzNjX3NsaWR5LnNsaWRlX251bWJlciAtIDE7CiAgICAgICAgc2xpZGUgPSB3M2Nfc2xpZHkuc2xpZGVzW3czY19zbGlkeS5zbGlkZV9udW1iZXJdOwogICAgICAgIHczY19zbGlkeS5zZXRfdmlzaWJpbGl0eV9hbGxfaW5jcmVtZW50YWwoInZpc2libGUiKTsKICAgICAgICB3M2Nfc2xpZHkubGFzdF9zaG93biA9IHczY19zbGlkeS5wcmV2aW91c19pbmNyZW1lbnRhbF9pdGVtKG51bGwpOwogICAgICAgIHczY19zbGlkeS5zZXRfZW9zX3N0YXR1cyh0cnVlKTsKICAgICAgICB3M2Nfc2xpZHkuc2hvd19zbGlkZShzbGlkZSk7CiAgICAgIH0KCiAgICAgIHczY19zbGlkeS5zZXRfbG9jYXRpb24oKTsKCiAgICAgIGlmICghdzNjX3NsaWR5Lm5zX3BvcykKICAgICAgICB3M2Nfc2xpZHkucmVmcmVzaF90b29sYmFyKDIwMCk7CiAgICB9CiAgfSwKCiAgbmV4dF9zbGlkZTogZnVuY3Rpb24gKGluY3JlbWVudGFsKSB7CiAgICBpZiAoIXczY19zbGlkeS52aWV3X2FsbCkKICAgIHsKICAgICAgdmFyIHNsaWRlLCBsYXN0ID0gdzNjX3NsaWR5Lmxhc3Rfc2hvd247CgogICAgICBpZiAoaW5jcmVtZW50YWwgfHwgdzNjX3NsaWR5LnNsaWRlX251bWJlciA9PSB3M2Nfc2xpZHkuc2xpZGVzLmxlbmd0aCAtIDEpCiAgICAgICAgIHczY19zbGlkeS5sYXN0X3Nob3duID0gdzNjX3NsaWR5LnJldmVhbF9uZXh0X2l0ZW0odzNjX3NsaWR5Lmxhc3Rfc2hvd24pOwoKICAgICAgaWYgKCghaW5jcmVtZW50YWwgfHwgdzNjX3NsaWR5Lmxhc3Rfc2hvd24gPT0gbnVsbCkgJiYKICAgICAgICAgICAgIHczY19zbGlkeS5zbGlkZV9udW1iZXIgPCB3M2Nfc2xpZHkuc2xpZGVzLmxlbmd0aCAtIDEpCiAgICAgIHsKICAgICAgICAgc2xpZGUgPSB3M2Nfc2xpZHkuc2xpZGVzW3czY19zbGlkeS5zbGlkZV9udW1iZXJdOwogICAgICAgICB3M2Nfc2xpZHkuaGlkZV9zbGlkZShzbGlkZSk7CgogICAgICAgICB3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyID0gdzNjX3NsaWR5LnNsaWRlX251bWJlciArIDE7CiAgICAgICAgIHNsaWRlID0gdzNjX3NsaWR5LnNsaWRlc1t3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyXTsKICAgICAgICAgdzNjX3NsaWR5Lmxhc3Rfc2hvd24gPSBudWxsOwogICAgICAgICB3M2Nfc2xpZHkuc2V0X3Zpc2liaWxpdHlfYWxsX2luY3JlbWVudGFsKCJoaWRkZW4iKTsKICAgICAgICAgdzNjX3NsaWR5LnNob3dfc2xpZGUoc2xpZGUpOwogICAgICB9CiAgICAgIGVsc2UgaWYgKCF3M2Nfc2xpZHkubGFzdF9zaG93bikKICAgICAgewogICAgICAgICBpZiAobGFzdCAmJiBpbmNyZW1lbnRhbCkKICAgICAgICAgICB3M2Nfc2xpZHkubGFzdF9zaG93biA9IGxhc3Q7CiAgICAgIH0KCiAgICAgIHczY19zbGlkeS5zZXRfbG9jYXRpb24oKTsKCiAgICAgIHczY19zbGlkeS5zZXRfZW9zX3N0YXR1cyghdzNjX3NsaWR5Lm5leHRfaW5jcmVtZW50YWxfaXRlbSh3M2Nfc2xpZHkubGFzdF9zaG93bikpOwoKICAgICAgaWYgKCF3M2Nfc2xpZHkubnNfcG9zKQogICAgICAgICB3M2Nfc2xpZHkucmVmcmVzaF90b29sYmFyKDIwMCk7CiAgICAgfQogIH0sCgogIC8vIHRvIGZpcnN0IHNsaWRlIHdpdGggbm90aGluZyByZXZlYWxlZAogIC8vIGkuZS4gc3RhdGUgYXQgc3RhcnQgb2YgcHJlc2VudGF0aW9uCiAgZmlyc3Rfc2xpZGU6IGZ1bmN0aW9uICgpIHsKICAgICBpZiAoIXczY19zbGlkeS52aWV3X2FsbCkKICAgICB7CiAgICAgICB2YXIgc2xpZGU7CgogICAgICAgaWYgKHczY19zbGlkeS5zbGlkZV9udW1iZXIgIT0gMCkKICAgICAgIHsKICAgICAgICAgc2xpZGUgPSB3M2Nfc2xpZHkuc2xpZGVzW3czY19zbGlkeS5zbGlkZV9udW1iZXJdOwogICAgICAgICB3M2Nfc2xpZHkuaGlkZV9zbGlkZShzbGlkZSk7CgogICAgICAgICB3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyID0gMDsKICAgICAgICAgc2xpZGUgPSB3M2Nfc2xpZHkuc2xpZGVzW3czY19zbGlkeS5zbGlkZV9udW1iZXJdOwogICAgICAgICB3M2Nfc2xpZHkubGFzdF9zaG93biA9IG51bGw7CiAgICAgICAgIHczY19zbGlkeS5zZXRfdmlzaWJpbGl0eV9hbGxfaW5jcmVtZW50YWwoImhpZGRlbiIpOwogICAgICAgICB3M2Nfc2xpZHkuc2hvd19zbGlkZShzbGlkZSk7CiAgICAgICB9CgogICAgICAgdzNjX3NsaWR5LnNldF9lb3Nfc3RhdHVzKAogICAgICAgICAhdzNjX3NsaWR5Lm5leHRfaW5jcmVtZW50YWxfaXRlbSh3M2Nfc2xpZHkubGFzdF9zaG93bikpOwogICAgICAgdzNjX3NsaWR5LnNldF9sb2NhdGlvbigpOwogICAgIH0KICB9LAoKICAvLyBnb3RvIGxhc3Qgc2xpZGUgd2l0aCBldmVyeXRoaW5nIHJldmVhbGVkCiAgLy8gaS5lLiBzdGF0ZSBhdCBlbmQgb2YgcHJlc2VudGF0aW9uCiAgbGFzdF9zbGlkZTogZnVuY3Rpb24gKCkgewogICAgaWYgKCF3M2Nfc2xpZHkudmlld19hbGwpCiAgICB7CiAgICAgIHZhciBzbGlkZTsKCiAgICAgIHczY19zbGlkeS5sYXN0X3Nob3duID0gbnVsbDsgLy9yZXZlYWxOZXh0SXRlbShsYXN0U2hvd24pOwoKICAgICAgaWYgKHczY19zbGlkeS5sYXN0X3Nob3duID09IG51bGwgJiYKICAgICAgICAgIHczY19zbGlkeS5zbGlkZV9udW1iZXIgPCB3M2Nfc2xpZHkuc2xpZGVzLmxlbmd0aCAtIDEpCiAgICAgIHsKICAgICAgICAgc2xpZGUgPSB3M2Nfc2xpZHkuc2xpZGVzW3czY19zbGlkeS5zbGlkZV9udW1iZXJdOwogICAgICAgICB3M2Nfc2xpZHkuaGlkZV9zbGlkZShzbGlkZSk7CiAgICAgICAgIHczY19zbGlkeS5zbGlkZV9udW1iZXIgPSB3M2Nfc2xpZHkuc2xpZGVzLmxlbmd0aCAtIDE7CiAgICAgICAgIHNsaWRlID0gdzNjX3NsaWR5LnNsaWRlc1t3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyXTsKICAgICAgICAgdzNjX3NsaWR5LnNldF92aXNpYmlsaXR5X2FsbF9pbmNyZW1lbnRhbCgidmlzaWJsZSIpOwogICAgICAgICB3M2Nfc2xpZHkubGFzdF9zaG93biA9IHczY19zbGlkeS5wcmV2aW91c19pbmNyZW1lbnRhbF9pdGVtKG51bGwpOwoKICAgICAgICAgdzNjX3NsaWR5LnNob3dfc2xpZGUoc2xpZGUpOwogICAgICB9CiAgICAgIGVsc2UKICAgICAgewogICAgICAgICB3M2Nfc2xpZHkuc2V0X3Zpc2liaWxpdHlfYWxsX2luY3JlbWVudGFsKCJ2aXNpYmxlIik7CiAgICAgICAgIHczY19zbGlkeS5sYXN0X3Nob3duID0gdzNjX3NsaWR5LnByZXZpb3VzX2luY3JlbWVudGFsX2l0ZW0obnVsbCk7CiAgICAgIH0KCiAgICAgIHczY19zbGlkeS5zZXRfZW9zX3N0YXR1cyh0cnVlKTsKICAgICAgdzNjX3NsaWR5LnNldF9sb2NhdGlvbigpOwogICAgfQogIH0sCgoKICAvLyAjIyMgY2hlY2sgdGhpcyBhbmQgY29uc2lkZXIgYWRkL3JlbW92ZSBjbGFzcwogIHNldF9lb3Nfc3RhdHVzOiBmdW5jdGlvbiAoc3RhdGUpIHsKICAgIGlmICh0aGlzLmVvcykKICAgICAgdGhpcy5lb3Muc3R5bGUuY29sb3IgPSAoc3RhdGUgPyAicmdiKDI0MCwyNDAsMjQwKSIgOiAicmVkIik7CiAgfSwKCiAgLy8gZmlyc3Qgc2xpZGUgaXMgMAogIGdvdG9fc2xpZGU6IGZ1bmN0aW9uIChudW0pIHsKICAgIC8vYWxlcnQoImdvaW5nIHRvIHNsaWRlICIgKyAobnVtKzEpKTsKICAgIHZhciBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CiAgICB3M2Nfc2xpZHkuaGlkZV9zbGlkZShzbGlkZSk7CiAgICB3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyID0gbnVtOwogICAgc2xpZGUgPSB3M2Nfc2xpZHkuc2xpZGVzW3czY19zbGlkeS5zbGlkZV9udW1iZXJdOwogICAgdzNjX3NsaWR5Lmxhc3Rfc2hvd24gPSBudWxsOwogICAgdzNjX3NsaWR5LnNldF92aXNpYmlsaXR5X2FsbF9pbmNyZW1lbnRhbCgiaGlkZGVuIik7CiAgICB3M2Nfc2xpZHkuc2V0X2Vvc19zdGF0dXMoIXczY19zbGlkeS5uZXh0X2luY3JlbWVudGFsX2l0ZW0odzNjX3NsaWR5Lmxhc3Rfc2hvd24pKTsKICAgIGRvY3VtZW50LnRpdGxlID0gdzNjX3NsaWR5LnRpdGxlICsgIiAoIiArICh3M2Nfc2xpZHkuc2xpZGVfbnVtYmVyKzEpICsgIikiOwogICAgdzNjX3NsaWR5LnNob3dfc2xpZGUoc2xpZGUpOwogICAgdzNjX3NsaWR5LnNob3dfc2xpZGVfbnVtYmVyKCk7CiAgfSwKCgogIHNob3dfc2xpZGU6IGZ1bmN0aW9uIChzbGlkZSkgewogICAgdGhpcy5zeW5jX2JhY2tncm91bmQoc2xpZGUpOwogICAgd2luZG93LnNjcm9sbFRvKDAsMCk7CiAgICB0aGlzLnJlbW92ZV9jbGFzcyhzbGlkZSwgImhpZGRlbiIpOwogIH0sCgogIGhpZGVfc2xpZGU6IGZ1bmN0aW9uIChzbGlkZSkgewogICAgdGhpcy5hZGRfY2xhc3Moc2xpZGUsICJoaWRkZW4iKTsKICB9LAoKICAvLyBzaG93IGp1c3QgdGhlIGJhY2tncm91bmRzIHBlcnRpbmVudCB0byB0aGlzIHNsaWRlCiAgLy8gd2hlbiBzbGlkZSBiYWNrZ3JvdW5kLWNvbG9yIGlzIHRyYW5zcGFyZW50CiAgLy8gdGhpcyBzaG91bGQgbm93IHdvcmsgd2l0aCByZ2JhIGNvbG9yIHZhbHVlcwogIHN5bmNfYmFja2dyb3VuZDogZnVuY3Rpb24gKHNsaWRlKSB7CiAgICB2YXIgYmFja2dyb3VuZDsKICAgIHZhciBiZ0NvbG9yOwoKICAgIGlmIChzbGlkZS5jdXJyZW50U3R5bGUpCiAgICAgIGJnQ29sb3IgPSBzbGlkZS5jdXJyZW50U3R5bGVbImJhY2tncm91bmRDb2xvciJdOwogICAgZWxzZSBpZiAoZG9jdW1lbnQuZGVmYXVsdFZpZXcpCiAgICB7CiAgICAgIHZhciBzdHlsZXMgPSBkb2N1bWVudC5kZWZhdWx0Vmlldy5nZXRDb21wdXRlZFN0eWxlKHNsaWRlLG51bGwpOwoKICAgICAgaWYgKHN0eWxlcykKICAgICAgICBiZ0NvbG9yID0gc3R5bGVzLmdldFByb3BlcnR5VmFsdWUoImJhY2tncm91bmQtY29sb3IiKTsKICAgICAgZWxzZSAvLyBicm9rZW4gaW1wbGVtZW50YXRpb24gcHJvYmFibHkgZHVlIFNhZmFyaSBvciBLb25xdWVyb3IKICAgICAgewogICAgICAgIC8vYWxlcnQoImRlZmVjdGl2ZSBpbXBsZW1lbnRhdGlvbiBvZiBnZXRDb21wdXRlZFN0eWxlKCkiKTsKICAgICAgICBiZ0NvbG9yID0gInRyYW5zcGFyZW50IjsKICAgICAgfQogICAgfQogICAgZWxzZQogICAgICBiZ0NvbG9yID09ICJ0cmFuc3BhcmVudCI7CgogICAgaWYgKGJnQ29sb3IgPT0gInRyYW5zcGFyZW50IiB8fAogICAgICAgIGJnQ29sb3IuaW5kZXhPZigicmdiYSIpID49IDAgfHwKICAgICAgICBiZ0NvbG9yLmluZGV4T2YoIm9wYWNpdHkiKSA+PSAwKQogICAgewogICAgICB2YXIgc2xpZGVDbGFzcyA9IHRoaXMuZ2V0X2NsYXNzX2xpc3Qoc2xpZGUpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmJhY2tncm91bmRzLmxlbmd0aDsgaSsrKQogICAgICB7CiAgICAgICAgYmFja2dyb3VuZCA9IHRoaXMuYmFja2dyb3VuZHNbaV07CgogICAgICAgIHZhciBiZ0NsYXNzID0gdGhpcy5nZXRfY2xhc3NfbGlzdChiYWNrZ3JvdW5kKTsKCiAgICAgICAgaWYgKHRoaXMubWF0Y2hpbmdfYmFja2dyb3VuZChzbGlkZUNsYXNzLCBiZ0NsYXNzKSkKICAgICAgICAgIHRoaXMucmVtb3ZlX2NsYXNzKGJhY2tncm91bmQsICJoaWRkZW4iKTsKICAgICAgICBlbHNlCiAgICAgICAgICB0aGlzLmFkZF9jbGFzcyhiYWNrZ3JvdW5kLCAiaGlkZGVuIik7CiAgICAgIH0KICAgIH0KICAgIGVsc2UgLy8gZm9yY2libHkgaGlkZSBhbGwgYmFja2dyb3VuZHMKICAgICAgdGhpcy5oaWRlX2JhY2tncm91bmRzKCk7CiAgfSwKCiAgaGlkZV9iYWNrZ3JvdW5kczogZnVuY3Rpb24gKCkgewogICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmJhY2tncm91bmRzLmxlbmd0aDsgaSsrKQogICAgewogICAgICBiYWNrZ3JvdW5kID0gdGhpcy5iYWNrZ3JvdW5kc1tpXTsKICAgICAgdGhpcy5hZGRfY2xhc3MoYmFja2dyb3VuZCwgImhpZGRlbiIpOwogICAgfQogIH0sCgogIC8vIGNvbXBhcmUgY2xhc3NlcyBmb3Igc2xpZGUgYW5kIGJhY2tncm91bmQKICBtYXRjaGluZ19iYWNrZ3JvdW5kOiBmdW5jdGlvbiAoc2xpZGVDbGFzcywgYmdDbGFzcykgewogICAgdmFyIGksIGNvdW50LCBwYXR0ZXJuLCByZXN1bHQ7CgogICAgLy8gZGVmaW5lIHBhdHRlcm4gYXMgcmVndWxhciBleHByZXNzaW9uCiAgICBwYXR0ZXJuID0gL1x3Ky9nOwoKICAgIC8vIGNoZWNrIGJhY2tncm91bmQgY2xhc3MgbmFtZXMKICAgIHJlc3VsdCA9IGJnQ2xhc3MubWF0Y2gocGF0dGVybik7CgogICAgZm9yIChpID0gY291bnQgPSAwOyBpIDwgcmVzdWx0Lmxlbmd0aDsgaSsrKQogICAgewogICAgICBpZiAocmVzdWx0W2ldID09ICJoaWRkZW4iKQogICAgICAgIGNvbnRpbnVlOwoKICAgICAgaWYgKHJlc3VsdFtpXSA9PSAiYmFja2dyb3VuZCIpCgljb250aW51ZTsKCiAgICAgICsrY291bnQ7CiAgICB9CgogICAgaWYgKGNvdW50ID09IDApICAvLyBkZWZhdWx0IG1hdGNoCiAgICAgIHJldHVybiB0cnVlOwoKICAgIC8vIGNoZWNrIGZvciBtYXRjaGVzIGFuZCBwbGFjZSByZXN1bHQgaW4gYXJyYXkKICAgIHJlc3VsdCA9IHNsaWRlQ2xhc3MubWF0Y2gocGF0dGVybik7CgogICAgLy8gbm93IGNoZWNrIGlmIGRlc2lyZWQgbmFtZSBpcyBwcmVzZW50IGZvciBiYWNrZ3JvdW5kCiAgICBmb3IgKGkgPSBjb3VudCA9IDA7IGkgPCByZXN1bHQubGVuZ3RoOyBpKyspCiAgICB7CiAgICAgIGlmIChyZXN1bHRbaV0gPT0gImhpZGRlbiIpCiAgICAgICAgY29udGludWU7CgogICAgICBpZiAodGhpcy5oYXNfdG9rZW4oYmdDbGFzcywgcmVzdWx0W2ldKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgcmVzaXplZDogZnVuY3Rpb24gKCkgewogICAgIHZhciB3aWR0aCA9IDA7CgogICAgIGlmICggdHlwZW9mKCB3aW5kb3cuaW5uZXJXaWR0aCApID09ICdudW1iZXInICkKICAgICAgIHdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7ICAvLyBOb24gSUUgYnJvd3NlcgogICAgIGVsc2UgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50V2lkdGgpCiAgICAgICB3aWR0aCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aDsgIC8vIElFNgogICAgIGVsc2UgaWYgKGRvY3VtZW50LmJvZHkgJiYgZG9jdW1lbnQuYm9keS5jbGllbnRXaWR0aCkKICAgICAgIHdpZHRoID0gZG9jdW1lbnQuYm9keS5jbGllbnRXaWR0aDsgLy8gSUU0CgogICAgIHZhciBoZWlnaHQgPSAwOwoKICAgICBpZiAoIHR5cGVvZiggd2luZG93LmlubmVySGVpZ2h0ICkgPT0gJ251bWJlcicgKQogICAgICAgaGVpZ2h0ID0gd2luZG93LmlubmVySGVpZ2h0OyAgLy8gTm9uIElFIGJyb3dzZXIKICAgICBlbHNlIGlmIChkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQgJiYgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkKICAgICAgIGhlaWdodCA9IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRIZWlnaHQ7ICAvLyBJRTYKICAgICBlbHNlIGlmIChkb2N1bWVudC5ib2R5ICYmIGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0KQogICAgICAgaGVpZ2h0ID0gZG9jdW1lbnQuYm9keS5jbGllbnRIZWlnaHQ7IC8vIElFNAoKICAgICBpZiAoaGVpZ2h0ICYmICh3aWR0aC9oZWlnaHQgPiAxLjA1KjEwMjQvNzY4KSkKICAgICB7CiAgICAgICB3aWR0aCA9IGhlaWdodCAqIDEwMjQuMC83Njg7CiAgICAgfQoKICAgICAvLyBJRSBmaXJlcyBvbnJlc2l6ZSBldmVuIHdoZW4gb25seSBmb250IHNpemUgaXMgY2hhbmdlZCEKICAgICAvLyBzbyB3ZSBkbyBhIGNoZWNrIHRvIGF2b2lkIGJsb2NraW5nIDwgYW5kID4gYWN0aW9ucwogICAgIGlmICh3aWR0aCAhPSB3M2Nfc2xpZHkubGFzdF93aWR0aCB8fCBoZWlnaHQgIT0gdzNjX3NsaWR5Lmxhc3RfaGVpZ2h0KQogICAgIHsKICAgICAgIGlmICh3aWR0aCA+PSAxMTAwKQogICAgICAgICB3M2Nfc2xpZHkuc2l6ZV9pbmRleCA9IDU7ICAgIC8vIDQKICAgICAgIGVsc2UgaWYgKHdpZHRoID49IDEwMDApCiAgICAgICAgIHczY19zbGlkeS5zaXplX2luZGV4ID0gNDsgICAgLy8gMwogICAgICAgZWxzZSBpZiAod2lkdGggPj0gODAwKQogICAgICAgICB3M2Nfc2xpZHkuc2l6ZV9pbmRleCA9IDM7ICAgIC8vIDIKICAgICAgIGVsc2UgaWYgKHdpZHRoID49IDYwMCkKICAgICAgICAgdzNjX3NsaWR5LnNpemVfaW5kZXggPSAyOyAgICAvLyAxCiAgICAgICBlbHNlIGlmICh3aWR0aCkKICAgICAgICAgdzNjX3NsaWR5LnNpemVfaW5kZXggPSAwOwoKICAgICAgIC8vIGFkZCBpbiBmb250IHNpemUgYWRqdXN0bWVudCBmcm9tIG1ldGEgZWxlbWVudCBlLmcuCiAgICAgICAvLyA8bWV0YSBuYW1lPSJmb250LXNpemUtYWRqdXN0bWVudCIgY29udGVudD0iLTIiIC8+CiAgICAgICAvLyB1c2VmdWwgd2hlbiBzbGlkZXMgaGF2ZSB0b28gbXVjaCBjb250ZW50IDstKQoKICAgICAgIGlmICgwIDw9IHczY19zbGlkeS5zaXplX2luZGV4ICsgdzNjX3NsaWR5LnNpemVfYWRqdXN0bWVudCAmJgogICAgICAgICAgICAgdzNjX3NsaWR5LnNpemVfaW5kZXggKyB3M2Nfc2xpZHkuc2l6ZV9hZGp1c3RtZW50IDwgdzNjX3NsaWR5LnNpemVzLmxlbmd0aCkKICAgICAgICAgdzNjX3NsaWR5LnNpemVfaW5kZXggPSB3M2Nfc2xpZHkuc2l6ZV9pbmRleCArIHczY19zbGlkeS5zaXplX2FkanVzdG1lbnQ7CgogICAgICAgLy8gZW5hYmxlcyBjcm9zcyBicm93c2VyIHVzZSBvZiByZWxhdGl2ZSB3aWR0aC9oZWlnaHQKICAgICAgIC8vIG9uIG9iamVjdCBlbGVtZW50cyBmb3IgdXNlIHdpdGggU1ZHIGFuZCBGbGFzaCBtZWRpYQogICAgICAgdzNjX3NsaWR5LmFkanVzdF9vYmplY3RfZGltZW5zaW9ucyh3aWR0aCwgaGVpZ2h0KTsKCiAgICAgICBpZiAoZG9jdW1lbnQuYm9keS5zdHlsZS5mb250U2l6ZSAhPSB3M2Nfc2xpZHkuc2l6ZXNbdzNjX3NsaWR5LnNpemVfaW5kZXhdKQogICAgICAgewogICAgICAgICBkb2N1bWVudC5ib2R5LnN0eWxlLmZvbnRTaXplID0gdzNjX3NsaWR5LnNpemVzW3czY19zbGlkeS5zaXplX2luZGV4XTsKICAgICAgIH0KCiAgICAgICB3M2Nfc2xpZHkubGFzdF93aWR0aCA9IHdpZHRoOwogICAgICAgdzNjX3NsaWR5Lmxhc3RfaGVpZ2h0ID0gaGVpZ2h0OwoKICAgICAgIC8vIGZvcmNlIHJlZmxvdyB0byB3b3JrIGFyb3VuZCBNb3ppbGxhIGJ1ZwogICAgICAgaWYgKHczY19zbGlkeS5uc19wb3MpCiAgICAgICB7CiAgICAgICAgIHZhciBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CiAgICAgICAgIHczY19zbGlkeS5oaWRlX3NsaWRlKHNsaWRlKTsKICAgICAgICAgdzNjX3NsaWR5LnNob3dfc2xpZGUoc2xpZGUpOwogICAgICAgfQoKICAgICAgIC8vIGZvcmNlIGNvcnJlY3QgcG9zaXRpb25pbmcgb2YgdG9vbGJhcgogICAgICAgdzNjX3NsaWR5LnJlZnJlc2hfdG9vbGJhcigyMDApOwogICAgIH0KICB9LAoKICBzY3JvbGxlZDogZnVuY3Rpb24gKCkgewogICAgaWYgKHczY19zbGlkeS50b29sYmFyICYmICF3M2Nfc2xpZHkubnNfcG9zICYmICF3M2Nfc2xpZHkuaWU3KQogICAgewogICAgICB3M2Nfc2xpZHkuaGFja19vZmZzZXQgPSB3M2Nfc2xpZHkuc2Nyb2xsX3hfb2Zmc2V0KCk7CiAgICAgIC8vIGhpZGUgdG9vbGJhcgogICAgICB3M2Nfc2xpZHkudG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKICAgICAgLy8gbWFrZSBpdCByZWFwcGVhciBsYXRlcgogICAgICBpZiAodzNjX3NsaWR5LnNjcm9sbGhhY2sgPT0gMCAmJiAhdzNjX3NsaWR5LnZpZXdfYWxsKQogICAgICB7CiAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7dzNjX3NsaWR5LnNob3dfdG9vbGJhcigpOyB9LCAxMDAwKTsKICAgICAgICB3M2Nfc2xpZHkuc2Nyb2xsaGFjayA9IDE7CiAgICAgIH0KICAgIH0KICB9LAoKICBoaWRlX3Rvb2xiYXI6IGZ1bmN0aW9uICgpIHsKICAgIHczY19zbGlkeS5hZGRfY2xhc3ModzNjX3NsaWR5LnRvb2xiYXIsICJoaWRkZW4iKTsKICAgIHdpbmRvdy5mb2N1cygpOwogIH0sCgogIC8vIHVzZWQgdG8gZW5zdXJlIElFIHJlZnJlc2hlcyB0b29sYmFyIGluIGNvcnJlY3QgcG9zaXRpb24KICByZWZyZXNoX3Rvb2xiYXI6IGZ1bmN0aW9uIChpbnRlcnZhbCkgewogICAgaWYgKCF3M2Nfc2xpZHkubnNfcG9zICYmICF3M2Nfc2xpZHkuaWU3KQogICAgewogICAgICB3M2Nfc2xpZHkuaGlkZV90b29sYmFyKCk7CiAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge3czY19zbGlkeS5zaG93X3Rvb2xiYXIoKTsgfSwgaW50ZXJ2YWwpOwogICAgfQogIH0sCgogIC8vIHJlc3RvcmVzIHRvb2xiYXIgYWZ0ZXIgc2hvcnQgZGVsYXkKICBzaG93X3Rvb2xiYXI6IGZ1bmN0aW9uICgpIHsKICAgIGlmICh3M2Nfc2xpZHkud2FudF90b29sYmFyKQogICAgewogICAgICB3M2Nfc2xpZHkudG9vbGJhci5zdHlsZS5kaXNwbGF5ID0gImJsb2NrIjsKCiAgICAgIGlmICghdzNjX3NsaWR5Lm5zX3BvcykKICAgICAgewogICAgICAgIC8vIGFkanVzdCBwb3NpdGlvbiB0byBhbGxvdyBmb3Igc2Nyb2xsaW5nCiAgICAgICAgdmFyIHhvZmZzZXQgPSB3M2Nfc2xpZHkuc2Nyb2xsX3hfb2Zmc2V0KCk7CiAgICAgICAgdzNjX3NsaWR5LnRvb2xiYXIuc3R5bGUubGVmdCA9IHhvZmZzZXQ7CiAgICAgICAgdzNjX3NsaWR5LnRvb2xiYXIuc3R5bGUucmlnaHQgPSB4b2Zmc2V0OwoKICAgICAgICAvLyBkZXRlcm1pbmUgdmVydGljYWwgc2Nyb2xsIG9mZnNldAogICAgICAgIC8vdmFyIHlvZmZzZXQgPSBzY3JvbGxZT2Zmc2V0KCk7CgogICAgICAgIC8vIGJvdHRvbSBpcyBkb2MgaGVpZ2h0IC0gd2luZG93IGhlaWdodCAtIHNjcm9sbCBvZmZzZXQKICAgICAgICAvL3ZhciBib3R0b20gPSBkb2N1bWVudEhlaWdodCgpIC0gbGFzdEhlaWdodCAtIHlvZmZzZXQKCiAgICAgICAgLy9pZiAoeW9mZnNldCA+IDAgfHwgZG9jdW1lbnRIZWlnaHQoKSA+IGxhc3RIZWlnaHQpCiAgICAgICAgLy8gICBib3R0b20gKz0gMTY7ICAvLyBhbGxvdyBmb3IgaGVpZ2h0IG9mIHNjcm9sbGJhcgoKICAgICAgICB3M2Nfc2xpZHkudG9vbGJhci5zdHlsZS5ib3R0b20gPSAwOyAvL2JvdHRvbTsKICAgICAgfQoKICAgICAgdzNjX3NsaWR5LnJlbW92ZV9jbGFzcyh3M2Nfc2xpZHkudG9vbGJhciwgImhpZGRlbiIpOwogICAgfQoKICAgIHczY19zbGlkeS5zY3JvbGxoYWNrID0gMDsKCgogICAgLy8gc2V0IHRoZSBrZXlib2FyZCBmb2N1cyB0byB0aGUgaGVscCBsaW5rIG9uIHRoZQogICAgLy8gdG9vbGJhciB0byBlbnN1cmUgdGhhdCBkb2N1bWVudCBoYXMgdGhlIGZvY3VzCiAgICAvLyBJRSBkb2Vzbid0IGFsd2F5cyB3b3JrIHdpdGggd2luZG93LmZvY3VzKCkKICAgIC8vIGFuZCB0aGlzIGhhY2sgaGFzIGJlbmVmaXQgb2YgRW50ZXIgZm9yIGhlbHAKCiAgICB0cnkKICAgIHsKICAgICAgaWYgKCF3M2Nfc2xpZHkub3BlcmEpCiAgICAgICAgdzNjX3NsaWR5LmhlbHBfYW5jaG9yLmZvY3VzKCk7CiAgICB9CiAgICBjYXRjaCAoZSkKICAgIHsKICAgIH0KICB9LAoKLy8gaW52b2tlZCB2aWEgRiBrZXkKICB0b2dnbGVfdG9vbGJhcjogZnVuY3Rpb24gKCkgewogICAgaWYgKCF3M2Nfc2xpZHkudmlld19hbGwpCiAgICB7CiAgICAgIGlmICh3M2Nfc2xpZHkuaGFzX2NsYXNzKHczY19zbGlkeS50b29sYmFyLCAiaGlkZGVuIikpCiAgICAgIHsKICAgICAgICB3M2Nfc2xpZHkucmVtb3ZlX2NsYXNzKHczY19zbGlkeS50b29sYmFyLCAiaGlkZGVuIikKICAgICAgICB3M2Nfc2xpZHkud2FudF90b29sYmFyID0gMTsKICAgICAgfQogICAgICBlbHNlCiAgICAgIHsKICAgICAgICB3M2Nfc2xpZHkuYWRkX2NsYXNzKHczY19zbGlkeS50b29sYmFyLCAiaGlkZGVuIikKICAgICAgICB3M2Nfc2xpZHkud2FudF90b29sYmFyID0gMDsKICAgICAgfQogICAgfQogIH0sCgogIHNjcm9sbF94X29mZnNldDogZnVuY3Rpb24gKCkgewogICAgaWYgKHdpbmRvdy5wYWdlWE9mZnNldCkKICAgICAgcmV0dXJuIHNlbGYucGFnZVhPZmZzZXQ7CgogICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiAKICAgICAgICAgICAgIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxMZWZ0KQogICAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbExlZnQ7CgogICAgaWYgKGRvY3VtZW50LmJvZHkpCiAgICAgIHJldHVybiBkb2N1bWVudC5ib2R5LnNjcm9sbExlZnQ7CgogICAgcmV0dXJuIDA7CiAgfSwKCiAgc2Nyb2xsX3lfb2Zmc2V0OiBmdW5jdGlvbiAoKSB7CiAgICBpZiAod2luZG93LnBhZ2VZT2Zmc2V0KQogICAgICByZXR1cm4gc2VsZi5wYWdlWU9mZnNldDsKCiAgICBpZiAoZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50ICYmIAogICAgICAgICAgICAgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnNjcm9sbFRvcCkKICAgICAgcmV0dXJuIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zY3JvbGxUb3A7CgogICAgaWYgKGRvY3VtZW50LmJvZHkpCiAgICAgIHJldHVybiBkb2N1bWVudC5ib2R5LnNjcm9sbFRvcDsKCiAgICByZXR1cm4gMDsKICB9LAoKICAvLyBsb29raW5nIGZvciBhIHdheSB0byBkZXRlcm1pbmUgaGVpZ2h0IG9mIHNsaWRlIGNvbnRlbnQKICAvLyB0aGUgc2xpZGUgaXRzZWxmIGlzIHNldCB0byB0aGUgaGVpZ2h0IG9mIHRoZSB3aW5kb3cKICBvcHRpbWl6ZV9mb250X3NpemU6IGZ1bmN0aW9uICgpIHsKICAgIHZhciBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CgogICAgLy92YXIgZGggPSBkb2N1bWVudEhlaWdodCgpOyAvL2dldERvY0hlaWdodChkb2N1bWVudCk7CiAgICB2YXIgZGggPSBzbGlkZS5zY3JvbGxIZWlnaHQ7CiAgICB2YXIgd2ggPSBnZXRXaW5kb3dIZWlnaHQoKTsKICAgIHZhciB1ID0gMTAwICogZGggLyB3aDsKCiAgICBhbGVydCgid2luZG93IHV0aWxpemF0aW9uID0gIiArIHUgKyAiJSAoZG9jICIKICAgICAgKyBkaCArICIgd2luICIgKyB3aCArICIpIik7CiAgfSwKCiAgLy8gZnJvbSBkb2N1bWVudCBvYmplY3QKICBnZXRfZG9jX2hlaWdodDogZnVuY3Rpb24gKGRvYykgewogICAgaWYgKCFkb2MpCiAgICAgIGRvYyA9IGRvY3VtZW50OwoKICAgIGlmIChkb2MgJiYgZG9jLmJvZHkgJiYgZG9jLmJvZHkub2Zmc2V0SGVpZ2h0KQogICAgICByZXR1cm4gZG9jLmJvZHkub2Zmc2V0SGVpZ2h0OyAgLy8gbnMvZ2Vja28gc3ludGF4CgogICAgaWYgKGRvYyAmJiBkb2MuYm9keSAmJiBkb2MuYm9keS5zY3JvbGxIZWlnaHQpCiAgICAgIHJldHVybiBkb2MuYm9keS5zY3JvbGxIZWlnaHQ7CgogICAgYWxlcnQoImNvdWxkbid0IGRldGVybWluZSBkb2N1bWVudCBoZWlnaHQiKTsKICB9LAoKICBnZXRfd2luZG93X2hlaWdodDogZnVuY3Rpb24gKCkgewogICAgaWYgKCB0eXBlb2YoIHdpbmRvdy5pbm5lckhlaWdodCApID09ICdudW1iZXInICkKICAgICAgcmV0dXJuIHdpbmRvdy5pbm5lckhlaWdodDsgIC8vIE5vbiBJRSBicm93c2VyCgogICAgaWYgKGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCAmJiBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuY2xpZW50SGVpZ2h0KQogICAgICByZXR1cm4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodDsgIC8vIElFNgoKICAgIGlmIChkb2N1bWVudC5ib2R5ICYmIGRvY3VtZW50LmJvZHkuY2xpZW50SGVpZ2h0KQogICAgICByZXR1cm4gZG9jdW1lbnQuYm9keS5jbGllbnRIZWlnaHQ7IC8vIElFNAogIH0sCgogIGRvY3VtZW50X2hlaWdodDogZnVuY3Rpb24gKCkgewogICAgdmFyIHNoLCBvaDsKCiAgICBzaCA9IGRvY3VtZW50LmJvZHkuc2Nyb2xsSGVpZ2h0OwogICAgb2ggPSBkb2N1bWVudC5ib2R5Lm9mZnNldEhlaWdodDsKCiAgICBpZiAoc2ggJiYgb2gpCiAgICB7CiAgICAgIHJldHVybiAoc2ggPiBvaCA/IHNoIDogb2gpOwogICAgfQoKICAgIC8vIG5vIGlkZWEhCiAgICByZXR1cm4gMDsKICB9LAoKICBzbWFsbGVyOiBmdW5jdGlvbiAoKSB7CiAgICBpZiAodzNjX3NsaWR5LnNpemVfaW5kZXggPiAwKQogICAgewogICAgICAtLXczY19zbGlkeS5zaXplX2luZGV4OwogICAgfQoKICAgIHczY19zbGlkeS50b29sYmFyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICBkb2N1bWVudC5ib2R5LnN0eWxlLmZvbnRTaXplID0gdzNjX3NsaWR5LnNpemVzW3czY19zbGlkeS5zaXplX2luZGV4XTsKICAgIHZhciBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CiAgICB3M2Nfc2xpZHkuaGlkZV9zbGlkZShzbGlkZSk7CiAgICB3M2Nfc2xpZHkuc2hvd19zbGlkZShzbGlkZSk7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHt3M2Nfc2xpZHkuc2hvd190b29sYmFyKCk7IH0sIDUwKTsKICB9LAoKICBiaWdnZXI6IGZ1bmN0aW9uICgpIHsKICAgIGlmICh3M2Nfc2xpZHkuc2l6ZV9pbmRleCA8IHczY19zbGlkeS5zaXplcy5sZW5ndGggLSAxKQogICAgewogICAgICArK3czY19zbGlkeS5zaXplX2luZGV4OwogICAgfQoKICAgIHczY19zbGlkeS50b29sYmFyLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICBkb2N1bWVudC5ib2R5LnN0eWxlLmZvbnRTaXplID0gdzNjX3NsaWR5LnNpemVzW3czY19zbGlkeS5zaXplX2luZGV4XTsKICAgIHZhciBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CiAgICB3M2Nfc2xpZHkuaGlkZV9zbGlkZShzbGlkZSk7CiAgICB3M2Nfc2xpZHkuc2hvd19zbGlkZShzbGlkZSk7CiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHt3M2Nfc2xpZHkuc2hvd190b29sYmFyKCk7IH0sIDUwKTsKICB9LAoKICAvLyBlbmFibGVzIGNyb3NzIGJyb3dzZXIgdXNlIG9mIHJlbGF0aXZlIHdpZHRoL2hlaWdodAogIC8vIG9uIG9iamVjdCBlbGVtZW50cyBmb3IgdXNlIHdpdGggU1ZHIGFuZCBGbGFzaCBtZWRpYQogIC8vIHdpdGggdGhhbmtzIHRvIEl2YW4gSGVybWFuIGZvciB0aGUgc3VnZ2VzdGlvbgogIGFkanVzdF9vYmplY3RfZGltZW5zaW9uczogZnVuY3Rpb24gKHdpZHRoLCBoZWlnaHQpIHsKICAgIGZvciggdmFyIGkgPSAwOyBpIDwgdzNjX3NsaWR5Lm9iamVjdHMubGVuZ3RoOyBpKysgKQogICAgewogICAgICB2YXIgb2JqID0gdGhpcy5vYmplY3RzW2ldOwogICAgICB2YXIgbWltZVR5cGUgPSBvYmouZ2V0QXR0cmlidXRlKCJ0eXBlIik7CgogICAgICBpZiAobWltZVR5cGUgPT0gImltYWdlL3N2Zyt4bWwiIHx8IG1pbWVUeXBlID09ICJhcHBsaWNhdGlvbi94LXNob2Nrd2F2ZS1mbGFzaCIpCiAgICAgIHsKICAgICAgICBpZiAoICFvYmouaW5pdGlhbFdpZHRoICkgCiAgICAgICAgICBvYmouaW5pdGlhbFdpZHRoID0gb2JqLmdldEF0dHJpYnV0ZSgid2lkdGgiKTsKCiAgICAgICAgaWYgKCAhb2JqLmluaXRpYWxIZWlnaHQgKSAKICAgICAgICAgIG9iai5pbml0aWFsSGVpZ2h0ID0gb2JqLmdldEF0dHJpYnV0ZSgiaGVpZ2h0Iik7CgogICAgICAgIGlmICggb2JqLmluaXRpYWxXaWR0aCAmJiBvYmouaW5pdGlhbFdpZHRoLmNoYXJBdChvYmouaW5pdGlhbFdpZHRoLmxlbmd0aC0xKSA9PSAiJSIgKQogICAgICAgIHsKICAgICAgICAgIHZhciB3ID0gcGFyc2VJbnQob2JqLmluaXRpYWxXaWR0aC5zbGljZSgwLCBvYmouaW5pdGlhbFdpZHRoLmxlbmd0aC0xKSk7CiAgICAgICAgICB2YXIgbmV3VyA9IHdpZHRoICogKHcvMTAwLjApOwogICAgICAgICAgb2JqLnNldEF0dHJpYnV0ZSgid2lkdGgiLG5ld1cpOwogICAgICAgIH0KCiAgICAgICAgaWYgKCBvYmouaW5pdGlhbEhlaWdodCAmJgogICAgICAgICAgICAgb2JqLmluaXRpYWxIZWlnaHQuY2hhckF0KG9iai5pbml0aWFsSGVpZ2h0Lmxlbmd0aC0xKSA9PSAiJSIgKQogICAgICAgIHsKICAgICAgICAgIHZhciBoID0gcGFyc2VJbnQob2JqLmluaXRpYWxIZWlnaHQuc2xpY2UoMCwgb2JqLmluaXRpYWxIZWlnaHQubGVuZ3RoLTEpKTsKICAgICAgICAgIHZhciBuZXdIID0gaGVpZ2h0ICogKGgvMTAwLjApOwogICAgICAgICAgb2JqLnNldEF0dHJpYnV0ZSgiaGVpZ2h0IiwgbmV3SCk7CiAgICAgICAgfQogICAgICB9CiAgICB9CiAgfSwKCiAgLy8gbmVlZGVkIGZvciBPcGVyYSB0byBpbmhpYml0IGRlZmF1bHQgYmVoYXZpb3IKICAvLyBzaW5jZSBPcGVyYSBkZWxpdmVycyBrZXlQcmVzcyBldmVuIGlmIGtleURvd24KICAvLyB3YXMgY2FuY2VsbGVkCiAga2V5X3ByZXNzOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIGlmICghZXZlbnQpCiAgICAgIGV2ZW50ID0gd2luZG93LmV2ZW50OwoKICAgIGlmICghdzNjX3NsaWR5LmtleV93YW50ZWQpCiAgICAgIHJldHVybiB3M2Nfc2xpZHkuY2FuY2VsKGV2ZW50KTsKCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICAvLyAgU2VlIGUuZy4gaHR0cDovL3d3dy5xdWlya3Ntb2RlLm9yZy9qcy9ldmVudHMva2V5cy5odG1sIGZvciBrZXljb2RlcwogIGtleV9kb3duOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIHZhciBrZXksIHRhcmdldCwgdGFnOwoKICAgIHczY19zbGlkeS5rZXlfd2FudGVkID0gdHJ1ZTsKCiAgICBpZiAoIWV2ZW50KQogICAgICBldmVudCA9IHdpbmRvdy5ldmVudDsKCiAgICAvLyBrbHVkZ2UgYXJvdW5kIE5TL0lFIGRpZmZlcmVuY2VzIAogICAgaWYgKHdpbmRvdy5ldmVudCkKICAgIHsKICAgICAga2V5ID0gd2luZG93LmV2ZW50LmtleUNvZGU7CiAgICAgIHRhcmdldCA9IHdpbmRvdy5ldmVudC5zcmNFbGVtZW50OwogICAgfQogICAgZWxzZSBpZiAoZXZlbnQud2hpY2gpCiAgICB7CiAgICAgIGtleSA9IGV2ZW50LndoaWNoOwogICAgICB0YXJnZXQgPSBldmVudC50YXJnZXQ7CiAgICB9CiAgICBlbHNlCiAgICAgIHJldHVybiB0cnVlOyAvLyBZaWtlcyEgdW5rbm93biBicm93c2VyCgogICAgLy8gaWdub3JlIGV2ZW50IGlmIGtleSB2YWx1ZSBpcyB6ZXJvCiAgICAvLyBhcyBmb3IgYWx0IG9uIE9wZXJhIGFuZCBLb25xdWVyb3IKICAgIGlmICgha2V5KQogICAgICAgcmV0dXJuIHRydWU7CgogICAgLy8gYXZvaWQgaW50ZXJmZXJpbmcgd2l0aCBrZXlzdHJva2UKICAgIC8vIGJlaGF2aW9yIGZvciBub24tc2xpZHkgY2hyb21lIGVsZW1lbnRzCiAgICBpZiAoIXczY19zbGlkeS5zbGlkeV9jaHJvbWUodGFyZ2V0KSAmJgogICAgICAgIHczY19zbGlkeS5zcGVjaWFsX2VsZW1lbnQodGFyZ2V0KSkKICAgICAgcmV0dXJuIHRydWU7CgogICAgLy8gY2hlY2sgZm9yIGNvbmN1cnJlbnQgY29udHJvbC9jb21tYW5kL2FsdCBrZXkKICAgIC8vIGJ1dCBhcmUgdGhlc2Ugb25seSBwcmVzZW50IG9uIG1vdXNlIGV2ZW50cz8KCiAgICBpZiAoZXZlbnQuY3RybEtleSB8fCBldmVudC5hbHRLZXkgfHwgZXZlbnQubWV0YUtleSkKICAgICAgIHJldHVybiB0cnVlOwoKICAgIC8vIGRpc21pc3MgdGFibGUgb2YgY29udGVudHMgaWYgdmlzaWJsZQogICAgaWYgKHczY19zbGlkeS5pc19zaG93bl90b2MoKSAmJiBrZXkgIT0gOSAmJiBrZXkgIT0gMTYgJiYga2V5ICE9IDM4ICYmIGtleSAhPSA0MCkKICAgIHsKICAgICAgdzNjX3NsaWR5LmhpZGVfdGFibGVfb2ZfY29udGVudHModHJ1ZSk7CgogICAgICBpZiAoa2V5ID09IDI3IHx8IGtleSA9PSA4NCB8fCBrZXkgPT0gNjcpCiAgICAgICAgcmV0dXJuIHczY19zbGlkeS5jYW5jZWwoZXZlbnQpOwogICAgfQoKICAgIGlmIChrZXkgPT0gMzQpIC8vIFBhZ2UgRG93bgogICAgewogICAgICBpZiAodzNjX3NsaWR5LnZpZXdfYWxsKQogICAgICAgIHJldHVybiB0cnVlOwoKICAgICAgdzNjX3NsaWR5Lm5leHRfc2xpZGUoZmFsc2UpOwogICAgICByZXR1cm4gdzNjX3NsaWR5LmNhbmNlbChldmVudCk7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgPT0gMzMpIC8vIFBhZ2UgVXAKICAgIHsKICAgICAgaWYgKHczY19zbGlkeS52aWV3X2FsbCkKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgIHczY19zbGlkeS5wcmV2aW91c19zbGlkZShmYWxzZSk7CiAgICAgIHJldHVybiB3M2Nfc2xpZHkuY2FuY2VsKGV2ZW50KTsKICAgIH0KICAgIGVsc2UgaWYgKGtleSA9PSAzMikgLy8gc3BhY2UgYmFyCiAgICB7CiAgICAgIHczY19zbGlkeS5uZXh0X3NsaWRlKHRydWUpOwogICAgICByZXR1cm4gdzNjX3NsaWR5LmNhbmNlbChldmVudCk7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgPT0gMzcpIC8vIExlZnQgYXJyb3cKICAgIHsKICAgICAgdzNjX3NsaWR5LnByZXZpb3VzX3NsaWRlKCFldmVudC5zaGlmdEtleSk7CiAgICAgIHJldHVybiB3M2Nfc2xpZHkuY2FuY2VsKGV2ZW50KTsKICAgIH0KICAgIGVsc2UgaWYgKGtleSA9PSAzNikgLy8gSG9tZQogICAgewogICAgICB3M2Nfc2xpZHkuZmlyc3Rfc2xpZGUoKTsKICAgICAgcmV0dXJuIHczY19zbGlkeS5jYW5jZWwoZXZlbnQpOwogICAgfQogICAgZWxzZSBpZiAoa2V5ID09IDM1KSAvLyBFbmQKICAgIHsKICAgICAgdzNjX3NsaWR5Lmxhc3Rfc2xpZGUoKTsKICAgICAgcmV0dXJuIHczY19zbGlkeS5jYW5jZWwoZXZlbnQpOwogICAgfQogICAgZWxzZSBpZiAoa2V5ID09IDM5KSAvLyBSaWdodCBhcnJvdwogICAgewogICAgICB3M2Nfc2xpZHkubmV4dF9zbGlkZSghZXZlbnQuc2hpZnRLZXkpOwogICAgICByZXR1cm4gdzNjX3NsaWR5LmNhbmNlbChldmVudCk7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgPT0gMTMpIC8vIEVudGVyCiAgICB7CiAgICAgIGlmICh3M2Nfc2xpZHkub3V0bGluZSkKICAgICAgewogICAgICAgIGlmICh3M2Nfc2xpZHkub3V0bGluZS52aXNpYmxlKQogICAgICAgICAgdzNjX3NsaWR5LmZvbGQodzNjX3NsaWR5Lm91dGxpbmUpOwogICAgICAgIGVsc2UKICAgICAgICAgIHczY19zbGlkeS51bmZvbGQodzNjX3NsaWR5Lm91dGxpbmUpOwogICAgICAgICAgCiAgICAgICByZXR1cm4gdzNjX3NsaWR5LmNhbmNlbChldmVudCk7CiAgICAgIH0KICAgIH0KICAgIGVsc2UgaWYgKGtleSA9PSAxODgpICAvLyA8IGZvciBzbWFsbGVyIGZvbnRzCiAgICB7CiAgICAgIHczY19zbGlkeS5zbWFsbGVyKCk7CiAgICAgIHJldHVybiB3M2Nfc2xpZHkuY2FuY2VsKGV2ZW50KTsKICAgIH0KICAgIGVsc2UgaWYgKGtleSA9PSAxOTApICAvLyA+IGZvciBsYXJnZXIgZm9udHMKICAgIHsKICAgICAgdzNjX3NsaWR5LmJpZ2dlcigpOwogICAgICByZXR1cm4gdzNjX3NsaWR5LmNhbmNlbChldmVudCk7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgPT0gMTg5IHx8IGtleSA9PSAxMDkpICAvLyAtIGZvciBzbWFsbGVyIGZvbnRzCiAgICB7CiAgICAgIHczY19zbGlkeS5zbWFsbGVyKCk7CiAgICAgIHJldHVybiB3M2Nfc2xpZHkuY2FuY2VsKGV2ZW50KTsKICAgIH0KICAgIGVsc2UgaWYgKGtleSA9PSAxODcgfHwga2V5ID09IDE5MSB8fCBrZXkgPT0gMTA3KSAgLy8gPSArICBmb3IgbGFyZ2VyIGZvbnRzCiAgICB7CiAgICAgIHczY19zbGlkeS5iaWdnZXIoKTsKICAgICAgcmV0dXJuIHczY19zbGlkeS5jYW5jZWwoZXZlbnQpOwogICAgfQogICAgZWxzZSBpZiAoa2V5ID09IDgzKSAgLy8gUyBmb3Igc21hbGxlciBmb250cwogICAgewogICAgICB3M2Nfc2xpZHkuc21hbGxlcigpOwogICAgICByZXR1cm4gdzNjX3NsaWR5LmNhbmNlbChldmVudCk7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgPT0gNjYpICAvLyBCIGZvciBsYXJnZXIgZm9udHMKICAgIHsKICAgICAgdzNjX3NsaWR5LmJpZ2dlcigpOwogICAgICByZXR1cm4gdzNjX3NsaWR5LmNhbmNlbChldmVudCk7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgPT0gOTApICAvLyBaIGZvciBsYXN0IHNsaWRlCiAgICB7CiAgICAgIHczY19zbGlkeS5sYXN0X3NsaWRlKCk7CiAgICAgIHJldHVybiB3M2Nfc2xpZHkuY2FuY2VsKGV2ZW50KTsKICAgIH0KICAgIGVsc2UgaWYgKGtleSA9PSA3MCkgIC8vIEYgZm9yIHRvZ2dsZSB0b29sYmFyCiAgICB7CiAgICAgIHczY19zbGlkeS50b2dnbGVfdG9vbGJhcigpOwogICAgICByZXR1cm4gdzNjX3NsaWR5LmNhbmNlbChldmVudCk7CiAgICB9CiAgICBlbHNlIGlmIChrZXkgPT0gNjUpICAvLyBBIGZvciB0b2dnbGUgdmlldyBzaW5nbGUvYWxsIHNsaWRlcwogICAgewogICAgICB3M2Nfc2xpZHkudG9nZ2xlX3ZpZXcoKTsKICAgICAgcmV0dXJuIHczY19zbGlkeS5jYW5jZWwoZXZlbnQpOwogICAgfQogICAgZWxzZSBpZiAoa2V5ID09IDc1KSAgLy8gdG9nZ2xlIGFjdGlvbiBvZiBsZWZ0IGNsaWNrIGZvciBuZXh0IHBhZ2UKICAgIHsKICAgICAgdzNjX3NsaWR5Lm1vdXNlX2NsaWNrX2VuYWJsZWQgPSAhdzNjX3NsaWR5Lm1vdXNlX2NsaWNrX2VuYWJsZWQ7CiAgICAgIHZhciBhbGVydF9tc2cgPSAodzNjX3NsaWR5Lm1vdXNlX2NsaWNrX2VuYWJsZWQgPwogICAgICAgICAgICAgICAgImVuYWJsZWQiIDogImRpc2FibGVkIikgKyAgIiBtb3VzZSBjbGljayBhZHZhbmNlIjsKCiAgICAgIGFsZXJ0KHczY19zbGlkeS5sb2NhbGl6ZShhbGVydF9tc2cpKTsKICAgICAgcmV0dXJuIHczY19zbGlkeS5jYW5jZWwoZXZlbnQpOwogICAgfQogICAgZWxzZSBpZiAoa2V5ID09IDg0IHx8IGtleSA9PSA2NykgIC8vIFQgb3IgQyBmb3IgdGFibGUgb2YgY29udGVudHMKICAgIHsKICAgICAgaWYgKHczY19zbGlkeS50b2MpCiAgICAgICAgdzNjX3NsaWR5LnRvZ2dsZV90YWJsZV9vZl9jb250ZW50cygpOwoKICAgICAgcmV0dXJuIHczY19zbGlkeS5jYW5jZWwoZXZlbnQpOwogICAgfQogICAgZWxzZSBpZiAoa2V5ID09IDcyKSAvLyBIIGZvciBoZWxwCiAgICB7CiAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IHczY19zbGlkeS5oZWxwX3BhZ2U7CiAgICAgIHJldHVybiB3M2Nfc2xpZHkuY2FuY2VsKGV2ZW50KTsKICAgIH0KICAgIC8vZWxzZSBhbGVydCgia2V5IGNvZGUgaXMgIisga2V5KTsKCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICAvLyBzYWZlIGZvciBib3RoIHRleHQvaHRtbCBhbmQgYXBwbGljYXRpb24veGh0bWwreG1sCiAgY3JlYXRlX2VsZW1lbnQ6IGZ1bmN0aW9uIChuYW1lKSB7CiAgICBpZiAodGhpcy54aHRtbCAmJiAodHlwZW9mIGRvY3VtZW50LmNyZWF0ZUVsZW1lbnROUyAhPSAndW5kZWZpbmVkJykpCiAgICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVFbGVtZW50TlMoImh0dHA6Ly93d3cudzMub3JnLzE5OTkveGh0bWwiLCBuYW1lKQoKICAgIHJldHVybiBkb2N1bWVudC5jcmVhdGVFbGVtZW50KG5hbWUpOwogIH0sCgogIGdldF9lbGVtZW50X3N0eWxlOiBmdW5jdGlvbiAoZWxlbSwgSUVTdHlsZVByb3AsIENTU1N0eWxlUHJvcCkgewogICAgaWYgKGVsZW0uY3VycmVudFN0eWxlKQogICAgewogICAgICByZXR1cm4gZWxlbS5jdXJyZW50U3R5bGVbSUVTdHlsZVByb3BdOwogICAgfQogICAgZWxzZSBpZiAod2luZG93LmdldENvbXB1dGVkU3R5bGUpCiAgICB7CiAgICAgIHZhciBjb21wU3R5bGUgPSB3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShlbGVtLCAiIik7CiAgICAgIHJldHVybiBjb21wU3R5bGUuZ2V0UHJvcGVydHlWYWx1ZShDU1NTdHlsZVByb3ApOwogICAgfQogICAgcmV0dXJuICIiOwogIH0sCgogIC8vIHRoZSBzdHJpbmcgc3RyIGlzIGEgd2hpdGVzcGFjZSBzZXBhcmF0ZWQgbGlzdCBvZiB0b2tlbnMKICAvLyB0ZXN0IGlmIHN0ciBjb250YWlucyBhIHBhcnRpY3VsYXIgdG9rZW4sIGUuZy4gInNsaWRlIgogIGhhc190b2tlbjogZnVuY3Rpb24gKHN0ciwgdG9rZW4pIHsKICAgIGlmIChzdHIpCiAgICB7CiAgICAgIC8vIGRlZmluZSBwYXR0ZXJuIGFzIHJlZ3VsYXIgZXhwcmVzc2lvbgogICAgICB2YXIgcGF0dGVybiA9IC9cdysvZzsKCiAgICAgIC8vIGNoZWNrIGZvciBtYXRjaGVzCiAgICAgIC8vIHBsYWNlIHJlc3VsdCBpbiBhcnJheQogICAgICB2YXIgcmVzdWx0ID0gc3RyLm1hdGNoKHBhdHRlcm4pOwoKICAgICAgLy8gbm93IGNoZWNrIGlmIGRlc2lyZWQgdG9rZW4gaXMgcHJlc2VudAogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHJlc3VsdC5sZW5ndGg7IGkrKykKICAgICAgewogICAgICAgIGlmIChyZXN1bHRbaV0gPT0gdG9rZW4pCiAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBmYWxzZTsKICB9LAoKICBnZXRfY2xhc3NfbGlzdDogZnVuY3Rpb24gKGVsZW1lbnQpIHsKICAgIGlmICh0eXBlb2YgZWxlbWVudC5jbGFzc05hbWUgIT0gJ3VuZGVmaW5lZCcpCiAgICAgIHJldHVybiBlbGVtZW50LmNsYXNzTmFtZTsKCiAgICByZXR1cm4gZWxlbWVudC5nZXRBdHRyaWJ1dGUoImNsYXNzIik7CiAgfSwKCiAgaGFzX2NsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSkgewogICAgaWYgKGVsZW1lbnQubm9kZVR5cGUgIT0gMSkKICAgICAgcmV0dXJuIGZhbHNlOwoKICAgIHZhciByZWdleHAgPSBuZXcgUmVnRXhwKCIoXnwgKSIgKyBuYW1lICsgIlxXKiIpOwoKICAgIGlmICh0eXBlb2YgZWxlbWVudC5jbGFzc05hbWUgIT0gJ3VuZGVmaW5lZCcpCiAgICAgIHJldHVybiByZWdleHAudGVzdChlbGVtZW50LmNsYXNzTmFtZSk7CgogICAgcmV0dXJuIHJlZ2V4cC50ZXN0KGVsZW1lbnQuZ2V0QXR0cmlidXRlKCJjbGFzcyIpKTsKICB9LAoKICByZW1vdmVfY2xhc3M6IGZ1bmN0aW9uIChlbGVtZW50LCBuYW1lKSB7CiAgICB2YXIgcmVnZXhwID0gbmV3IFJlZ0V4cCgiKF58ICkiICsgbmFtZSArICJcVyoiKTsKICAgIHZhciBjbHN2YWwgPSAiIjsKCiAgICBpZiAodHlwZW9mIGVsZW1lbnQuY2xhc3NOYW1lICE9ICd1bmRlZmluZWQnKQogICAgewogICAgICBjbHN2YWwgPSBlbGVtZW50LmNsYXNzTmFtZTsKCiAgICAgIGlmIChjbHN2YWwpCiAgICAgIHsKICAgICAgICBjbHN2YWwgPSBjbHN2YWwucmVwbGFjZShyZWdleHAsICIiKTsKICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGNsc3ZhbDsKICAgICAgfQogICAgfQogICAgZWxzZQogICAgewogICAgICBjbHN2YWwgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgiY2xhc3MiKTsKCiAgICAgIGlmIChjbHN2YWwpCiAgICAgIHsKICAgICAgICBjbHN2YWwgPSBjbHN2YWwucmVwbGFjZShyZWdleHAsICIiKTsKICAgICAgICBlbGVtZW50LnNldEF0dHJpYnV0ZSgiY2xhc3MiLCBjbHN2YWwpOwogICAgICB9CiAgICB9CiAgfSwKCiAgYWRkX2NsYXNzOiBmdW5jdGlvbiAoZWxlbWVudCwgbmFtZSkgewogICAgaWYgKCF0aGlzLmhhc19jbGFzcyhlbGVtZW50LCBuYW1lKSkKICAgIHsKICAgICAgaWYgKHR5cGVvZiBlbGVtZW50LmNsYXNzTmFtZSAhPSAndW5kZWZpbmVkJykKICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSArPSAiICIgKyBuYW1lOwogICAgICBlbHNlCiAgICAgIHsKICAgICAgICB2YXIgY2xzdmFsID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoImNsYXNzIik7CiAgICAgICAgY2xzdmFsID0gY2xzdmFsID8gY2xzdmFsICsgIiAiICsgbmFtZSA6IG5hbWU7CiAgICAgICAgZWxlbWVudC5zZXRBdHRyaWJ1dGUoImNsYXNzIiwgY2xzdmFsKTsKICAgICAgfQogICAgfQogIH0sCgogIC8vIEhUTUwgZWxlbWVudHMgdGhhdCBjYW4gYmUgdXNlZCB3aXRoIGNsYXNzPSJpbmNyZW1lbnRhbCIKICAvLyBub3RlIHRoYXQgeW91IGNhbiBhbHNvIHB1dCB0aGUgY2xhc3Mgb24gY29udGFpbmVycyBsaWtlCiAgLy8gdXAsIG9sLCBkbCwgYW5kIGRpdiB0byBtYWtlIHRoZWlyIGNvbnRlbnRzIGFwcGVhcgogIC8vIGluY3JlbWVudGFsbHkuIFVwcGVyIGNhc2UgaXMgdXNlZCBzaW5jZSB0aGlzIGlzIHdoYXQKICAvLyBicm93c2VycyByZXBvcnQgZm9yIEhUTUwgbm9kZSBuYW1lcyAodGV4dC9odG1sKS4KICBpbmNyZW1lbnRhbF9lbGVtZW50czogbnVsbCwKICBva2F5X2Zvcl9pbmNyZW1lbnRhbDogZnVuY3Rpb24gKG5hbWUpIHsKICAgIGlmICghdGhpcy5pbmNyZW1lbnRhbF9lbGVtZW50cykKICAgIHsKICAgICAgdmFyIGluY2xpc3QgPSBuZXcgQXJyYXkoKTsKICAgICAgaW5jbGlzdFsicCJdID0gdHJ1ZTsKICAgICAgaW5jbGlzdFsicHJlIl0gPSB0cnVlOwogICAgICBpbmNsaXN0WyJsaSJdID0gdHJ1ZTsKICAgICAgaW5jbGlzdFsiYmxvY2txdW90ZSJdID0gdHJ1ZTsKICAgICAgaW5jbGlzdFsiZHQiXSA9IHRydWU7CiAgICAgIGluY2xpc3RbImRkIl0gPSB0cnVlOwogICAgICBpbmNsaXN0WyJoMiJdID0gdHJ1ZTsKICAgICAgaW5jbGlzdFsiaDMiXSA9IHRydWU7CiAgICAgIGluY2xpc3RbImg0Il0gPSB0cnVlOwogICAgICBpbmNsaXN0WyJoNSJdID0gdHJ1ZTsKICAgICAgaW5jbGlzdFsiaDYiXSA9IHRydWU7CiAgICAgIGluY2xpc3RbInNwYW4iXSA9IHRydWU7CiAgICAgIGluY2xpc3RbImFkZHJlc3MiXSA9IHRydWU7CiAgICAgIGluY2xpc3RbInRhYmxlIl0gPSB0cnVlOwogICAgICBpbmNsaXN0WyJ0ciJdID0gdHJ1ZTsKICAgICAgaW5jbGlzdFsidGgiXSA9IHRydWU7CiAgICAgIGluY2xpc3RbInRkIl0gPSB0cnVlOwogICAgICBpbmNsaXN0WyJpbWciXSA9IHRydWU7CiAgICAgIGluY2xpc3RbIm9iamVjdCJdID0gdHJ1ZTsKICAgICAgdGhpcy5pbmNyZW1lbnRhbF9lbGVtZW50cyA9IGluY2xpc3Q7CiAgICB9CiAgICByZXR1cm4gdGhpcy5pbmNyZW1lbnRhbF9lbGVtZW50c1tuYW1lLnRvTG93ZXJDYXNlKCldOwogIH0sCgogIG5leHRfaW5jcmVtZW50YWxfaXRlbTogZnVuY3Rpb24gKG5vZGUpIHsKICAgIHZhciBiciA9IHRoaXMuaXNfeGh0bWwgPyAiYnIiIDogIkJSIjsKICAgIHZhciBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CgogICAgZm9yICg7OykKICAgIHsKICAgICAgbm9kZSA9IHczY19zbGlkeS5uZXh0X25vZGUoc2xpZGUsIG5vZGUpOwoKICAgICAgaWYgKG5vZGUgPT0gbnVsbCB8fCBub2RlLnBhcmVudE5vZGUgPT0gbnVsbCkKICAgICAgICBicmVhazsKCiAgICAgIGlmIChub2RlLm5vZGVUeXBlID09IDEpICAvLyBFTEVNRU5UCiAgICAgIHsKICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PSBicikKICAgICAgICAgIGNvbnRpbnVlOwoKICAgICAgICBpZiAodzNjX3NsaWR5Lmhhc19jbGFzcyhub2RlLCAiaW5jcmVtZW50YWwiKQogICAgICAgICAgICAgJiYgdzNjX3NsaWR5Lm9rYXlfZm9yX2luY3JlbWVudGFsKG5vZGUubm9kZU5hbWUpKQogICAgICAgICAgcmV0dXJuIG5vZGU7CgogICAgICAgIGlmICh3M2Nfc2xpZHkuaGFzX2NsYXNzKG5vZGUucGFyZW50Tm9kZSwgImluY3JlbWVudGFsIikKICAgICAgICAgICAgICYmICF3M2Nfc2xpZHkuaGFzX2NsYXNzKG5vZGUsICJub24taW5jcmVtZW50YWwiKSkKICAgICAgICAgIHJldHVybiBub2RlOwogICAgICB9CiAgICB9CgogICAgcmV0dXJuIG5vZGU7CiAgfSwKCiAgcHJldmlvdXNfaW5jcmVtZW50YWxfaXRlbTogZnVuY3Rpb24gKG5vZGUpIHsKICAgIHZhciBiciA9IHRoaXMuaXNfeGh0bWwgPyAiYnIiIDogIkJSIjsKICAgIHZhciBzbGlkZSA9IHczY19zbGlkeS5zbGlkZXNbdzNjX3NsaWR5LnNsaWRlX251bWJlcl07CgogICAgZm9yICg7OykKICAgIHsKICAgICAgbm9kZSA9IHczY19zbGlkeS5wcmV2aW91c19ub2RlKHNsaWRlLCBub2RlKTsKCiAgICAgIGlmIChub2RlID09IG51bGwgfHwgbm9kZS5wYXJlbnROb2RlID09IG51bGwpCiAgICAgICAgYnJlYWs7CgogICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PSAxKQogICAgICB7CiAgICAgICAgaWYgKG5vZGUubm9kZU5hbWUgPT0gYnIpCiAgICAgICAgICBjb250aW51ZTsKCiAgICAgICAgaWYgKHczY19zbGlkeS5oYXNfY2xhc3Mobm9kZSwgImluY3JlbWVudGFsIikKICAgICAgICAgICAgICYmIHczY19zbGlkeS5va2F5X2Zvcl9pbmNyZW1lbnRhbChub2RlLm5vZGVOYW1lKSkKICAgICAgICAgIHJldHVybiBub2RlOwoKICAgICAgICBpZiAodzNjX3NsaWR5Lmhhc19jbGFzcyhub2RlLnBhcmVudE5vZGUsICJpbmNyZW1lbnRhbCIpCiAgICAgICAgICAgICAmJiAhdzNjX3NsaWR5Lmhhc19jbGFzcyhub2RlLCAibm9uLWluY3JlbWVudGFsIikpCiAgICAgICAgICByZXR1cm4gbm9kZTsKICAgICAgfQogICAgfQoKICAgIHJldHVybiBub2RlOwogIH0sCgogIC8vIHNldCB2aXNpYmlsaXR5IGZvciBhbGwgZWxlbWVudHMgb24gY3VycmVudCBzbGlkZSB3aXRoCiAgLy8gYSBwYXJlbnQgZWxlbWVudCB3aXRoIGF0dHJpYnV0ZSBjbGFzcz0iaW5jcmVtZW50YWwiCiAgc2V0X3Zpc2liaWxpdHlfYWxsX2luY3JlbWVudGFsOiBmdW5jdGlvbiAodmFsdWUpIHsKICAgIHZhciBub2RlID0gdGhpcy5uZXh0X2luY3JlbWVudGFsX2l0ZW0obnVsbCk7CgogICAgaWYgKHZhbHVlID09ICJoaWRkZW4iKQogICAgewogICAgICB3aGlsZSAobm9kZSkKICAgICAgewogICAgICAgIHczY19zbGlkeS5hZGRfY2xhc3Mobm9kZSwgImludmlzaWJsZSIpOwogICAgICAgIG5vZGUgPSB3M2Nfc2xpZHkubmV4dF9pbmNyZW1lbnRhbF9pdGVtKG5vZGUpOwogICAgICB9CiAgICB9CiAgICBlbHNlIC8vIHZhbHVlID09ICJ2aXNpYmxlIgogICAgewogICAgICB3aGlsZSAobm9kZSkKICAgICAgewogICAgICAgIHczY19zbGlkeS5yZW1vdmVfY2xhc3Mobm9kZSwgImludmlzaWJsZSIpOwogICAgICAgIG5vZGUgPSB3M2Nfc2xpZHkubmV4dF9pbmNyZW1lbnRhbF9pdGVtKG5vZGUpOwogICAgICB9CiAgICB9CiAgfSwKCiAgLy8gcmV2ZWFsIHRoZSBuZXh0IGhpZGRlbiBpdGVtIG9uIHRoZSBzbGlkZQogIC8vIG5vZGUgaXMgbnVsbCBvciB0aGUgbm9kZSB0aGF0IHdhcyBsYXN0IHJldmVhbGVkCiAgcmV2ZWFsX25leHRfaXRlbTogZnVuY3Rpb24gKG5vZGUpIHsKICAgIG5vZGUgPSB3M2Nfc2xpZHkubmV4dF9pbmNyZW1lbnRhbF9pdGVtKG5vZGUpOwoKICAgIGlmIChub2RlICYmIG5vZGUubm9kZVR5cGUgPT0gMSkgIC8vIGFuIGVsZW1lbnQKICAgICAgdzNjX3NsaWR5LnJlbW92ZV9jbGFzcyhub2RlLCAiaW52aXNpYmxlIik7CgogICAgcmV0dXJuIG5vZGU7CiAgfSwKCiAgLy8gZXhhY3QgaW52ZXJzZSBvZiByZXZlYWxOZXh0SXRlbShub2RlKQogIGhpZGVfcHJldmlvdXNfaXRlbTogZnVuY3Rpb24gKG5vZGUpIHsKICAgIGlmIChub2RlICYmIG5vZGUubm9kZVR5cGUgPT0gMSkgIC8vIGFuIGVsZW1lbnQKICAgICAgdzNjX3NsaWR5LmFkZF9jbGFzcyhub2RlLCAiaW52aXNpYmxlIik7CgogICAgcmV0dXJuIHRoaXMucHJldmlvdXNfaW5jcmVtZW50YWxfaXRlbShub2RlKTsKICB9LAoKICAvLyBsZWZ0IHRvIHJpZ2h0IHRyYXZlcnNhbCBvZiByb290J3MgY29udGVudAogIG5leHRfbm9kZTogZnVuY3Rpb24gKHJvb3QsIG5vZGUpIHsKICAgIGlmIChub2RlID09IG51bGwpCiAgICAgIHJldHVybiByb290LmZpcnN0Q2hpbGQ7CgogICAgaWYgKG5vZGUuZmlyc3RDaGlsZCkKICAgICAgcmV0dXJuIG5vZGUuZmlyc3RDaGlsZDsKCiAgICBpZiAobm9kZS5uZXh0U2libGluZykKICAgICAgcmV0dXJuIG5vZGUubmV4dFNpYmxpbmc7CgogICAgZm9yICg7OykKICAgIHsKICAgICAgbm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKCiAgICAgIGlmICghbm9kZSB8fCBub2RlID09IHJvb3QpCiAgICAgICAgYnJlYWs7CgogICAgICBpZiAobm9kZSAmJiBub2RlLm5leHRTaWJsaW5nKQogICAgICAgIHJldHVybiBub2RlLm5leHRTaWJsaW5nOwogICAgfQoKICAgIHJldHVybiBudWxsOwogIH0sCgogIC8vIHJpZ2h0IHRvIGxlZnQgdHJhdmVyc2FsIG9mIHJvb3QncyBjb250ZW50CiAgcHJldmlvdXNfbm9kZTogZnVuY3Rpb24gKHJvb3QsIG5vZGUpIHsKICAgIGlmIChub2RlID09IG51bGwpCiAgICB7CiAgICAgIG5vZGUgPSByb290Lmxhc3RDaGlsZDsKCiAgICAgIGlmIChub2RlKQogICAgICB7CiAgICAgICAgd2hpbGUgKG5vZGUubGFzdENoaWxkKQogICAgICAgICAgbm9kZSA9IG5vZGUubGFzdENoaWxkOwogICAgICB9CgogICAgICByZXR1cm4gbm9kZTsKICAgIH0KCiAgICBpZiAobm9kZS5wcmV2aW91c1NpYmxpbmcpCiAgICB7CiAgICAgIG5vZGUgPSBub2RlLnByZXZpb3VzU2libGluZzsKCiAgICAgIHdoaWxlIChub2RlLmxhc3RDaGlsZCkKICAgICAgICBub2RlID0gbm9kZS5sYXN0Q2hpbGQ7CgogICAgICByZXR1cm4gbm9kZTsKICAgIH0KCiAgICBpZiAobm9kZS5wYXJlbnROb2RlICE9IHJvb3QpCiAgICAgIHJldHVybiBub2RlLnBhcmVudE5vZGU7CgogICAgcmV0dXJuIG51bGw7CiAgfSwKCiAgcHJldmlvdXNfc2libGluZ19lbGVtZW50OiBmdW5jdGlvbiAoZWwpIHsKICAgIGVsID0gZWwucHJldmlvdXNTaWJsaW5nOwoKICAgIHdoaWxlIChlbCAmJiBlbC5ub2RlVHlwZSAhPSAxKQogICAgICBlbCA9IGVsLnByZXZpb3VzU2libGluZzsKCiAgICByZXR1cm4gZWw7CiAgfSwKCiAgbmV4dF9zaWJsaW5nX2VsZW1lbnQ6IGZ1bmN0aW9uIChlbCkgewogICAgZWwgPSBlbC5uZXh0U2libGluZzsKCiAgICB3aGlsZSAoZWwgJiYgZWwubm9kZVR5cGUgIT0gMSkKICAgICAgZWwgPSBlbC5uZXh0U2libGluZzsKCiAgICByZXR1cm4gZWw7CiAgfSwKCiAgZmlyc3RfY2hpbGRfZWxlbWVudDogZnVuY3Rpb24gKGVsKSB7CiAgICB2YXIgbm9kZTsKCiAgICBmb3IgKG5vZGUgPSBlbC5maXJzdENoaWxkOyBub2RlOyBub2RlID0gbm9kZS5uZXh0U2libGluZykKICAgIHsKICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSkKICAgICAgICBicmVhazsKICAgIH0KCiAgICByZXR1cm4gbm9kZTsKICB9LAoKICBmaXJzdF90YWc6IGZ1bmN0aW9uIChlbGVtZW50LCB0YWcpIHsKICAgIHZhciBub2RlOwoKICAgIGlmICghdGhpcy5pc194aHRtbCkKICAgICAgdGFnID0gdGFnLnRvVXBwZXJDYXNlKCk7CgogICAgZm9yIChub2RlID0gZWxlbWVudC5maXJzdENoaWxkOyBub2RlOyBub2RlID0gbm9kZS5uZXh0U2libGluZykKICAgIHsKICAgICAgaWYgKG5vZGUubm9kZVR5cGUgPT0gMSAmJiBub2RlLm5vZGVOYW1lID09IHRhZykKICAgICAgICBicmVhazsKICAgIH0KCiAgICByZXR1cm4gbm9kZTsKICB9LAoKICBoaWRlX3NlbGVjdGlvbjogZnVuY3Rpb24gKCkgewogICAgaWYgKHdpbmRvdy5nZXRTZWxlY3Rpb24pIC8vIEZpcmVmb3gsIENocm9taXVtLCBTYWZhcmksIE9wZXJhCiAgICB7CiAgICAgIHZhciBzZWxlY3Rpb24gPSB3aW5kb3cuZ2V0U2VsZWN0aW9uKCk7CgogICAgICBpZiAoc2VsZWN0aW9uLnJhbmdlQ291bnQgPiAwKQogICAgICB7CiAgICAgICAgdmFyIHJhbmdlID0gc2VsZWN0aW9uLmdldFJhbmdlQXQoMCk7CiAgICAgICAgcmFuZ2UuY29sbGFwc2UgKGZhbHNlKTsKICAgICAgfQogICAgfQogICAgZWxzZSAvLyBJbnRlcm5ldCBFeHBsb3JlcgogICAgewogICAgICB2YXIgdGV4dFJhbmdlID0gZG9jdW1lbnQuc2VsZWN0aW9uLmNyZWF0ZVJhbmdlICgpOwogICAgICB0ZXh0UmFuZ2UuY29sbGFwc2UgKGZhbHNlKTsKICAgIH0KICB9LAoKICBnZXRfc2VsZWN0ZWRfdGV4dDogZnVuY3Rpb24gKCkgewogICAgdHJ5CiAgICB7CiAgICAgIGlmICh3aW5kb3cuZ2V0U2VsZWN0aW9uKQogICAgICAgIHJldHVybiB3aW5kb3cuZ2V0U2VsZWN0aW9uKCkudG9TdHJpbmcoKTsKCiAgICAgIGlmIChkb2N1bWVudC5nZXRTZWxlY3Rpb24pCiAgICAgICAgcmV0dXJuIGRvY3VtZW50LmdldFNlbGVjdGlvbigpLnRvU3RyaW5nKCk7CgogICAgICBpZiAoZG9jdW1lbnQuc2VsZWN0aW9uKQogICAgICAgIHJldHVybiBkb2N1bWVudC5zZWxlY3Rpb24uY3JlYXRlUmFuZ2UoKS50ZXh0OwogICAgfQogICAgY2F0Y2ggKGUpCiAgICB7CiAgICB9CgogICAgcmV0dXJuICIiOwogIH0sCgogIC8vIG1ha2Ugbm90ZSBvZiBsZW5ndGggb2Ygc2VsZWN0ZWQgdGV4dAogIC8vIGFzIHRoaXMgZXZhbHVhdGVzIHRvIHplcm8gaW4gY2xpY2sgZXZlbnQKICBtb3VzZV9idXR0b25fdXA6IGZ1bmN0aW9uIChlKSB7CiAgICB3M2Nfc2xpZHkuc2VsZWN0ZWRfdGV4dF9sZW4gPSB3M2Nfc2xpZHkuZ2V0X3NlbGVjdGVkX3RleHQoKS5sZW5ndGg7CiAgfSwKCiAgLy8gcmlnaHQgbW91c2UgYnV0dG9uIGNsaWNrIGlzIHJlc2VydmVkIGZvciBjb250ZXh0IG1lbnVzCiAgLy8gaXQgaXMgbW9yZSByZWxpYWJsZSB0byBkZXRlY3QgcmlnaHRjbGljayB0aGFuIGxlZnRjbGljawogIG1vdXNlX2J1dHRvbl9jbGljazogZnVuY3Rpb24gKGUpIHsKICAgIHZhciByaWdodGNsaWNrID0gZmFsc2U7CiAgICB2YXIgbGVmdGNsaWNrID0gZmFsc2U7CiAgICB2YXIgbWlkZGxlY2xpY2sgPSBmYWxzZTsKICAgIHZhciB0YXJnZXQ7CgogICAgaWYgKCFlKQogICAgICB2YXIgZSA9IHdpbmRvdy5ldmVudDsKCiAgICBpZiAoZS50YXJnZXQpCiAgICAgIHRhcmdldCA9IGUudGFyZ2V0OwogICAgZWxzZSBpZiAoZS5zcmNFbGVtZW50KQogICAgICB0YXJnZXQgPSBlLnNyY0VsZW1lbnQ7CgogICAgLy8gd29yayBhcm91bmQgU2FmYXJpIGJ1ZwogICAgaWYgKHRhcmdldC5ub2RlVHlwZSA9PSAzKQogICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCiAgICBpZiAoZS53aGljaCkgLy8gYWxsIGJyb3dzZXJzIGV4Y2VwdCBJRQogICAgewogICAgICBsZWZ0Y2xpY2sgPSAoZS53aGljaCA9PSAxKTsKICAgICAgbWlkZGxlY2xpY2sgPSAoZS53aGljaCA9PSAyKTsKICAgICAgcmlnaHRjbGljayA9IChlLndoaWNoID09IDMpOwogICAgfQogICAgZWxzZSBpZiAoZS5idXR0b24pCiAgICB7CiAgICAgIC8vIEtvbnF1ZXJvciBnaXZlcyAxIGZvciBsZWZ0LCA0IGZvciBtaWRkbGUKICAgICAgLy8gSUU2IGdpdmVzIDAgZm9yIGxlZnQgYW5kIG5vdCAxIGFzIEkgZXhwZWN0ZWQKCiAgICAgIGlmIChlLmJ1dHRvbiA9PSA0KQogICAgICAgIG1pZGRsZWNsaWNrID0gdHJ1ZTsKCiAgICAgIC8vIGFsbCBicm93c2VycyBhZ3JlZSBvbiAyIGZvciByaWdodCBidXR0b24KICAgICAgcmlnaHRjbGljayA9IChlLmJ1dHRvbiA9PSAyKTsKICAgIH0KICAgIGVsc2UKICAgICAgbGVmdGNsaWNrID0gdHJ1ZTsKCiAgICBpZiAodzNjX3NsaWR5LnNlbGVjdGVkX3RleHRfbGVuID4gMCkKICAgIHsKICAgICAgdzNjX3NsaWR5LnN0b3BfcHJvcGFnYXRpb24oZSk7CiAgICAgIGUuY2FuY2VsID0gdHJ1ZTsKICAgICAgZS5yZXR1cm5WYWx1ZSA9IGZhbHNlOwogICAgICByZXR1cm4gZmFsc2U7CiAgICB9CgogICAgLy8gZGlzbWlzcyB0YWJsZSBvZiBjb250ZW50cwogICAgdzNjX3NsaWR5LmhpZGVfdGFibGVfb2ZfY29udGVudHMoZmFsc2UpOwoKICAgIC8vIGNoZWNrIGlmIHRhcmdldCBpcyBzb21ldGhpbmcgdGhhdCBwcm9iYWJseSB3YW50J3MgY2xpY2tzCiAgICAvLyBlLmcuIGEsIGVtYmVkLCBvYmplY3QsIGlucHV0LCB0ZXh0YXJlYSwgc2VsZWN0LCBvcHRpb24KICAgIHZhciB0YWcgPSB0YXJnZXQubm9kZU5hbWUudG9Mb3dlckNhc2UoKTsKCiAgICBpZiAodzNjX3NsaWR5Lm1vdXNlX2NsaWNrX2VuYWJsZWQgJiYgbGVmdGNsaWNrICYmCiAgICAgICAgIXczY19zbGlkeS5zcGVjaWFsX2VsZW1lbnQodGFyZ2V0KSAmJgogICAgICAgICF0YXJnZXQub25jbGljaykKICAgIHsKICAgICAgdzNjX3NsaWR5Lm5leHRfc2xpZGUodHJ1ZSk7CiAgICAgIHczY19zbGlkeS5zdG9wX3Byb3BhZ2F0aW9uKGUpOwogICAgICBlLmNhbmNlbCA9IHRydWU7CiAgICAgIGUucmV0dXJuVmFsdWUgPSBmYWxzZTsKICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQoKICAgIHJldHVybiB0cnVlOwogIH0sCgogIHNwZWNpYWxfZWxlbWVudDogZnVuY3Rpb24gKGUpIHsKICAgIHZhciB0YWcgPSBlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CgogICAgcmV0dXJuIGUub25rZXlkb3duIHx8CiAgICAgIGUub25jbGljayB8fAogICAgICB0YWcgPT0gImEiIHx8CiAgICAgIHRhZyA9PSAiZW1iZWQiIHx8CiAgICAgIHRhZyA9PSAib2JqZWN0IiB8fAogICAgICB0YWcgPT0gInZpZGVvIiB8fAogICAgICB0YWcgPT0gImF1ZGlvIiB8fAogICAgICB0YWcgPT0gImlucHV0IiB8fAogICAgICB0YWcgPT0gInRleHRhcmVhIiB8fAogICAgICB0YWcgPT0gInNlbGVjdCIgfHwKICAgICAgdGFnID09ICJvcHRpb24iOwogIH0sCgogIHNsaWR5X2Nocm9tZTogZnVuY3Rpb24gKGVsKSB7CiAgICB3aGlsZSAoZWwpCiAgICB7CiAgICAgIGlmIChlbCA9PSB3M2Nfc2xpZHkudG9jIHx8CiAgICAgICAgICBlbCA9PSB3M2Nfc2xpZHkudG9vbGJhciB8fAogICAgICAgICAgdzNjX3NsaWR5Lmhhc19jbGFzcyhlbCwgIm91dGxpbmUiKSkKICAgICAgICByZXR1cm4gdHJ1ZTsKCiAgICAgIGVsID0gZWwucGFyZW50Tm9kZTsKICAgIH0KCiAgICByZXR1cm4gZmFsc2U7CiAgfSwKCiAgZ2V0X2tleTogZnVuY3Rpb24gKGUpCiAgewogICAgdmFyIGtleTsKCiAgICAvLyBrbHVkZ2UgYXJvdW5kIE5TL0lFIGRpZmZlcmVuY2VzIAogICAgaWYgKHR5cGVvZiB3aW5kb3cuZXZlbnQgIT0gInVuZGVmaW5lZCIpCiAgICAgIGtleSA9IHdpbmRvdy5ldmVudC5rZXlDb2RlOwogICAgZWxzZSBpZiAoZS53aGljaCkKICAgICAga2V5ID0gZS53aGljaDsKCiAgICByZXR1cm4ga2V5OwogIH0sCgogIGdldF90YXJnZXQ6IGZ1bmN0aW9uIChlKSB7CiAgICB2YXIgdGFyZ2V0OwoKICAgIGlmICghZSkKICAgICAgZSA9IHdpbmRvdy5ldmVudDsKCiAgICBpZiAoZS50YXJnZXQpCiAgICAgIHRhcmdldCA9IGUudGFyZ2V0OwogICAgZWxzZSBpZiAoZS5zcmNFbGVtZW50KQogICAgICB0YXJnZXQgPSBlLnNyY0VsZW1lbnQ7CgogICAgaWYgKHRhcmdldC5ub2RlVHlwZSAhPSAxKQogICAgICB0YXJnZXQgPSB0YXJnZXQucGFyZW50Tm9kZTsKCiAgICByZXR1cm4gdGFyZ2V0OwogIH0sCgogIC8vIGRvZXMgZGlzcGxheSBwcm9wZXJ0eSBwcm92aWRlIGNvcnJlY3QgZGVmYXVsdHM/CiAgaXNfYmxvY2s6IGZ1bmN0aW9uIChlbGVtKSB7CiAgICB2YXIgdGFnID0gZWxlbS5ub2RlTmFtZS50b0xvd2VyQ2FzZSgpOwoKICAgIHJldHVybiB0YWcgPT0gIm9sIiB8fCB0YWcgPT0gInVsIiB8fCB0YWcgPT0gInAiIHx8CiAgICAgICAgICAgdGFnID09ICJsaSIgfHwgdGFnID09ICJ0YWJsZSIgfHwgdGFnID09ICJwcmUiIHx8CiAgICAgICAgICAgdGFnID09ICJoMSIgfHwgdGFnID09ICJoMiIgfHwgdGFnID09ICJoMyIgfHwKICAgICAgICAgICB0YWcgPT0gImg0IiB8fCB0YWcgPT0gImg1IiB8fCB0YWcgPT0gImg2IiB8fAogICAgICAgICAgIHRhZyA9PSAiYmxvY2txdW90ZSIgfHwgdGFnID09ICJhZGRyZXNzIjsgCiAgfSwKCiAgYWRkX2xpc3RlbmVyOiBmdW5jdGlvbiAoZWxlbWVudCwgZXZlbnQsIGhhbmRsZXIpIHsKICAgIGlmICh3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcikKICAgICAgZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKGV2ZW50LCBoYW5kbGVyLCBmYWxzZSk7CiAgICBlbHNlCiAgICAgIGVsZW1lbnQuYXR0YWNoRXZlbnQoIm9uIitldmVudCwgaGFuZGxlcik7CiAgfSwKCiAgLy8gdXNlZCB0byBwcmV2ZW50IGV2ZW50IHByb3BhZ2F0aW9uIGZyb20gZmllbGQgY29udHJvbHMKICBzdG9wX3Byb3BhZ2F0aW9uOiBmdW5jdGlvbiAoZXZlbnQpIHsKICAgIGV2ZW50ID0gZXZlbnQgPyBldmVudCA6IHdpbmRvdy5ldmVudDsKICAgIGV2ZW50LmNhbmNlbEJ1YmJsZSA9IHRydWU7ICAvLyBmb3IgSUUKCiAgICBpZiAoZXZlbnQuc3RvcFByb3BhZ2F0aW9uKQogICAgICBldmVudC5zdG9wUHJvcGFnYXRpb24oKTsKCiAgICByZXR1cm4gdHJ1ZTsKICB9LAoKICBjYW5jZWw6IGZ1bmN0aW9uIChldmVudCkgewogICAgaWYgKGV2ZW50KQogICAgewogICAgICAgZXZlbnQuY2FuY2VsID0gdHJ1ZTsKICAgICAgIGV2ZW50LnJldHVyblZhbHVlID0gZmFsc2U7CgogICAgICBpZiAoZXZlbnQucHJldmVudERlZmF1bHQpCiAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTsKICAgIH0KCiAgICB3M2Nfc2xpZHkua2V5X3dhbnRlZCA9IGZhbHNlOwogICAgcmV0dXJuIGZhbHNlOwogIH0sCgovLyBmb3IgZWFjaCBsYW5ndWFnZSBkZWZpbmUgYW4gYXNzb2NpYXRpdmUgYXJyYXkKLy8gYW5kIGFsc28gdGhlIGhlbHAgdGV4dCB3aGljaCBpcyBsb25nZXIKCiAgc3RyaW5nc19lczogewogICAgInNsaWRlIjoicMOhZy4iLAogICAgImhlbHA/IjoiQXl1ZGEiLAogICAgImNvbnRlbnRzPyI6IsONbmRpY2UiLAogICAgInRhYmxlIG9mIGNvbnRlbnRzIjoidGFibGEgZGUgY29udGVuaWRvcyIsCiAgICAiVGFibGUgb2YgQ29udGVudHMiOiJUYWJsYSBkZSBDb250ZW5pZG9zIiwKICAgICJyZXN0YXJ0IHByZXNlbnRhdGlvbiI6IlJlaW5pY2lhciBwcmVzZW50YWNpw7NuIiwKICAgICJyZXN0YXJ0PyI6IkluaWNpbyIKICB9LAogIGhlbHBfZXM6CiAgICAiVXRpbGljZSBlbCByYXTDs24sIGJhcnJhIGVzcGFjaWFkb3JhLCB0ZWNsYXMgSXpkYS9EY2hhLCAiICsKICAgICJvIFJlIHDDoWcgeSBBdiBww6FnLiBVc2UgUyB5IEIgcGFyYSBjYW1iaWFyIGVsIHRhbWHDsW8gZGUgZnVlbnRlLiIsCgogIHN0cmluZ3NfY2E6IHsKICAgICJzbGlkZSI6InDDoGcuLiIsCiAgICAiaGVscD8iOiJBanVkYSIsCiAgICAiY29udGVudHM/Ijoiw41uZGV4IiwKICAgICJ0YWJsZSBvZiBjb250ZW50cyI6InRhdWxhIGRlIGNvbnRpbmd1dHMiLAogICAgIlRhYmxlIG9mIENvbnRlbnRzIjoiVGF1bGEgZGUgQ29udGluZ3V0cyIsCiAgICAicmVzdGFydCBwcmVzZW50YXRpb24iOiJSZWluaWNpYXIgcHJlc2VudGFjacOzIiwKICAgICJyZXN0YXJ0PyI6IkluaWNpIgogIH0sCiAgaGVscF9jYToKICAgICJVdGlsaXR6aSBlbCByYXRvbMOtLCBiYXJyYSBlc3BhaWFkb3JhLCB0ZWNsZXMgRXNxLi9EdGEuICIgKwogICAgIm8gUmUgcMOgZyB5IEF2IHDDoGcuIFVzaSBTIGkgQiBwZXIgY2FudmlhciBncmFuZMOgcmlhIGRlIGZvbnQuIiwKCiAgc3RyaW5nc19jczogewogICAgInNsaWRlIjoic27DrW1layIsCiAgICAiaGVscD8iOiJuw6Fwb3bEm2RhIiwKICAgICJjb250ZW50cz8iOiJvYnNhaCIsCiAgICAidGFibGUgb2YgY29udGVudHMiOiJvYnNhaCBwcmV6ZW50YWNlIiwKICAgICJUYWJsZSBvZiBDb250ZW50cyI6Ik9ic2FoIHByZXplbnRhY2UiLAogICAgInJlc3RhcnQgcHJlc2VudGF0aW9uIjoiem5vdnUgc3B1c3RpdCBwcmV6ZW50YWNpIiwKICAgICJyZXN0YXJ0PyI6InJlc3RhcnQiCiAgfSwKICBoZWxwX2NzOgogICAgIlByZXplbnRhY2kgbcWvxb5ldGUgcHJvY2jDoXpldCBwb21vY8OtIGtsaWtudXTDrSBtecWhaSwgbWV6ZXJuw61rdSwgIiArCiAgICAixaFpcGVrIHZsZXZvIGEgdnByYXZvIG5lYm8ga2zDoXZlcyBQYWdlVXAgYSBQYWdlRG93bi4gUMOtc21vIHNlICIgKwogICAgImTDoSB6dsSbdMWhaXQgYSB6bWVuxaFpdCBwb21vY8OtIGtsw6F2ZXMgQiBhIFMuIiwKCiAgc3RyaW5nc19ubDogewogICAgInNsaWRlIjoicGFnaW5hIiwKICAgICJoZWxwPyI6IkhlbHA/IiwKICAgICJjb250ZW50cz8iOiJJbmhvdWQ/IiwKICAgICJ0YWJsZSBvZiBjb250ZW50cyI6ImluaG91ZHNvcGdhdmUiLAogICAgIlRhYmxlIG9mIENvbnRlbnRzIjoiSW5ob3Vkc29wZ2F2ZSIsCiAgICAicmVzdGFydCBwcmVzZW50YXRpb24iOiJoZXJzdGFydCBwcmVzZW50YXRpZSIsCiAgICAicmVzdGFydD8iOiJIZXJzdGFydD8iCiAgfSwKICBoZWxwX25sOgogICAgICJOYXZpZ2VlciBkLm0udi4gaGV0IG11aXMsIHNwYXRpZWJhciwgTGlua3MvUmVjaHRzIHRvZXRzZW4sICIgKwogICAgICJvZiBQZ1VwIGVuIFBnRG4uIEdlYnJ1aWsgUyBlbiBCIG9tIGRlIGthcmFrdGVyZ3Jvb3R0ZSB0ZSB2ZXJhbmRlcmVuLiIsCgogIHN0cmluZ3NfZGU6IHsKICAgICJzbGlkZSI6IlNlaXRlIiwKICAgICJoZWxwPyI6IkhpbGZlIiwKICAgICJjb250ZW50cz8iOiLDnGJlcnNpY2h0IiwKICAgICJ0YWJsZSBvZiBjb250ZW50cyI6IkluaGFsdHN2ZXJ6ZWljaG5pcyIsCiAgICAiVGFibGUgb2YgQ29udGVudHMiOiJJbmhhbHRzdmVyemVpY2huaXMiLAogICAgInJlc3RhcnQgcHJlc2VudGF0aW9uIjoiUHLDpHNlbnRhdGlvbiBuZXUgc3RhcnRlbiIsCiAgICAicmVzdGFydD8iOiJOZXVzdGFydCIKICB9LAogIGhlbHBfZGU6CiAgICAiQmVudXR6ZW4gU2llIGRpZSBNYXVzLCBMZWVyc2NobGFnLCBkaWUgQ3Vyc29ydGFzdGVuIGxpbmtzL3JlY2h0cyBvZGVyICIgKwogICAgIlBhZ2UgdXAvUGFnZSBEb3duIHp1bSBXZWNoc2VsbiBkZXIgU2VpdGVuIHVuZCBTIHVuZCBCIGbDvHIgZGllIFNjaHJpZnRncsO2c3NlLiIsCgogIHN0cmluZ3NfcGw6IHsKICAgICJzbGlkZSI6InNsYWpkIiwKICAgICJoZWxwPyI6InBvbW9jPyIsCiAgICAiY29udGVudHM/Ijoic3BpcyB0cmXFm2NpPyIsCiAgICAidGFibGUgb2YgY29udGVudHMiOiJzcGlzIHRyZcWbY2kiLAogICAgIlRhYmxlIG9mIENvbnRlbnRzIjoiU3BpcyBUcmXFm2NpIiwKICAgICJyZXN0YXJ0IHByZXNlbnRhdGlvbiI6IlJlc3RhcnR1aiBwcmV6ZW50YWNqxJkiLAogICAgInJlc3RhcnQ/IjoicmVzdGFydD8iCiAgfSwKICBoZWxwX3BsOgogICAgIlptaWVuaWFqIHNsYWpkeSBrbGlrYWrEhWMgbXlzesSFLCBuYWNpc2thasSFYyBzcGFjasSZLCBzdHJ6YcWCa2kgbGV3by9wcmF3byIgKwogICAgImx1YiBQZ1VwIC8gUGdEbi4gVcW8eWoga2xhd2lzenkgUyBpIEIsIGFieSB6bWllbmnEhyByb3ptaWFyIGN6Y3ppb25raS4iLAoKICBzdHJpbmdzX2ZyOiB7CiAgICAic2xpZGUiOiJwYWdlIiwKICAgICJoZWxwPyI6IkFpZGUiLAogICAgImNvbnRlbnRzPyI6IkluZGV4IiwKICAgICJ0YWJsZSBvZiBjb250ZW50cyI6InRhYmxlIGRlcyBtYXRpw6hyZXMiLAogICAgIlRhYmxlIG9mIENvbnRlbnRzIjoiVGFibGUgZGVzIG1hdGnDqHJlcyIsCiAgICAicmVzdGFydCBwcmVzZW50YXRpb24iOiJSZWNvbW1lbmNlciBsJ2V4cG9zw6kiLAogICAgInJlc3RhcnQ/IjoiRMOpYnV0IgogIH0sCiAgaGVscF9mcjoKICAgICJOYXZpZ3VleiBhdmVjIGxhIHNvdXJpcywgbGEgYmFycmUgZCdlc3BhY2UsIGxlcyBmbMOoY2hlcyAiICsKICAgICJnYXVjaGUvZHJvaXRlIG91IGxlcyB0b3VjaGVzIFBnIFVwLCBQZyBEbi4gVXRpbGlzZXogIiArCiAgICAibGVzIHRvdWNoZXMgUyBldCBCIHBvdXIgbW9kaWZpZXIgbGEgdGFpbGxlIGRlIGxhIHBvbGljZS4iLAoKICBzdHJpbmdzX2h1OiB7CiAgICAic2xpZGUiOiJvbGRhbCIsCiAgICAiaGVscD8iOiJzZWfDrXRzw6lnIiwKICAgICJjb250ZW50cz8iOiJ0YXJ0YWxvbSIsCiAgICAidGFibGUgb2YgY29udGVudHMiOiJ0YXJ0YWxvbWplZ3l6w6lrIiwKICAgICJUYWJsZSBvZiBDb250ZW50cyI6IlRhcnRhbG9tamVneXrDqWsiLAogICAgInJlc3RhcnQgcHJlc2VudGF0aW9uIjoiYmVtdXRhdMOzIMO6anJhaW5kw610w6FzYSIsCiAgICAicmVzdGFydD8iOiLDumpyYWluZMOtdMOhcyIKICB9LAogIGhlbHBfaHU6CiAgICAiQXogb2xkYWxhayBrw7Z6dGkgbMOpcGtlZMOpc2hleiBrYXR0aW50c29uIGF6IGVnw6lycmVsLCB2YWd5ICIgKwogICAgImhhc3puw6FsamEgYSBzesOza8O2eiwgYSBiYWwsIHZhZ3kgYSBqb2JiIG55w61sLCBpbGxldHZlIGEgUGFnZSBEb3duLCAiICsKICAgICJQYWdlIFVwIGJpbGxlbnR5xbFrZXQuIEF6IFMgw6lzIGEgQiBiaWxsZW50ecWxa2tlbCB2w6FsdG96dGF0aGF0amEgIiArCiAgICAiYSBzesO2dmVnIG3DqXJldMOpdC4iLAoKICBzdHJpbmdzX2l0OiB7CiAgICAic2xpZGUiOiJwYWcuIiwKICAgICJoZWxwPyI6IkFpdXRvIiwKICAgICJjb250ZW50cz8iOiJJbmRpY2UiLAogICAgInRhYmxlIG9mIGNvbnRlbnRzIjoiaW5kaWNlIiwKICAgICJUYWJsZSBvZiBDb250ZW50cyI6IkluZGljZSIsCiAgICAicmVzdGFydCBwcmVzZW50YXRpb24iOiJSaWNvbWluY2lhcmUgbGEgcHJlc2VudGF6aW9uZSIsCiAgICAicmVzdGFydD8iOiJJbml6aW8iCiAgfSwKICBoZWxwX2l0OgogICAgIk5hdmlnYXJlIGNvbiBtb3VzZSwgYmFycmEgc3BhemlvLCBmcmVjY2Ugc2luaXN0cmEvZGVzdHJhIG8gIiArCiAgICAiUGdVcCBlIFBnRG4uIFVzYXJlIFMgZSBCIHBlciBjYW1iaWFyZSBsYSBkaW1lbnNpb25lIGRlaSBjYXJhdHRlcmkuIiwKCiAgc3RyaW5nc19lbDogewogICAgInNsaWRlIjoiz4POtc67zq/OtM6xIiwKICAgICJoZWxwPyI6Is6yzr/Ors64zrXOuc6xOyIsCiAgICAiY29udGVudHM/Ijoiz4DOtc+BzrnOtc+Hz4zOvM61zr3OsTsiLAogICAgInRhYmxlIG9mIGNvbnRlbnRzIjoiz4DOr869zrHOus6xz4Igz4DOtc+BzrnOtc+Hzr/OvM6tzr3Pic69IiwKICAgICJUYWJsZSBvZiBDb250ZW50cyI6Is6gzq/Ovc6xzrrOsc+CIM6gzrXPgc65zrXPh86/zrzOrc69z4nOvSIsCiAgICAicmVzdGFydCBwcmVzZW50YXRpb24iOiLOtc+AzrHOvc61zrrOus6vzr3Ot8+Dzrcgz4DOsc+Bzr/Phc+Dzq/Osc+DzrfPgiIsCiAgICAicmVzdGFydD8iOiLOtc+AzrHOvc61zrrOus6vzr3Ot8+Dzrc7IgogIH0sCiAgaGVscF9lbDoKICAgICLOoM67zr/Ot86zzrfOuM61zq/PhM61IM68zrUgz4TOvyDOus67zq/OuiDPhM6/z4Ugz4DOv869z4TOuc66zrnOv8+NLCDPhM6/IHNwYWNlLCDPhM6xIM6yzq3Ou863IM6xz4HOuc+Dz4TOtc+BzqwvzrTOtc6+zrnOrCwgIiArCiAgICAizq4gUGFnZSBVcCDOus6xzrkgUGFnZSBEb3duLiDOp8+BzrfPg865zrzOv8+Azr/Ouc6uz4PPhM61IM+EzrEgz4DOu86uzrrPhM+BzrEgUyDOus6xzrkgQiDOs865zrEgzr3OsSDOsc67zrvOrM6+zrXPhM61ICIgKwogICAgIs+Ezr8gzrzOrc6zzrXOuM6/z4Igz4TOt8+CIM6zz4HOsc68zrzOsc+Ezr/Pg861zrnPgc6sz4IuIiwKCiAgc3RyaW5nc19qYTogewogICAgInNsaWRlIjoi44K544Op44Kk44OJIiwKICAgICJoZWxwPyI6IuODmOODq+ODlyIsCiAgICAiY29udGVudHM/Ijoi55uu5qyhIiwKICAgICJ0YWJsZSBvZiBjb250ZW50cyI6IuebruasoeOCkuihqOekuiIsCiAgICAiVGFibGUgb2YgQ29udGVudHMiOiLnm67mrKEiLAogICAgInJlc3RhcnQgcHJlc2VudGF0aW9uIjoi5pyA5Yid44GL44KJ5YaN55SfIiwKICAgICJyZXN0YXJ0PyI6IuacgOWIneOBi+OCiSIKICB9LAogIGhlbHBfamE6CiAgICAgIuODnuOCpuOCueW3puOCr+ODquODg+OCryDjg7sg44K544Oa44O844K5IOODuyDlt6blj7Pjgq3jg7wgIiArCiAgICAgIuOBvuOBn+OBryBQYWdlIFVwIOODuyBQYWdlIERvd27jgafmk43kvZzvvIwgUyDjg7sgQuOBp+ODleOCqeODs+ODiOOCteOCpOOCuuWkieabtCIsCgogIHN0cmluZ3Nfemg6IHsKICAgICJzbGlkZSI6IuW5u+eBr+eJhyIsCiAgICAiaGVscD8iOiLluK7liqk/IiwKICAgICJjb250ZW50cz8iOiLlhoXlrrk/IiwKICAgICJ0YWJsZSBvZiBjb250ZW50cyI6IuebruW9lSIsCiAgICAiVGFibGUgb2YgQ29udGVudHMiOiLnm67lvZUiLAogICAgInJlc3RhcnQgcHJlc2VudGF0aW9uIjoi6YeN5paw5ZCv5Yqo5bGV56S6IiwKICAgICJyZXN0YXJ0PyI6IumHjeaWsOWQr+WKqD8iCiAgfSwKICBoZWxwX3poOgogICAgIueUqOm8oOagh+eCueWHuywg56m65qC85p2hLCDlt6blj7Pnrq3lpLQsIFBnIFVwIOWSjCBQZyBEbiDlr7zoiKouICIgKwogICAgIueUqCBTLCBCIOaUueWPmOWtl+S9k+Wkp+Wwjy4iLAoKICBzdHJpbmdzX3J1OiB7CiAgICAic2xpZGUiOiLRgdC70LDQudC0IiwKICAgICJoZWxwPyI6ItC/0L7QvNC+0YnRjD8iLAogICAgImNvbnRlbnRzPyI6ItGB0L7QtNC10YDQttCw0L3QuNC1PyIsCiAgICAidGFibGUgb2YgY29udGVudHMiOiLQvtCz0LvQsNCy0LvQtdC90LjQtSIsCiAgICAiVGFibGUgb2YgQ29udGVudHMiOiLQntCz0LvQsNCy0LvQtdC90LjQtSIsCiAgICAicmVzdGFydCBwcmVzZW50YXRpb24iOiLQv9C10YDQtdC30LDQv9GD0YHRgtC40YLRjCDQv9GA0LXQt9C10L3RgtCw0YbQuNGOIiwKICAgICJyZXN0YXJ0PyI6ItC/0LXRgNC10LfQsNC/0YPRgdC6PyIKICB9LAogIGhlbHBfcnU6CiAgICAi0J/QtdGA0LXQvNC10YnQsNC50YLQtdGB0Ywg0LrQu9C40LrQsNGPINC80YvRiNC60L7QuSwg0LjRgdC/0L7Qu9GM0LfRg9GPINC60LvQsNCy0LjRiNGDINC/0YDQvtCx0LXQuywg0YHRgtGA0LXQu9C60LgiICsKICAgICLQstC70LXQstC+L9Cy0L/RgNCw0LLQviDQuNC70LggUGcgVXAg0LggUGcgRG4uINCa0LvQsNCy0LjRiNC4IFMg0LggQiDQvNC10L3Rj9GO0YIg0YDQsNC30LzQtdGAINGI0YDQuNGE0YLQsC4iLAoKICBzdHJpbmdzX3N2OiB7CiAgICAic2xpZGUiOiJzaWRhIiwKICAgICJoZWxwPyI6Imhqw6RscCIsCiAgICAiY29udGVudHM/IjoiaW5uZWjDpWxsIiwKICAgICJ0YWJsZSBvZiBjb250ZW50cyI6ImlubmVow6VsbHNmw7ZydGVja25pbmciLAogICAgIlRhYmxlIG9mIENvbnRlbnRzIjoiSW5uZWjDpWxsc2bDtnJ0ZWNrbmluZyIsCiAgICAicmVzdGFydCBwcmVzZW50YXRpb24iOiJ2aXNhIHByZXNlbnRhdGlvbmVuIGZyw6VuIGLDtnJqYW4iLAogICAgInJlc3RhcnQ/IjoiYsO2cmphIG9tIgogIH0sCiAgaGVscF9zdjoKICAgICJCbMOkZGRyYSBtZWQgZXR0IGtsaWNrIG1lZCB2w6Ruc3RyYSBtdXNrbmFwcGVuLCBtZWxsYW5zbGFnc3RhbmdlbnRlbiwgIiArCiAgICAidsOkbnN0ZXItIG9jaCBow7ZnZXJwaWx0YW5nZW50ZXJuYSBlbGxlciB0YW5nZW50ZXJuYSBQZyBVcCwgUGcgRG4uICIgKwogICAgIkFudsOkbmQgdGFuZ2VudGVybmEgUyBvY2ggQiBmw7ZyIGF0dCDDpG5kcmEgdGV4dGVucyBzdG9ybGVrLiIsCgogIHN0cmluZ3M6IHsgfSwKCiAgbG9jYWxpemU6IGZ1bmN0aW9uIChzcmMpIHsKICAgIGlmIChzcmMgPT0gIiIpCiAgICAgIHJldHVybiBzcmM7CgogICAgIC8vIHRyeSBmdWxsIGxhbmd1YWdlIGNvZGUsIGUuZy4gZW4tVVMKICAgICB2YXIgcywgbG9va3VwID0gdzNjX3NsaWR5LnN0cmluZ3NbdzNjX3NsaWR5LmxhbmddOwoKICAgICBpZiAobG9va3VwKQogICAgIHsKICAgICAgIHMgPSBsb29rdXBbc3JjXTsKCiAgICAgICBpZiAocykKICAgICAgICByZXR1cm4gczsKICAgICB9CgogICAgIC8vIHN0cmlwIGNvdW50cnkgY29kZSBzdWZmaXgsIGUuZy4KICAgICAvLyB0cnkgZW4gaWYgdW5kZWZpbmVkIGZvciBlbi1VUwogICAgIHZhciBsZyA9IHczY19zbGlkeS5sYW5nLnNwbGl0KCItIik7CgogICAgIGlmIChsZy5sZW5ndGggPiAxKQogICAgIHsKICAgICAgIGxvb2t1cCA9IHczY19zbGlkeS5zdHJpbmdzW2xnWzBdXTsKCiAgICAgICBpZiAobG9va3VwKQogICAgICAgewogICAgICAgICBzID0gbG9va3VwW3NyY107CgogICAgICAgICBpZiAocykKICAgICAgICAgIHJldHVybiBzOwogICAgICAgfQogICAgIH0KCiAgICAgLy8gb3RoZXJ3aXNlIHN0cmluZyBhcyBpcwogICAgIHJldHVybiBzcmM7CiAgfSwKCiAgaW5pdF9sb2NhbGl6YXRpb246IGZ1bmN0aW9uICgpIHsKICAgIHZhciBpMThuID0gdzNjX3NsaWR5OwogICAgdmFyIGhlbHBfdGV4dCA9IHczY19zbGlkeS5oZWxwX3RleHQ7CgogICAgLy8gZWFjaCBzdWNoIGxhbmd1YWdlIGFycmF5IGlzIGRlY2xhcmVkIGluIHRoZSBsb2NhbGl6ZSBhcnJheQogICAgLy8gdGhpcyBpcyB1c2VkIGFzIGluICB3M2Nfc2xpZHkubG9jYWxpemUoImZvbyIpOwogICAgdGhpcy5zdHJpbmdzID0gewogICAgICAiZXMiOnRoaXMuc3RyaW5nc19lcywKICAgICAgImNhIjp0aGlzLnN0cmluZ3NfY2EsCiAgICAgICJjcyI6dGhpcy5zdHJpbmdzX2NzLAogICAgICAibmwiOnRoaXMuc3RyaW5nc19ubCwKICAgICAgImRlIjp0aGlzLnN0cmluZ3NfZGUsCiAgICAgICJwbCI6dGhpcy5zdHJpbmdzX3BsLAogICAgICAiZnIiOnRoaXMuc3RyaW5nc19mciwKICAgICAgImh1Ijp0aGlzLnN0cmluZ3NfaHUsCiAgICAgICJpdCI6dGhpcy5zdHJpbmdzX2l0LAogICAgICAiZWwiOnRoaXMuc3RyaW5nc19lbCwKICAgICAgImpwIjp0aGlzLnN0cmluZ3NfamEsCiAgICAgICJ6aCI6dGhpcy5zdHJpbmdzX3poLAogICAgICAicnUiOnRoaXMuc3RyaW5nc19ydSwKICAgICAgInN2Ijp0aGlzLnN0cmluZ3Nfc3YKICAgIH0sCgogICAgaTE4bi5zdHJpbmdzX2VzW2hlbHBfdGV4dF0gPSBpMThuLmhlbHBfZXM7CiAgICBpMThuLnN0cmluZ3NfY2FbaGVscF90ZXh0XSA9IGkxOG4uaGVscF9jYTsKICAgIGkxOG4uc3RyaW5nc19jc1toZWxwX3RleHRdID0gaTE4bi5oZWxwX2NzOwogICAgaTE4bi5zdHJpbmdzX25sW2hlbHBfdGV4dF0gPSBpMThuLmhlbHBfbmw7CiAgICBpMThuLnN0cmluZ3NfZGVbaGVscF90ZXh0XSA9IGkxOG4uaGVscF9kZTsKICAgIGkxOG4uc3RyaW5nc19wbFtoZWxwX3RleHRdID0gaTE4bi5oZWxwX3BsOwogICAgaTE4bi5zdHJpbmdzX2ZyW2hlbHBfdGV4dF0gPSBpMThuLmhlbHBfZnI7CiAgICBpMThuLnN0cmluZ3NfaHVbaGVscF90ZXh0XSA9IGkxOG4uaGVscF9odTsKICAgIGkxOG4uc3RyaW5nc19pdFtoZWxwX3RleHRdID0gaTE4bi5oZWxwX2l0OwogICAgaTE4bi5zdHJpbmdzX2VsW2hlbHBfdGV4dF0gPSBpMThuLmhlbHBfZWw7CiAgICBpMThuLnN0cmluZ3NfamFbaGVscF90ZXh0XSA9IGkxOG4uaGVscF9qYTsKICAgIGkxOG4uc3RyaW5nc196aFtoZWxwX3RleHRdID0gaTE4bi5oZWxwX3poOwogICAgaTE4bi5zdHJpbmdzX3J1W2hlbHBfdGV4dF0gPSBpMThuLmhlbHBfcnU7CiAgICBpMThuLnN0cmluZ3Nfc3ZbaGVscF90ZXh0XSA9IGkxOG4uaGVscF9zdjsKCiAgICB3M2Nfc2xpZHkubGFuZyA9IGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZS5nZXRBdHRyaWJ1dGUoImxhbmciKTsKCiAgICBpZiAoIXczY19zbGlkeS5sYW5nKQogICAgICB3M2Nfc2xpZHkubGFuZyA9IGRvY3VtZW50LmJvZHkucGFyZW50Tm9kZS5nZXRBdHRyaWJ1dGUoInhtbDpsYW5nIik7CgogICAgaWYgKCF3M2Nfc2xpZHkubGFuZykKICAgICAgdzNjX3NsaWR5LmxhbmcgPSAiZW4iOwogIH0KfTsKCi8vIGhhY2sgZm9yIGJhY2sgYnV0dG9uIGJlaGF2aW9yCmlmICh3M2Nfc2xpZHkuaWU2IHx8IHczY19zbGlkeS5pZTcpCnsKICBkb2N1bWVudC53cml0ZSgiPGlmcmFtZSBpZD0naGlzdG9yeUZyYW1lJyAiICsKICAic3JjPSdqYXZhc2NyaXB0OlwiPGh0bWwiKyI+PC8iKyJodG1sPlwiJyAiICsKICAiaGVpZ2h0PScxJyB3aWR0aD0nMScgIiArCiAgInN0eWxlPSdwb3NpdGlvbjphYnNvbHV0ZTtsZWZ0Oi04MDBweCc+PC9pZnJhbWU+Iik7Cn0KCi8vIGF0dGFjaCBldmVudCBsaXN0ZW5lcnMgZm9yIGluaXRpYWxpemF0aW9uCnczY19zbGlkeS5zZXRfdXAoKTsKCi8vIGhpZGUgdGhlIHNsaWRlcyBhcyBzb29uIGFzIGJvZHkgZWxlbWVudCBpcyBhdmFpbGFibGUKLy8gdG8gcmVkdWNlIGFubm95aW5nIHNjcmVlbiBtZXNzIGJlZm9yZSB0aGUgb25sb2FkIGV2ZW50CnNldFRpbWVvdXQodzNjX3NsaWR5LmhpZGVfc2xpZGVzLCA1MCk7Cgo=" charset="utf-8" type="text/javascript"></script>
</head>
<body>
<div class="slide titlepage">
  <h1 class="title">Marketplace Data Model</h1>
  <p class="author">
Rich Wallace
  </p>
  <p class="date">Oct 4, 2018</p>
</div>
<div id="in-the-beginning" class="slide section level1">
<h1>in the beginning</h1>
<p>life was simple. plugins were</p>
<div>
<ul class="incremental">
<li><p>p1, p2, or not a plugin</p></li>
<li><p>could be compatible with multiple applications and versions</p></li>
<li><p>were only available in server installs</p></li>
</ul>
</div>
</div>
<div id="then-came-ondemand" class="slide section level1">
<h1>then came OnDemand</h1>
<div>
<ul class="incremental">
<li><p>some p2 plugins could be installed OnDemand</p></li>
<li><p>some were installed by default</p></li>
<li><p>some were <em>only</em> available in OnDemand</p></li>
</ul>
</div>
</div>
<div id="then-came-speakeasy" class="slide section level1">
<h1>then came SpeakEasy</h1>
<div>
<ul class="incremental">
<li><p>add-ons could be remote</p></li>
<li><p>werent really installed</p></li>
<li><p>just a descriptor describing how an external site hooked into an application</p></li>
</ul>
</div>
</div>
<div id="then-came-datacenter-1.0" class="slide section level1">
<h1>then came DataCenter (1.0)</h1>
<ul>
<li>nothing fancy, just a flag</li>
</ul>
</div>
<div id="then-came-instruction-only" class="slide section level1">
<h1>then came instruction only</h1>
<div>
<ul class="incremental">
<li><p>not a plugin</p></li>
<li><p>with special instructions for installing</p></li>
<li><p>other special metadata for HipChat and BitBucket</p></li>
</ul>
</div>
</div>
<div id="data-model-evolved-ad-hoc" class="slide section level1">
<h1>data model evolved ad-hoc</h1>
<div>
<ul class="incremental">
<li><p>nonsense states possible</p></li>
<li><p>bugs in validation logic</p></li>
<li><p>complex query logic</p></li>
</ul>
</div>
</div>
<div id="data-model-refactor-goals" class="slide section level1">
<h1>data model refactor goals</h1>
<div>
<ul class="incremental">
<li><p>make impossible states unrepresentable</p></li>
<li><p>make the data model clearer</p></li>
<li><p>make state transitions easier to follow</p></li>
<li><p>simplify queries</p></li>
<li><p>simplify validation logic</p></li>
</ul>
</div>
</div>
<div id="introducing-apps" class="slide section level1">
<h1>introducing <code>App</code>s</h1>
<div>
<ul class="incremental">
<li><p>corresponds to <code>PluginVersion</code></p></li>
<li><p>these correspond to <code>PluginsThree</code>, <code>PluginsTwo</code> and <code>PluginsOne</code>, , <code>NotAPlugin</code>, and <code>NotAPlugin</code></p></li>
<li><p>each type of app has requirements of their own</p></li>
</ul>
</div>
</div>
<div id="cloudapp" class="slide section level1">
<h1>CloudApp</h1>
<div>
<ul class="incremental">
<li><p><em>must</em> have a descriptor uploaded</p></li>
<li><p><em>should</em> have a URI for where the descriptor came from (wed like to make that should a must but we have older Connect apps that dont have them because we didnt always require them)</p></li>
<li><p><em>can</em> have a list of scopes</p></li>
<li><p><em>must</em> specify compatibility with at least one Cloud application (versioning doesnt matter because its Cloud)</p></li>
<li><p><em>must</em> be free or paid via Atlassian</p>
<ul class="incremental">
<li>if its paid via Atlassian, it must have a link to documentation</li>
</ul></li>
</ul>
</div>
</div>
<div id="serverapp" class="slide section level1">
<h1>ServerApp</h1>
<div>
<ul class="incremental">
<li><p><em>should</em> have an installable artifact, either a jar or obr file (again, wed like make this a must but we didnt always host these artifacts and not all apps have them)</p></li>
<li><p><em>must</em> specify if they are <code>PluginsOne</code> or <code>PluginsTwo</code> (no more weird plugins three or a plugin that isnt a plugin)</p></li>
<li><p><em>must</em> specify an auto update strategy</p></li>
<li><p><em>must</em> be free, paid via vendor, or paid via Atlassian.</p>
<ul class="incremental">
<li><p>if its paid via Atlassian app, it</p>
<ul class="incremental">
<li><p>must have a documentation link</p></li>
<li><p>can be role based</p></li>
<li><p>must be compatible with only a single application</p></li>
</ul></li>
<li><p>If its paid via vendor, it</p>
<ul class="incremental">
<li><p><em>must</em> have a documentation link</p></li>
<li><p><em>can</em> have a link to a vendor site to purchase the app</p></li>
<li><p><em>can</em> be compatible with one or more applications</p></li>
</ul></li>
<li><p>if its free, it</p>
<ul class="incremental">
<li><p><em>can</em> have a documentation link</p></li>
<li><p><em>can</em> be compatible with one or more applications</p></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="instructionalapp" class="slide section level1">
<h1>InstructionalApp</h1>
<div>
<ul class="incremental">
<li><p><em>can</em> have one or more installation instructions</p></li>
<li><p><em>can</em> specify an integration type</p></li>
<li><p><em>must</em> specify either a link to download a binary or a link for a customer to learn more</p></li>
<li><p><em>must</em> be either free or paid via vendor. If its paid via vendor, then it</p>
<ul class="incremental">
<li><p><em>must</em> have a documentation link</p></li>
<li><p><em>can</em> have a link to a vendor site to purchase the app</p></li>
</ul></li>
</ul>
</div>
</div>
<div id="workflowapp" class="slide section level1">
<h1>WorkflowApp</h1>
<div>
<ul class="incremental">
<li><p><em>must</em> have an uploaded artifact, a jwb file</p></li>
<li><p><em>must</em> be either free or paid via vendor. If its paid via vendor, then it</p>
<ul class="incremental">
<li><p><em>must</em> have a documentation link</p></li>
<li><p><em>can</em> have a link to a vendor site to purchase the app</p></li>
</ul></li>
</ul>
</div>
</div>
<div id="pluginversion-status" class="slide section level1">
<h1>PluginVersion status</h1>
<div>
<ul class="incremental">
<li><p>can also be public or private</p></li>
<li><p>determines if some fields are required or not</p></li>
<li><p>previoulsy determined <code>PluginVersion.status</code></p></li>
</ul>
</div>
</div>
<div id="modeling-status" class="slide section level1">
<h1>modeling status</h1>
<div>
<p>we parameterize our types with a type constructor</p>
<pre><code>object Status {
  type Private[A] = Option[A]
  type Public[A] = A
}</code></pre>
<ul class="incremental">
<li><code>CloudApp[Private, ...]</code> vs. <code>CloudApp[Public, ...]</code></li>
</ul>
</div>
</div>
<div id="modeling-payment-type" class="slide section level1">
<h1>modeling payment type</h1>
<div>
<p>we also parameterize payment type</p>
<pre><code>  object CloudApp {
    // snip
    object Paid {
      final case class Free(doc: Option[URI])
      final case class ViaAtlassian(doc: URI)
    }
  }</code></pre>
<ul class="incremental">
<li><code>CloudApp[..., Free]</code> vs. <code>CloudApp[..., ViaAtlassian]</code> vs. <code>CloudApp[..., Free \/ ViaAtlassian]</code></li>
</ul>
</div>
</div>
<div id="app-sum-type" class="slide section level1">
<h1><code>App</code> sum type</h1>
<div>
<p>An <code>App</code> can be one of many things</p>
<ul class="incremental">
<li><p><code>CloudApp[Private, CloudApp.Paid.Free \/ CloudApp.Paid.ViaAtlassian]</code></p></li>
<li><p><code>CloudApp[Public, CloudApp.Paid.Free \/ CloudApp.Paid.ViaAtlassian]</code></p></li>
<li><p><code>ServerApp[Private, ServerApp.Paid.Free \/ ServerApp.Paid.ViaVendor \/ ServerApp.Paid.ViaAtlassian]</code></p></li>
<li><p><code>ServerApp[Public, ServerApp.Paid.Free \/ ServerApp.Paid.ViaVendor \/ ServerApp.Paid.ViaAtlassian]</code></p></li>
<li><p><code>DataCenterApp[Private, DataCenterApp.Paid.Free \/ DataCenterApp.Paid.ViaVendor \/ DataCenterApp.Paid.ViaAtlassian]</code></p></li>
<li><p><code>DataCenterApp[Public, DataCenterApp.Paid.Free \/ DataCenterApp.Paid.ViaVendor \/ DataCenterApp.Paid.ViaAtlassian]</code></p></li>
<li><p><code>InstructionalApp[Private, InstructionalApp.Paid.Free \/ InstructionalApp.Paid.ViaVendor]</code></p></li>
<li><p><code>InstructionalApp[Public, InstructionalApp.Paid.Free \/ InstructionalApp.Paid.ViaVendor]</code></p></li>
<li><p><code>WorkflowApp[Private, WorkflowApp.Paid.Free \/ WorkflowApp.Paid.ViaVendor]</code></p></li>
<li><p><code>WorkflowApp[Public, WorkflowApp.Paid.Free \/ WorkflowApp.Paid.ViaVendor]</code></p></li>
</ul>
</div>
</div>
<div id="introducing-applisting" class="slide section level1">
<h1>introducing <code>AppListing</code></h1>
<div>
<ul class="incremental">
<li><p>corresponds to <code>Plugin</code></p></li>
<li><p>groups <code>App</code>s</p></li>
<li><p>has different constraints depending on the state</p></li>
</ul>
</div>
</div>
<div id="private-applistings" class="slide section level1">
<h1>private <code>AppListing</code>s</h1>
<div>
<ul class="incremental">
<li><p><em>must</em> contain only private apps and must contain at least one of them</p></li>
<li><p><em>can</em> contain either PvA or non-PvA apps</p>
<ul class="incremental">
<li>if it contains PvA apps, it <em>can</em> have draft pricing for that type of app</li>
</ul></li>
<li><p>when an app listing contains Server or Data Center apps, it <em>must</em> contain compatibility history</p></li>
</ul>
</div>
</div>
<div id="public-applistings" class="slide section level1">
<h1>public <code>AppListing</code>s</h1>
<div>
<ul class="incremental">
<li><p><em>must</em> have a logo</p></li>
<li><p><em>must</em> have a tag line</p></li>
<li><p><em>must</em> have a summary</p></li>
<li><p><em>must</em> contain at least one public app of any type with any payment option</p></li>
<li><p><em>can</em> contain any number of private apps of any type with any payment model</p></li>
<li><p><em>can</em> contain draft pricing for an app type when it contains either a private or public version of that app type</p></li>
<li><p>when an app listing contains Server or Data Center apps, it <em>must</em> contain compatibility history</p></li>
<li><p>when an app listing contains a free version of a specific type</p>
<ul class="incremental">
<li><em>can</em> have PvA versions of that app type submitted for approval</li>
</ul></li>
<li><p>when an app listing contains a PvA version of a specific type</p>
<ul class="incremental">
<li><em>can</em> have any number of public apps of that type that are either non-PvA or PvA</li>
</ul></li>
</ul>
</div>
</div>
<div id="other-states-of-applisting" class="slide section level1">
<h1>other states of <code>AppListing</code></h1>
<div>
<ul class="incremental">
<li><p>Submitted - has all the same invariants as a public app listing</p></li>
<li><p>Ready to launch - has all the same invariants as a public app listing</p></li>
<li><p>Rejected - has all the same invariants as a submitted listing</p></li>
</ul>
</div>
</div>
<div id="representing-privateapplistings" class="slide section level1">
<h1>representing <code>PrivateAppListing</code>s</h1>
<div>
<ul class="incremental">
<li><p>optional values are represented as <code>Status.Private</code>, i.e. <code>Option</code></p></li>
<li><p>app versions are represented as</p></li>
</ul>
</div>
</div>
<div id="representing-privateapplisting-versions" class="slide section level1">
<h1>representing <code>PrivateAppListing</code> versions</h1>
<div>
<ul class="incremental">
<li><p>a collection of private cloud apps that are free</p>
<ul class="incremental">
<li><code>NonEmptyList[CloudApp[Private, CloudApp.Paid.Free]]</code></li>
</ul></li>
<li><p>or paid via atlassian</p>
<ul class="incremental">
<li><code>NonEmptyList[CloudApp[Private, CloudApp.Paid.PaidViaAtlassian]]</code></li>
</ul></li>
<li><p>together, that is</p>
<ul class="incremental">
<li><code>NonEmptyList[CloudApp[Private, CloudApp.Paid.Free]] \&amp;/ NonEmptyList[CloudApp[Private, CloudApp.Paid.PaidViaAtlassian]]</code></li>
</ul></li>
</ul>
</div>
</div>
<div id="representing-privateapplisting-versions-1" class="slide section level1">
<h1>representing <code>PrivateAppListing</code> versions</h1>
<div>
<ul class="incremental">
<li><p>a collection of private server and/or data center apps that are free, paid via vendor, or paid via atlassian</p>
<ul class="incremental">
<li><p><code>NonEmptyList[ServerApp[Private, ServerApp.Paid.Free \/ ServerApp.Paid.ViaVendor]] \&amp;/ NonEmptyList[ServerApp[Private, ServerApp.Paid.ViaAtlassian]]</code></p></li>
<li><p><code>NonEmptyList[DataCenterApp[Private, DataCenterApp.Paid.Free \/ DataCenterApp.Paid.ViaVendor]] \&amp;/ NonEmptyList[DataCenterApp[Private, DataCenterApp.Paid.ViaAtlassian]]</code></p></li>
</ul></li>
<li><p>with a compatibility history, <code>PluginCompatibilityHistory</code></p>
<ul class="incremental">
<li><code>( PluginCompatibilityHistory , NonEmptyList[ServerApp[Private, ServerApp.Paid.Free \/ ServerApp.Paid.ViaVendor]] \&amp;/ NonEmptyList[ServerApp[Private, ServerApp.Paid.ViaAtlassian]] \&amp;/   NonEmptyList[DataCenterApp[Private, DataCenterApp.Paid.Free \/ DataCenterApp.Paid.ViaVendor]] \&amp;/ NonEmptyList[DataCenterApp[Private, DataCenterApp.Paid.ViaAtlassian]] )</code></li>
</ul></li>
</ul>
</div>
</div>
<div id="representing-privateapplisting-versions-2" class="slide section level1">
<h1>representing <code>PrivateAppListing</code> versions</h1>
<div>
<ul class="incremental">
<li><p>instructional apps are easy <code>NonEmptyList[InstructionalApp[Private, InstructionalApp.Paid]]</code></p></li>
<li><p>so are workflow apps <code>NonEmptyList[WorkflowApp[Private, WorkflowApp.Paid]]</code></p></li>
<li><p>when we combine them together we get</p></li>
</ul>
</div>
</div>
<div id="representing-privateapplisting-versions-3" class="slide section level1">
<h1>representing <code>PrivateAppListing</code> versions</h1>
<pre><code>NonEmptyList[CloudApp[Private, CloudApp.Paid.Free]] \&amp;/ NonEmptyList[CloudApp[Private, CloudApp.Paid.PaidViaAtlassian]] \&amp;/
  ( PluginCompatibilityHistory
  , NonEmptyList[ServerApp[Private, ServerApp.Paid.Free \/ ServerApp.Paid.ViaVendor]] \&amp;/ NonEmptyList[ServerApp[Private, ServerApp.Paid.ViaAtlassian]] \&amp;/
    NonEmptyList[DataCenterApp[Private, DataCenterApp.Paid.Free \/ DataCenterApp.Paid.ViaVendor]] \&amp;/ NonEmptyList[DataCenterApp[Private, DataCenterApp.Paid.ViaAtlassian]]
  ) \&amp;/
  NonEmptyList[InstructionalApp[Private, InstructionalApp.Paid]] \&amp;/
  NonEmptyList[WorkflowApp[Private, WorkflowApp.Paid]]</code></pre>
</div>
<div id="representing-publicapplistings" class="slide section level1">
<h1>representing <code>PublicAppListing</code>s</h1>
<div>
<ul class="incremental">
<li><p>required values are represented as <code>Status.Public</code>, i.e. <code>Id[A]</code>, i.e. <code>A</code></p></li>
<li><p>each app type can be different states</p>
<ul class="incremental">
<li><p>zero or more private</p></li>
<li><p>has a submitted app that is not paid via Atlassian</p></li>
<li><p>has a submitted app that is paid via Atlassian</p></li>
<li><p>has approved apps that are not paid via Atlassian</p></li>
<li><p>has approved apps that are paid via Atlassian</p></li>
</ul></li>
</ul>
</div>
</div>
<div id="representing-publicapplisting-versions" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<div>
<p>private apps are easy, we just reuse types from <code>PrivateAppListing</code></p>
</div>
</div>
<div id="representing-publicapplisting-versions-1" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<div>
<ul class="incremental">
<li><p>submitted, non paid via Atlassian apps are a little more interesting</p></li>
<li><p>they can also have private apps</p></li>
<li><p>those private apps can be non paid via Atlassian or paid via Atlassian</p></li>
<li><p>when we have paid via Atlassian, it can have draft pricing</p></li>
</ul>
</div>
</div>
<div id="representing-publicapplisting-versions-2" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<pre><code>final case class SubmittedNonPvA[F[_[_], _], NonPvA, PvA]
  ( submittedNonPvA: F[Public, NonPvA]
  , privateNonPvA: List[F[Private, NonPvA]]
  , privatePvA: Option[(NonEmptyList[F[Private, PvA]], Option[DraftPricing])]
  ) extends SubmittedApps[F, NonPvA, PvA]</code></pre>
</div>
<div id="representing-publicapplisting-versions-3" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<div>
<ul class="incremental">
<li><p>submitted, paid via Atlassian apps</p>
<ul class="incremental">
<li><p>can have draft pricing</p></li>
<li><p>can also have private apps</p></li>
<li><p>those private apps can be non paid via Atlassian or paid via Atlassian</p></li>
</ul></li>
</ul>
</div>
</div>
<div id="representing-publicapplisting-versions-4" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<pre><code>final case class SubmittedPvA[F[_[_], _], NonPvA, PvA]
  ( submittedPvA: NonEmptyList[F[Public, PvA]]
  , privatePvA: List[F[Private, PvA]]
  , privateNonPvA: List[F[Private, NonPvA]]
  , draftPricing: Option[DraftPricing]
  ) extends SubmittedApps[F, NonPvA, PvA]</code></pre>
</div>
<div id="representing-publicapplisting-versions-5" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<p>introduce some type aliases to make talking about submitted apps easier</p>
<pre><code>type SubmittedCloud =
  SubmittedApps[CloudApp, CloudApp.Paid.Free, CloudApp.Paid.ViaAtlassian]

type SubmittedServer =
  SubmittedApps[ServerApp, ServerApp.Paid.Free \/ ServerApp.Paid.ViaVendor, ServerApp.Paid.ViaAtlassian]

type SubmittedDataCenter =
  SubmittedApps[DataCenterApp, DataCenterApp.Paid.Free \/ DataCenterApp.Paid.ViaVendor, DataCenterApp.Paid.ViaAtlassian]</code></pre>
</div>
<div id="representing-publicapplisting-versions-6" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<div>
<p>Approved apps have somewhat similar structure</p>
<ul class="incremental">
<li><p>we have one or more approved, non-PvA app versions</p></li>
<li><p>we have one or more approved, non-PvA app versions, and some that have been submitted for approval to be PvA</p></li>
<li><p>we have one or more approved PvA app versions</p></li>
</ul>
</div>
</div>
<div id="representing-publicapplisting-versions-7" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<p>we have one or more approved, non-PvA app versions</p>
<pre><code>final case class ApprovedNonPvA[F[_[_], _], NonPvA, PvA]
  ( approvedNonPvA: NonEmptyList[F[Public, NonPvA]]
  , privateNonPvA: List[F[Private, NonPvA]]
  , privatePvA: Option[(Option[DraftPricing], NonEmptyList[F[Private, PvA]])]
  ) extends ApprovedApps[F, NonPvA, PvA]</code></pre>
</div>
<div id="representing-publicapplisting-versions-8" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<p>we have one or more approved, non-PvA app versions, and some that have been submitted for approval to be PvA</p>
<pre><code>final case class ApprovedNonPvAWithSubmittedPvA[F[_[_], _], NonPvA, PvA]
  ( approvedNonPvA: Approved[F, NonPvA]
  , submittedPvA: Submitted[F, PvA]
  , privateNonPvA: List[F[Private, NonPvA]]
  , privatePvA: List[F[Private, PvA]]
  , draftPricing: Option[DraftPricing]
  ) extends ApprovedApps[F, NonPvA, PvA]</code></pre>
</div>
<div id="representing-publicapplisting-versions-9" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<p>we have one or more approved PvA app versions</p>
<pre><code>final case class ApprovedPvA[F[_[_], _], NonPvA, PvA]
  ( approvedPvA: Approved[F, PvA]
  , privatePvA: List[F[Private, PvA]]
  , approvedNonPvA: List[F[Public, NonPvA]]
  , privateNonPvA: List[F[Private, NonPvA]]
  , draftPricing: Option[DraftPricing]
  ) extends ApprovedApps[F, NonPvA, PvA]</code></pre>
</div>
<div id="representing-publicapplisting-versions-10" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<p>more type aliases for great good</p>
<pre><code>type ApprovedCloud =
  ApprovedApps[CloudApp, CloudApp.Paid.Free, CloudApp.Paid.ViaAtlassian]

type ApprovedServer =
  ApprovedApps[ServerApp, ServerApp.Paid.Free \/ ServerApp.Paid.ViaVendor, ServerApp.Paid.ViaAtlassian]

type ApprovedDataCenter =
  ApprovedApps[DataCenterApp, DataCenterApp.Paid.Free \/ DataCenterApp.Paid.ViaVendor, DataCenterApp.Paid</code></pre>
</div>
<div id="representing-publicapplisting-versions-11" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<p>time to combine them all together</p>
</div>
<div id="representing-publicapplisting-versions-12" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<div>
<pre><code>(SubmittedCloud \/ ApprovedCloud) \&amp;/
  (SubmittedServer \/ ApprovedServer) \&amp;/
  (SubmittedDataCenter \/ ApprovedDataCenter)</code></pre>
<ul class="incremental">
<li><p>not good enough</p></li>
<li><p>allows us to have no approved apps</p></li>
</ul>
</div>
</div>
<div id="introducing-theserights" class="slide section level1">
<h1>introducing <code>TheseRights</code></h1>
<pre><code>sealed trait TheseRights[A, B, C, D]
final case class ThisRight[A, B, C, D](b: B, c: Option[C]) extends TheseRights[A, B, C, D]
final case class ThatRight[A, B, C, D](a: Option[A], d: D) extends TheseRights[A, B, C, D]
final case class BothRight[A, B, C, D](b: B, d: D) extends TheseRights[A, B, C, D]</code></pre>
</div>
<div id="representing-publicapplisting-versions-13" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<ul>
<li><p>now we can combine submitted and approved apps</p></li>
<li><p>we can guarantee that at least one is non-empty</p></li>
</ul>
</div>
<div id="representing-publicapplisting-versions-14" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<p>combine server and datacenter</p>
<pre><code>type ServerDataCenter =
  ( PluginCompatibilityHistory,

    TheseRights[
      SubmittedServer,
      ApprovedServer,
      SubmittedDataCenter,
      ApprovedDataCenter
    ]
  )</code></pre>
</div>
<div id="representing-publicapplisting-versions-15" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<p>combine those with cloud</p>
<pre><code>type CloudServerDataCenter =
  TheseRights[
    SubmittedCloud \/ PrivateCloud,
    ApprovedCloud,
    PrivateServerDataCenter,
    ServerDataCenter
  ]</code></pre>
</div>
<div id="representing-publicapplisting-versions-16" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<p>throw in some instructional and workflow goodness</p>
<pre><code>type PrivateInstructionalWorkflow =
  NonEmptyList[
    InstructionalApp[Private, InstructionalApp.Paid]] \&amp;/
    NonEmptyList[WorkflowApp[Private, WorkflowApp.Paid]
  ]

type PublicInstructionalWorkflow =
  ( NonEmptyList[InstructionalApp[Public, InstructionalApp.Paid]] \&amp;/ NonEmptyList[WorkflowApp[Public, WorkflowApp.Paid]]
  , privateInstructional: List[InstructionalApp[Private, InstructionalApp.Paid]]
  , privateWorkflow: List[WorkflowApp[Private, WorkflowApp.Paid]]
  )</code></pre>
</div>
<div id="representing-publicapplisting-versions-17" class="slide section level1">
<h1>representing <code>PublicAppListing</code> versions</h1>
<p>put it all together</p>
<pre><code>type Versions =
  TheseRights[
    PrivateInstructionalWorkflow,
    PublicInstructionalWorkflow,
    PrivateServerDataCenter \&amp;/ PrivateCloud,
    CloudServerDataCenter
  ]</code></pre>
</div>
<div id="representing-publicapplistings-1" class="slide section level1">
<h1>representing <code>PublicAppListing</code>s</h1>
<pre><code>type AppListing =
  PrivateAppListing \/
  SubmittedAppListing \/
  ReadyToLaunchAppListing \/
  PublicAppListing \/
  RejectedAppListing</code></pre>
</div>
</body>
</html>
